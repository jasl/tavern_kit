<%# Lorebook Card (shared for public + settings list views) %>
<%# locals: (lorebook:, mode: :public) %>
<% presenter = LorebookCardPresenter.new(lorebook: lorebook, mode: (local_assigns[:mode] || :public)) %>

<div id="<%= dom_id(lorebook) %>" class="card bg-base-100 shadow-sm border border-base-300" data-status="<%= lorebook.status %>">
  <%# Status overlay for non-ready states %>
  <% if presenter.pending? %>
    <div class="absolute inset-0 bg-base-100/90 backdrop-blur-sm z-10 flex flex-col items-center justify-center rounded-box">
      <span class="loading loading-spinner loading-lg text-primary"></span>
      <p class="text-sm text-base-content/70 mt-2"><%= t("common.importing", default: "Importing...") %></p>
    </div>
  <% elsif presenter.failed? %>
    <div class="absolute inset-0 bg-error/10 backdrop-blur-sm z-10 flex flex-col items-center justify-center rounded-box px-4 text-center">
      <span class="icon-[lucide--alert-circle] size-12 text-error"></span>
      <p class="text-sm text-error mt-2"><%= t("common.import_failed", default: "Import failed") %></p>
      <% if lorebook.import_error.present? %>
        <p class="text-xs text-error/70 mt-1 max-w-md"><%= lorebook.import_error.truncate(160) %></p>
      <% end %>
      <% if presenter.can_delete? %>
        <div class="mt-3">
          <%= button_to presenter.delete_path,
                method: :delete,
                form: { data: { turbo_confirm: t("lorebooks.delete_confirm", default: "Are you sure you want to delete this lorebook?") } },
                class: "btn btn-sm btn-error btn-outline gap-2" do %>
            <span class="icon-[lucide--trash-2] size-4"></span>
            <%= t("common.delete", default: "Delete") %>
          <% end %>
        </div>
      <% end %>
    </div>
  <% end %>

  <div class="card-body p-4">
    <div class="flex items-start justify-between gap-2">
      <div class="min-w-0">
        <h3 class="card-title text-lg flex items-center gap-2 flex-wrap">
          <%= link_to lorebook.name, presenter.title_path, class: "hover:text-primary transition-colors truncate" %>

          <% if presenter.duplicate_name? %>
            <span class="badge badge-sm badge-warning" title="<%= t("lorebooks.duplicate_name_hint", default: "Duplicate name. Consider renaming to avoid confusion.") %>">
              <span class="icon-[lucide--alert-triangle] size-3"></span>
            </span>
          <% end %>

          <% if presenter.global? %>
            <span class="badge badge-sm badge-outline gap-1" title="<%= t("common.global", default: "Global") %>">
              <span class="icon-[lucide--globe] size-3"></span>
            </span>
          <% end %>

          <% if presenter.locked? %>
            <span class="badge badge-sm badge-warning gap-1" title="<%= t("common.locked", default: "Locked") %>">
              <span class="icon-[lucide--lock] size-3"></span>
            </span>
          <% end %>

          <% if presenter.draft? %>
            <span class="badge badge-sm badge-ghost gap-1" title="<%= t("common.draft", default: "Draft (private)") %>">
              <span class="icon-[lucide--eye-off] size-3"></span>
            </span>
          <% end %>

          <% if presenter.recursive? %>
            <span class="badge badge-outline badge-sm gap-1">
              <span class="icon-[lucide--repeat] size-3"></span>
              Recursive
            </span>
          <% end %>
        </h3>
      </div>

      <div class="flex items-center gap-2 shrink-0">
        <%= link_to presenter.primary_action_path, class: "btn btn-sm btn-ghost gap-1" do %>
          <span class="icon-[lucide--pencil] size-4 <%= presenter.can_edit? ? '' : 'hidden' %>"></span>
          <span class="icon-[lucide--eye] size-4 <%= presenter.can_edit? ? 'hidden' : '' %>"></span>
          <%= presenter.primary_action_label %>
        <% end %>
      </div>
    </div>

    <% if lorebook.description.present? %>
      <p class="text-sm text-base-content/60 mt-2 line-clamp-2"><%= lorebook.description %></p>
    <% end %>

    <div class="flex items-center gap-1 mt-2 text-sm text-base-content/50">
      <span class="icon-[lucide--user] size-3"></span>
      <% if lorebook.user.present? %>
        <span><%= lorebook.user.name.to_s.truncate(20) %></span>
      <% else %>
        <span class="badge badge-xs badge-ghost"><%= t("common.system", default: "System") %></span>
      <% end %>
    </div>

    <div class="mt-3 grid grid-cols-1 md:grid-cols-4 gap-4 text-sm">
      <div>
        <span class="text-base-content/60"><%= t("lorebooks.entries", default: "Entries") %>:</span>
        <span class="ml-2 font-medium"><%= presenter.entries_count %></span>
      </div>
      <div>
        <span class="text-base-content/60"><%= t("lorebooks.characters_using", default: "Characters") %>:</span>
        <span class="ml-2 font-medium"><%= presenter.character_usage_count %></span>
      </div>
      <div>
        <span class="text-base-content/60"><%= t("lorebooks.scan_depth", default: "Scan Depth") %>:</span>
        <span class="ml-2 font-mono"><%= lorebook.scan_depth.presence || t("lorebooks.default", default: "Default") %></span>
      </div>
      <div>
        <span class="text-base-content/60"><%= t("lorebooks.token_budget", default: "Token Budget") %>:</span>
        <span class="ml-2 font-mono"><%= lorebook.token_budget.present? ? number_with_delimiter(lorebook.token_budget) : t("lorebooks.unlimited", default: "Unlimited") %></span>
      </div>
    </div>

    <div class="mt-3 pt-3 border-t border-base-200 flex items-center justify-between">
      <div class="flex flex-wrap gap-2">
        <%= link_to presenter.export_path, class: "btn btn-sm btn-outline gap-1" do %>
          <span class="icon-[lucide--download] size-4"></span>
          <%= t("lorebooks.export", default: "Export") %>
        <% end %>

        <%= button_to presenter.duplicate_path,
              method: :post,
              form: { data: { turbo_confirm: t("lorebooks.duplicate_confirm", default: "Create a copy of this lorebook?") } },
              class: "btn btn-sm btn-ghost gap-1" do %>
          <span class="icon-[lucide--copy] size-4"></span>
          <%= t("common.duplicate", default: "Duplicate") %>
        <% end %>

        <% if presenter.can_toggle_lock? %>
          <%= button_to presenter.lock_toggle_path, method: :post, class: "btn btn-sm btn-ghost gap-1" do %>
            <span class="icon-[lucide--unlock] size-4 <%= presenter.locked? ? '' : 'hidden' %>"></span>
            <span class="icon-[lucide--lock] size-4 <%= presenter.locked? ? 'hidden' : '' %>"></span>
            <%= presenter.lock_toggle_label %>
          <% end %>
        <% end %>

        <% if presenter.can_toggle_publish? %>
          <%= button_to presenter.publish_toggle_path, method: :post, class: "btn btn-sm btn-ghost gap-1" do %>
            <span class="icon-[lucide--eye] size-4 <%= presenter.draft? ? '' : 'hidden' %>"></span>
            <span class="icon-[lucide--eye-off] size-4 <%= presenter.draft? ? 'hidden' : '' %>"></span>
            <%= presenter.publish_toggle_label %>
          <% end %>
        <% end %>
      </div>

      <% if presenter.can_delete? %>
        <%= button_to presenter.delete_path,
              method: :delete,
              form: { data: { turbo_confirm: t("lorebooks.delete_confirm", default: "Are you sure you want to delete this lorebook?") } },
              class: "btn btn-sm btn-ghost text-error gap-2" do %>
          <span class="icon-[lucide--trash-2] size-4"></span>
          <%= t("common.delete", default: "Delete") %>
        <% end %>
      <% else %>
        <% if presenter.settings_mode? && presenter.locked? %>
          <button type="button" class="btn btn-sm btn-ghost text-base-content/30 gap-2" disabled title="<%= t("lorebooks.locked", default: "Lorebook is locked.") %>">
            <span class="icon-[lucide--trash-2] size-4"></span>
            <%= t("common.delete", default: "Delete") %>
          </button>
        <% end %>
      <% end %>
    </div>
  </div>
</div>
