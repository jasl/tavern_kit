<%# Branch switcher dropdown in chat header %>
<%# locals: (conversation:, tree_conversations:) %>
<%
  # Handle nil tree_conversations gracefully
  tree_conversations ||= []

  # Build tree structure: group children by parent
  root_conversation = tree_conversations.find(&:root?)
  children_by_parent = tree_conversations.reject(&:root?).group_by(&:parent_conversation_id)

  # Check if there are any branches
  has_branches = tree_conversations.size > 1
%>

<div class="flex items-center gap-1 ml-2 lg:ml-0">
  <%# Conversation Title with Edit Button %>
  <span class="font-semibold truncate max-w-48"><%= conversation_display_label(conversation) %></span>

  <%# Edit Title Button - opens modal %>
  <button type="button"
          class="btn btn-ghost btn-xs btn-square"
          onclick="document.getElementById('conversation_title_modal').showModal()"
          title="<%= t('conversations.edit_title', default: 'Edit Title') %>">
    <span class="icon-[lucide--pencil] size-3.5 text-base-content/50"></span>
  </button>

  <%# Branch Switcher Dropdown %>
  <div class="dropdown">
    <div tabindex="0" role="button" class="btn btn-ghost btn-xs gap-0.5" title="<%= t('conversations.switch_branch', default: 'Switch Branch') %>">
      <span class="icon-[lucide--git-branch] size-3.5 text-base-content/50"></span>
      <span class="icon-[lucide--chevron-down] size-3 text-base-content/50"></span>
    </div>
    <ul tabindex="0" class="dropdown-content menu menu-sm bg-base-200 rounded-box z-50 w-72 p-2 shadow-lg border border-base-300 max-h-96 overflow-y-auto mt-1">
      <% if has_branches %>
        <%# Header %>
        <li class="menu-title flex flex-row items-center justify-between">
          <span><%= t("conversations.branches", default: "Branches") %></span>
          <span class="badge badge-xs badge-ghost"><%= tree_conversations.size %></span>
        </li>

        <%# Tree structure starting from root %>
        <% if root_conversation %>
          <%= render "conversations/branch_dropdown_tree_item",
                     conv: root_conversation,
                     current_conversation: conversation,
                     children_by_parent: children_by_parent %>
        <% end %>
      <% else %>
        <%# No branches - just show current conversation info %>
        <li class="menu-title">
          <span class="flex items-center gap-1 text-xs">
            <span class="icon-[lucide--info] size-3"></span>
            <%= t("conversations.no_branches_hint", default: "No branches yet") %>
          </span>
        </li>
        <li>
          <span class="active">
            <span class="<%= conversation_kind_icon(conversation) %> size-4 shrink-0"></span>
            <span class="flex flex-col flex-1 min-w-0">
              <span class="truncate"><%= conversation.title %></span>
              <span class="text-xs opacity-70">
                <%= conversation.messages.count %> <%= t("messages.count", default: "msgs") %> Â· <%= t("common.current", default: "Current") %>
              </span>
            </span>
          </span>
        </li>
        <li class="disabled">
          <span class="text-xs text-base-content/40">
            <%= t("conversations.branches_hint_short", default: "Use 'Branch' on a message to create alternate timelines") %>
          </span>
        </li>
      <% end %>
    </ul>
  </div>
</div>

<%# Modal for editing conversation title %>
<dialog id="conversation_title_modal" class="modal">
  <div class="modal-box max-w-sm">
    <h3 class="font-bold text-lg flex items-center gap-2 mb-4">
      <span class="icon-[lucide--pencil] size-5"></span>
      <%= t("conversations.edit_title", default: "Edit Title") %>
    </h3>

    <%= form_with url: conversation_path(conversation), method: :patch, scope: :conversation, data: { turbo: false } do |f| %>
      <div class="form-control">
        <label class="label">
          <span class="label-text"><%= t("conversations.title", default: "Title") %></span>
        </label>
        <%= f.text_field :title,
                         value: conversation.title,
                         class: "input input-bordered w-full",
                         maxlength: 100,
                         autofocus: true,
                         placeholder: t("conversations.title_placeholder", default: "Enter conversation title...") %>
      </div>

      <div class="modal-action">
        <button type="button" class="btn" onclick="this.closest('dialog').close()">
          <%= t("common.cancel", default: "Cancel") %>
        </button>
        <%= f.submit t("common.save", default: "Save"), class: "btn btn-primary" %>
      </div>
    <% end %>
  </div>
  <form method="dialog" class="modal-backdrop">
    <button>close</button>
  </form>
</dialog>
