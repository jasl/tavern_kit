<%# Left sidebar: Space switcher, Members, Stats, Lorebooks, Runs %>
<%# locals: (conversation:, space:) %>
<%
  user_spaces = Current.user.spaces.active.includes(:space_memberships).ordered.limit(20)
%>

<%= turbo_frame_tag dom_id(conversation, :left_sidebar), class: "h-full flex flex-col" do %>
<div class="h-full flex flex-col" data-controller="tabs" data-tabs-default-value="members" data-tabs-persist-value="true" data-tabs-persist-key-value="left-sidebar-tab">

  <%# Header with Space Name, Edit Button, and Switcher - h-14 to match navbar %>
  <div class="h-14 px-3 border-b border-base-300 bg-base-100 flex items-center gap-1">
    <%# Space Name %>
    <span class="font-medium truncate flex-1 min-w-0"><%= space.name %></span>

    <%# Edit Space Name Button - opens modal %>
    <button type="button"
            class="btn btn-ghost btn-xs btn-square"
            data-controller="dialog"
            data-dialog-id-value="space_name_modal"
            data-action="click->dialog#open"
            title="<%= t('playgrounds.edit_name', default: 'Edit Name') %>">
      <span class="icon-[lucide--pencil] size-3.5 text-base-content/50"></span>
    </button>

    <%# Space Switcher Dropdown %>
    <div class="dropdown dropdown-end">
      <div tabindex="0" role="button" class="btn btn-ghost btn-xs btn-square" title="<%= t('playgrounds.switch', default: 'Switch Playground') %>">
        <span class="icon-[lucide--chevrons-up-down] size-4 text-base-content/50"></span>
      </div>
      <ul tabindex="0" class="dropdown-content menu bg-base-100/95 backdrop-blur-sm rounded-box z-[100] w-56 max-h-64 overflow-y-auto shadow-lg border border-base-300">
        <% user_spaces.each do |s| %>
          <%# Count active memberships using preloaded data instead of SQL COUNT %>
          <% active_members_count = s.space_memberships.select(&:active_membership?).size %>
          <li>
            <% default_conv = s.conversations.root.first %>
            <% if default_conv %>
              <%= link_to conversation_path(default_conv), class: "#{s.id == space.id ? 'active' : ''}", data: { turbo_frame: "_top" } do %>
                <span class="truncate flex-1"><%= s.name %></span>
                <% if active_members_count > 2 %>
                  <span class="badge badge-xs badge-ghost"><%= active_members_count %></span>
                <% end %>
              <% end %>
            <% else %>
              <%= link_to playground_path(s), class: "#{s.id == space.id ? 'active' : ''}", data: { turbo_frame: "_top" } do %>
                <span class="truncate flex-1"><%= s.name %></span>
              <% end %>
            <% end %>
          </li>
        <% end %>
        <li class="border-t border-base-300 mt-1 pt-1">
          <%= link_to conversations_path, class: "text-primary", data: { turbo_frame: "_top" } do %>
            <%= t("conversations.view_all", default: "View All Conversations") %>
          <% end %>
        </li>
      </ul>
    </div>
  </div>

  <%# Modal for editing space name %>
  <dialog id="space_name_modal" class="modal">
    <div class="modal-box max-w-sm">
      <h3 class="font-bold text-lg flex items-center gap-2 mb-4">
        <span class="icon-[lucide--pencil] size-5"></span>
        <%= t("playgrounds.edit_name", default: "Edit Name") %>
      </h3>

      <%= form_with url: playground_path(space), method: :patch, scope: :playground, data: { turbo: false } do |f| %>
        <div class="form-control">
          <label class="label">
            <span class="label-text"><%= t("playgrounds.name", default: "Name") %></span>
          </label>
          <%= f.text_field :name,
                           value: space.name,
                           class: "input input-bordered w-full",
                           maxlength: 100,
                           autofocus: true,
                           placeholder: t("playgrounds.name_placeholder", default: "Enter playground name...") %>
        </div>

        <div class="modal-action">
          <button type="button" class="btn" data-controller="dialog" data-action="click->dialog#close">
            <%= t("common.cancel", default: "Cancel") %>
          </button>
          <%= f.submit t("common.save", default: "Save"), class: "btn btn-primary" %>
        </div>
      <% end %>
    </div>
    <form method="dialog" class="modal-backdrop">
      <button>close</button>
    </form>
  </dialog>

  <%# Tabs - larger icons for better touch targets %>
  <div role="tablist" class="tabs tabs-box bg-base-200 rounded-none border-b border-base-300 text-xs">
    <button role="tab" class="tab tab-active flex-1 min-h-10" data-tabs-target="tab" data-tab="members" data-action="click->tabs#select">
      <span class="icon-[lucide--users] size-4"></span>
    </button>
    <button role="tab" class="tab flex-1 min-h-10" data-tabs-target="tab" data-tab="stats" data-action="click->tabs#select">
      <span class="icon-[lucide--bar-chart-3] size-4"></span>
    </button>
    <button role="tab" class="tab flex-1 min-h-10" data-tabs-target="tab" data-tab="lorebooks" data-action="click->tabs#select">
      <span class="icon-[lucide--book-open] size-4"></span>
    </button>
    <button role="tab" class="tab flex-1 min-h-10" data-tabs-target="tab" data-tab="runs" data-action="click->tabs#select">
      <span class="icon-[lucide--activity] size-4"></span>
    </button>
  </div>

  <%# Tab Content %>
  <div class="flex-1 overflow-y-auto scrollbar-auto-hide">

    <%# Members Panel %>
    <div data-tabs-target="panel" data-tab="members" class="p-3 space-y-3">
      <div class="flex items-center justify-between">
        <h3 class="text-xs font-semibold uppercase text-base-content/50">
          <%= t("spaces.members", default: "Members") %>
        </h3>
        <span class="badge badge-xs badge-ghost"><%= space.space_memberships.active.count %></span>
      </div>

      <div class="space-y-2">
        <% space.space_memberships.active.by_position.includes(:user, :character).each do |membership| %>
          <%= render "conversations/left_sidebar_member", membership: membership, space: space, conversation: conversation %>
        <% end %>
      </div>

      <%# Add Member Button %>
      <%= link_to new_playground_membership_path(space),
                  class: "btn btn-ghost btn-sm w-full gap-2 border border-dashed border-base-300",
                  data: { turbo_frame: "_top" } do %>
        <span class="icon-[lucide--user-plus] size-4"></span>
        <%= t("spaces.add_member", default: "Add Member") %>
      <% end %>
    </div>

    <%# Stats Panel %>
    <div data-tabs-target="panel" data-tab="stats" class="hidden p-3 space-y-4">
      <div class="flex items-center justify-between">
        <h3 class="text-xs font-semibold uppercase text-base-content/50">
          <%= t("spaces.stats", default: "Statistics") %>
        </h3>
        <%= link_to conversation_path(conversation),
                    data: { turbo_frame: dom_id(conversation, :left_sidebar) },
                    class: "btn btn-ghost btn-xs btn-circle",
                    title: t("common.refresh", default: "Refresh") do %>
          <span class="icon-[lucide--refresh-cw] size-3"></span>
        <% end %>
      </div>

      <div class="stats stats-vertical bg-base-200 w-full shadow-sm">
        <div class="stat py-3">
          <div class="stat-title text-xs">Messages</div>
          <div class="stat-value text-lg"><%= conversation.messages.count %></div>
        </div>
        <div class="stat py-3">
          <div class="stat-title text-xs">Created</div>
          <div class="stat-value text-lg"><%= time_ago_in_words(conversation.created_at) %></div>
        </div>
        <div class="stat py-3">
          <div class="stat-title text-xs">Members</div>
          <div class="stat-value text-lg"><%= space.space_memberships.active.count %></div>
        </div>
      </div>

      <%# Author's Note %>
      <div class="space-y-2">
        <h4 class="text-xs font-medium text-base-content/60 flex items-center gap-1">
          <span class="icon-[lucide--pen-line] size-3"></span>
          <%= t("conversations.authors_note", default: "Author's Note") %>
          <% if conversation.authors_note.present? %>
            <span class="badge badge-xs badge-primary"><%= t("common.active", default: "Active") %></span>
          <% end %>
        </h4>
        <div class="bg-base-200 rounded-box p-3">
          <% if conversation.authors_note.present? %>
            <p class="text-xs text-base-content/70 line-clamp-3 mb-2">
              <%= truncate(conversation.authors_note, length: 120) %>
            </p>
          <% else %>
            <p class="text-xs text-base-content/40 italic mb-2">
              <%= t("conversations.no_authors_note", default: "No conversation-specific note set") %>
            </p>
          <% end %>
          <button type="button"
                  class="btn btn-ghost btn-xs gap-1"
                  data-controller="dialog"
                  data-dialog-id-value="authors_note_modal"
                  data-action="click->dialog#open">
            <span class="icon-[lucide--edit-2] size-3"></span>
            <%= conversation.authors_note.present? ?
                  t("common.edit", default: "Edit") :
                  t("common.add", default: "Add") %>
          </button>
        </div>
      </div>

      <%# Token Usage %>
      <% token_stats = conversation_token_stats(conversation) %>
      <div class="space-y-2">
        <h4 class="text-xs font-medium text-base-content/60">
          <%= t("spaces.token_usage", default: "Token Usage (recent)") %>
        </h4>
        <div class="bg-base-200 rounded-box p-3 space-y-2">
          <div class="flex justify-between text-xs">
            <span><%= t("spaces.token_prompt", default: "Prompt") %></span>
            <span class="font-mono">
              <%= token_stats[:prompt_tokens].positive? ? number_with_delimiter(token_stats[:prompt_tokens]) : "—" %>
            </span>
          </div>
          <div class="flex justify-between text-xs">
            <span><%= t("spaces.token_completion", default: "Completion") %></span>
            <span class="font-mono">
              <%= token_stats[:completion_tokens].positive? ? number_with_delimiter(token_stats[:completion_tokens]) : "—" %>
            </span>
          </div>
          <div class="divider my-1"></div>
          <div class="flex justify-between text-xs font-medium">
            <span><%= t("spaces.token_total", default: "Total") %></span>
            <span class="font-mono">
              <%= token_stats[:total_tokens].positive? ? number_with_delimiter(token_stats[:total_tokens]) : "—" %>
            </span>
          </div>
        </div>
      </div>

      <%# Export Conversation %>
      <div class="space-y-2">
        <h4 class="text-xs font-medium text-base-content/60 flex items-center gap-1">
          <span class="icon-[lucide--download] size-3"></span>
          <%= t("conversations.export", default: "Export Conversation") %>
        </h4>
        <div class="flex gap-2">
          <%= link_to export_conversation_path(conversation, format: :jsonl),
                      class: "btn btn-ghost btn-sm flex-1 gap-1",
                      download: true do %>
            <span class="icon-[lucide--file-json] size-4"></span>
            JSONL
          <% end %>
          <%= link_to export_conversation_path(conversation, format: :txt),
                      class: "btn btn-ghost btn-sm flex-1 gap-1",
                      download: true do %>
            <span class="icon-[lucide--file-text] size-4"></span>
            TXT
          <% end %>
        </div>
      </div>
    </div>

    <%# Lorebooks Panel %>
    <div data-tabs-target="panel" data-tab="lorebooks" class="hidden p-3 space-y-4">
      <%# Space Lorebooks Section (Global) %>
      <%= turbo_frame_tag "space_lorebooks", src: playground_lorebooks_path(space), loading: :lazy do %>
        <div class="flex justify-center py-4">
          <span class="loading loading-spinner loading-sm"></span>
        </div>
      <% end %>

      <div class="divider my-2"></div>

      <%# Conversation Lorebooks Section (Chat Lore) %>
      <%= turbo_frame_tag "conversation_lorebooks", src: conversation_lorebooks_path(conversation), loading: :lazy do %>
        <div class="flex justify-center py-4">
          <span class="loading loading-spinner loading-sm"></span>
        </div>
      <% end %>

      <%# Link to Manage Lorebooks %>
      <div class="text-center pt-3 mt-3 border-t border-base-300">
        <%= link_to lorebooks_path, class: "link link-hover text-xs text-base-content/50", data: { turbo_frame: "_top" } do %>
          <%= t("space_lorebooks.manage_all", default: "Manage All Lorebooks") %>
          <span class="icon-[lucide--external-link] size-3 inline-block ml-1"></span>
        <% end %>
      </div>
    </div>

    <%# Runs Panel %>
    <div data-tabs-target="panel" data-tab="runs" class="hidden p-3 flex flex-col h-full">
      <%= render "conversations/runs_panel", conversation: conversation %>
    </div>
  </div>

  <%# Footer %>
  <div class="p-3 border-t border-base-300 bg-base-100">
    <%= link_to edit_playground_path(space),
                class: "btn btn-ghost btn-sm w-full gap-2",
                data: { turbo_frame: "_top" } do %>
      <span class="icon-[lucide--settings] size-4"></span>
      <%= t("playgrounds.playground_settings", default: "Playground Settings") %>
    <% end %>
  </div>
</div>
<% end %>
