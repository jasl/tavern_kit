<%# Right sidebar: schema-driven Membership LLM settings with Preset selector %>
<%# locals: (conversation:, space:, membership: nil) %>

<%= turbo_frame_tag dom_id(conversation, :right_sidebar), class: "h-full flex flex-col" do %>
  <%
    can_administer_space = Current.user && (space.owner_id == Current.user.id || Current.user.administrator?)

    requested_membership = if can_administer_space && params[:target_membership_id].present?
      space.space_memberships.active.includes(:user, :character).find_by(id: params[:target_membership_id])
    end

    membership ||= requested_membership

    membership ||= if can_administer_space
      space.space_memberships.active.kind_character.includes(:character).by_position.first ||
        (Current.user && space.space_memberships.active.find_by(user: Current.user, kind: "human"))
    else
      Current.user && space.space_memberships.active.find_by(user: Current.user, kind: "human")
    end
  %>

  <% if membership.nil? %>
    <div class="h-full flex flex-col items-center justify-center p-6 text-center">
      <span class="icon-[lucide--user-x] size-12 text-base-content/30 mb-4"></span>
      <h3 class="font-medium text-base-content/70 mb-2">
        <%= t("settings.not_member_title", default: "Not a Member") %>
      </h3>
      <p class="text-sm text-base-content/50">
        <%= t("settings.not_member_desc", default: "You must be a member of this space to access LLM settings.") %>
      </p>
    </div>
  <% elsif space.archived? %>
    <div class="h-full flex flex-col items-center justify-center p-6 text-center">
      <span class="icon-[lucide--archive] size-12 text-base-content/30 mb-4"></span>
      <h3 class="font-medium text-base-content/70 mb-2">
        <%= t("spaces.archived_title", default: "Archived") %>
      </h3>
      <p class="text-sm text-base-content/50">
        <%= t("spaces.archived_read_only", default: "This chat is archived and read-only.") %>
      </p>
    </div>
  <% elsif space.deleting? %>
    <div class="h-full flex flex-col items-center justify-center p-6 text-center">
      <span class="icon-[lucide--trash-2] size-12 text-base-content/30 mb-4"></span>
      <h3 class="font-medium text-base-content/70 mb-2">
        <%= t("spaces.deleting_title", default: "Deleting") %>
      </h3>
      <p class="text-sm text-base-content/50">
        <%= t("spaces.deleting_read_only", default: "This chat is being deleted and is temporarily unavailable.") %>
      </p>
    </div>
  <% else %>
    <%
      current_provider = membership.effective_llm_provider
      provider_identification = membership.provider_identification

      target_memberships = if can_administer_space
        space.space_memberships.active.includes(:user, :character).by_position
      else
        [membership]
      end

      # Presets for selection
      available_presets = Preset.for_select(user: Current.user)
      current_preset = membership.preset || Preset.get_default

      schema = SettingsSchemaPack.bundle
      fields = ConversationSettings::FieldEnumerator.new(schema: schema).participant_llm_fields(settings: membership.settings)
    %>

    <div class="h-full flex flex-col"
         data-controller="schema-renderer settings-form tabs preset-selector"
         data-action="tabs:changed->schema-renderer#tabChanged settings-form:spaceMembershipUpdated->schema-renderer#spaceMembershipUpdated"
         data-settings-form-url-value="<%= playground_space_membership_path(space, membership) %>"
         data-settings-form-schema-version-value="membership_llm_v1"
         data-settings-form-settings-version-value="<%= membership.settings_version %>"
         data-settings-form-resource-key-value="space_membership"
         data-settings-form-debounce-value="300"
         data-schema-renderer-schema-url-value="<%= schemas_settings_path %>"
         data-schema-renderer-context-value="<%= { provider_identification: provider_identification }.to_json %>"
         data-preset-selector-apply-url-value="<%= apply_preset_path %>"
         data-preset-selector-membership-id-value="<%= membership.id %>"
         data-preset-selector-current-preset-id-value="<%= current_preset&.id %>"
         data-tabs-default-value="basic"
         data-tabs-persist-value="true"
         data-tabs-persist-key-value="right-sidebar-tab"
         id="llm-settings-panel">

      <%# Header: Character + Preset + Save (single row, compact) %>
      <div class="h-14 px-3 border-b border-base-300 bg-base-100 flex items-center gap-2">
        <%# Character selector dropdown %>
        <div class="dropdown flex-1 min-w-0">
          <div tabindex="0" role="button" class="btn btn-ghost btn-sm w-full justify-between gap-1">
            <span class="truncate"><%= membership.display_name %></span>
            <span class="icon-[lucide--chevron-down] size-4 text-base-content/50 shrink-0"></span>
          </div>
          <ul tabindex="0" class="dropdown-content menu bg-base-100/95 backdrop-blur-sm rounded-box z-[100] w-56 p-2 shadow-lg border border-base-300 max-h-64 overflow-y-auto">
            <% target_memberships.each do |m| %>
              <li>
                <%= link_to conversation_path(conversation, target_membership_id: m.id),
                            class: m.id == membership.id ? "active" : "",
                            data: { turbo_frame: dom_id(conversation, :right_sidebar) } do %>
                  <span class="truncate"><%= m.display_name %></span>
                <% end %>
              </li>
            <% end %>
          </ul>
        </div>

        <%# Preset selector dropdown %>
        <div class="dropdown dropdown-end flex-1 min-w-0" data-controller="dropdown-select" data-preset-selector-target="dropdown">
          <div tabindex="0" role="button" class="btn btn-ghost btn-sm w-full justify-between gap-1">
            <span class="truncate" data-dropdown-select-target="label"><%= current_preset&.name || "Select Preset" %><%= " (System)" if current_preset&.system_preset? %></span>
            <span class="icon-[lucide--chevron-down] size-4 text-base-content/50 shrink-0"></span>
          </div>
          <ul tabindex="0" class="dropdown-content menu bg-base-100/95 backdrop-blur-sm rounded-box z-[100] w-56 p-2 shadow-lg border border-base-300 max-h-64 overflow-y-auto">
            <% available_presets.each do |preset| %>
              <li>
                <a href="#"
                   class="<%= preset.id == current_preset&.id ? 'active' : '' %>"
                   data-action="click->dropdown-select#select click->preset-selector#applyPreset"
                   data-preset-id="<%= preset.id %>"
                   data-preset-name="<%= preset.name %><%= ' (System)' if preset.system_preset? %>">
                  <span class="truncate"><%= preset.name %><%= " (System)" if preset.system_preset? %></span>
                </a>
              </li>
            <% end %>
          </ul>
        </div>

        <%# Save button (no icon, compact) %>
        <button type="button"
                class="btn btn-sm btn-ghost shrink-0"
                data-action="click->preset-selector#openSaveModal">
          Save
        </button>
      </div>

      <%# Tabs: Basic, Prompts, Author's Note, More %>
      <div role="tablist" class="tabs tabs-box bg-base-200 rounded-none border-b border-base-300">
        <button role="tab" class="tab tab-active" data-tabs-target="tab" data-tab="basic" data-action="click->tabs#select">
          <span class="icon-[lucide--settings-2] size-4 mr-1"></span>
          <%= t("settings.basic", default: "Basic") %>
        </button>
        <button role="tab" class="tab" data-tabs-target="tab" data-tab="prompts" data-action="click->tabs#select">
          <span class="icon-[lucide--message-square-text] size-4 mr-1"></span>
          <%= t("settings.prompts", default: "Prompts") %>
        </button>
        <button role="tab" class="tab" data-tabs-target="tab" data-tab="authors_note" data-action="click->tabs#select">
          <span class="icon-[lucide--sticky-note] size-4 mr-1"></span>
          <%= t("settings.authors_note", default: "AN") %>
        </button>
        <button role="tab" class="tab" data-tabs-target="tab" data-tab="more" data-action="click->tabs#select">
          <span class="icon-[lucide--more-horizontal] size-4 mr-1"></span>
          <%= t("settings.more", default: "More") %>
        </button>
      </div>

      <%# Tab Content %>
      <div class="flex-1 overflow-hidden min-h-0 relative">
        <%# Basic Tab %>
        <div data-tabs-target="panel" data-tab="basic" class="p-4 space-y-4 absolute inset-0 overflow-y-auto scrollbar-auto-hide">
          <%# LLM Provider selector (first item in Basic tab) %>
          <div class="space-y-1">
            <label class="label py-0">
              <span class="label-text text-xs font-medium"><%= t("settings.llm_provider", default: "LLM Provider") %></span>
            </label>
            <div class="flex items-center gap-1">
              <select class="select select-bordered select-sm flex-1"
                      data-setting-key="llm_provider_id"
                      data-setting-type="integer"
                      data-setting-path="llm_provider_id">
                <option value="" <%= "selected" if membership.llm_provider_id.nil? %>>
                  — <%= t("settings.use_global_provider", default: "Use Global Provider") %> —
                </option>
                <% LLMProvider.all.each do |provider| %>
                  <option value="<%= provider.id %>"
                          <%= "selected" if membership.llm_provider_id == provider.id %>>
                    <%= provider.name %><%= " (#{provider.model})" if provider.model.present? %>
                  </option>
                <% end %>
              </select>
              <%= link_to conversation_path(conversation, target_membership_id: membership.id),
                          data: { turbo_frame: dom_id(conversation, :right_sidebar) },
                          class: "btn btn-ghost btn-sm btn-square shrink-0",
                          title: t("common.refresh", default: "Refresh") do %>
                <span class="icon-[lucide--refresh-cw] size-4"></span>
              <% end %>
            </div>
            <% unless current_provider %>
              <p class="text-xs text-warning flex items-center gap-1 mt-1">
                <span class="icon-[lucide--alert-triangle] size-3"></span>
                <%= t("settings.no_provider_warning", default: "No provider configured. Please select one to send messages.") %>
              </p>
            <% end %>
          </div>

          <%# Schema-driven fields for Basic tab %>
          <div data-schema-renderer-target="basic" class="space-y-4"></div>
        </div>

        <%# Prompts Tab %>
        <div data-tabs-target="panel" data-tab="prompts" class="hidden p-4 space-y-4 absolute inset-0 overflow-y-auto scrollbar-auto-hide">
          <div data-schema-renderer-target="prompts" class="space-y-4"></div>
        </div>

        <%# Author's Note Tab %>
        <div data-tabs-target="panel" data-tab="authors_note" class="hidden p-4 space-y-4 absolute inset-0 overflow-y-auto scrollbar-auto-hide">
          <div data-schema-renderer-target="authors_note" class="space-y-4"></div>
        </div>

        <%# More Tab %>
        <div data-tabs-target="panel" data-tab="more" class="hidden p-4 space-y-4 absolute inset-0 overflow-y-auto scrollbar-auto-hide">
          <div data-schema-renderer-target="more" class="space-y-4"></div>
        </div>

        <%# Field pool (server-rendered, schema-renderer moves fields into panels) %>
        <div data-schema-renderer-target="pool" class="hidden">
          <% fields.each do |field| %>
            <%
              control = field[:control].to_s
              partial = case control
              when "slider" then "settings/fields/range"
              when "number" then "settings/fields/number"
              when "toggle" then "settings/fields/toggle"
              when "select" then "settings/fields/select"
              when "text" then "settings/fields/text"
              when "textarea" then "settings/fields/textarea"
              when "tags" then "settings/fields/tags"
              else
                if field[:type] == "boolean"
                  "settings/fields/toggle"
                elsif field[:enum].present?
                  "settings/fields/select"
                elsif field[:type].in?(%w[number integer])
                  "settings/fields/number"
                else
                  "settings/fields/text"
                end
              end
            %>
            <%= render partial, field: field %>
          <% end %>
        </div>
      </div>

      <%# Footer with save status %>
      <div class="p-3 border-t border-base-300 bg-base-100 flex items-center justify-between text-xs">
        <div class="flex items-center gap-2 text-base-content/50">
          <span class="icon-[lucide--save] size-3"></span>
          <span><%= t("settings.auto_save", default: "Auto-save enabled") %></span>
        </div>
        <div class="flex items-center gap-2">
          <span class="badge badge-sm badge-ghost" data-settings-form-target="status"></span>
          <span class="text-base-content/40" data-settings-form-target="savedAt"></span>
        </div>
      </div>

      <%# Save Preset Modal %>
      <dialog id="save_preset_modal" class="modal" data-preset-selector-target="modal">
        <div class="modal-box">
          <h3 class="font-bold text-lg mb-4"><%= t("presets.save_preset", default: "Save Preset") %></h3>

          <div class="space-y-4">
            <%# Save mode selection %>
            <div class="form-control">
              <label class="label cursor-pointer justify-start gap-3">
                <input type="radio" name="save_mode" value="update" class="radio radio-sm"
                       data-preset-selector-target="modeUpdate"
                       data-action="change->preset-selector#toggleMode"
                       checked>
                <span class="label-text">
                  <%= t("presets.update_current", default: "Update") %>
                  "<span data-preset-selector-target="currentName"><%= current_preset&.name %></span>"
                </span>
              </label>
            </div>

            <div class="form-control">
              <label class="label cursor-pointer justify-start gap-3">
                <input type="radio" name="save_mode" value="create" class="radio radio-sm"
                       data-preset-selector-target="modeCreate"
                       data-action="change->preset-selector#toggleMode">
                <span class="label-text"><%= t("presets.create_new", default: "Create new preset") %></span>
              </label>
            </div>

            <%# New preset name (hidden by default) %>
            <div class="form-control hidden" data-preset-selector-target="nameField">
              <label class="label">
                <span class="label-text"><%= t("presets.preset_name", default: "Preset Name") %></span>
              </label>
              <input type="text"
                     class="input input-bordered w-full"
                     placeholder="<%= t('presets.new_preset_placeholder', default: 'My Custom Preset') %>"
                     data-preset-selector-target="nameInput">
            </div>
          </div>

          <div class="modal-action">
            <button type="button" class="btn btn-ghost" data-action="click->preset-selector#closeSaveModal">
              <%= t("common.cancel", default: "Cancel") %>
            </button>
            <button type="button" class="btn btn-primary" data-action="click->preset-selector#save">
              <%= t("common.save", default: "Save") %>
            </button>
          </div>
        </div>
        <form method="dialog" class="modal-backdrop">
          <button>close</button>
        </form>
      </dialog>
    </div>
  <% end %>
<% end %>
