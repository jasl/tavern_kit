<%# Branches panel: lists all conversations in the tree %>
<%# locals: (conversation:, space:) %>
<%
  # Get all conversations in the tree, grouped by fork point
  tree_conversations = conversation.tree_conversations
    .includes(:forked_from_message, :parent_conversation)
    .chronological

  # Separate root from branches/checkpoints
  root_conversation = tree_conversations.find(&:root?)
  child_conversations = tree_conversations.reject(&:root?)

  # Group by forked_from_message_id for organization
  grouped_by_fork = child_conversations.group_by(&:forked_from_message_id)
%>

<div class="flex items-center justify-between">
  <h3 class="text-xs font-semibold uppercase text-base-content/50">
    <%= t("conversations.branches", default: "Branches") %>
  </h3>
  <span class="badge badge-xs badge-ghost"><%= tree_conversations.size %></span>
</div>

<% if tree_conversations.size <= 1 %>
  <%# No branches yet %>
  <div class="text-center py-8 text-base-content/40">
    <span class="icon-[lucide--git-branch] size-12 mb-3 opacity-50"></span>
    <p class="text-sm"><%= t("conversations.no_branches", default: "No branches yet") %></p>
    <p class="text-xs mt-1">
      <%= t("conversations.branches_hint", default: "Use 'Branch' or 'Checkpoint' on a message to create alternate timelines") %>
    </p>
  </div>
<% else %>
  <div class="space-y-1">
    <%# Root conversation %>
    <% if root_conversation %>
      <%= render "conversations/branch_item",
                 conv: root_conversation,
                 current_conversation: conversation,
                 is_root: true %>
    <% end %>

    <%# Child conversations grouped by fork point %>
    <% grouped_by_fork.each do |fork_message_id, convs| %>
      <% fork_message = convs.first&.forked_from_message %>
      <% if fork_message %>
        <div class="pl-3 border-l-2 border-base-300 ml-2 mt-2 space-y-1">
          <div class="text-xs text-base-content/40 flex items-center gap-1 -ml-1 mb-1">
            <span class="icon-[lucide--corner-down-right] size-3"></span>
            <%= t("conversations.forked_from_msg", default: "From message #%{seq}") % { seq: fork_message.seq } %>
          </div>
          <% convs.each do |conv| %>
            <%= render "conversations/branch_item",
                       conv: conv,
                       current_conversation: conversation,
                       is_root: false %>
          <% end %>
        </div>
      <% else %>
        <%# No fork message (shouldn't happen but handle gracefully) %>
        <% convs.each do |conv| %>
          <%= render "conversations/branch_item",
                     conv: conv,
                     current_conversation: conversation,
                     is_root: false %>
        <% end %>
      <% end %>
    <% end %>
  </div>
<% end %>
