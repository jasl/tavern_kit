<%# Conversation Runs history panel %>
<%# locals: (conversation:, conversation_events: nil, events_scope: "scheduler") %>
<% space = conversation.space %>

<% events_scope ||= "scheduler" %>

<%= turbo_frame_tag dom_id(conversation, :runs_panel) do %>
<div class="flex flex-col h-full"
     data-controller="runs-panel-auto-refresh"
     data-runs-panel-auto-refresh-conversation-id-value="<%= conversation.id %>"
     data-runs-panel-auto-refresh-frame-id-value="<%= dom_id(conversation, :runs_panel) %>"
     data-runs-panel-auto-refresh-url-value="<%= runs_conversation_path(conversation, events_scope: events_scope) %>"
     data-runs-panel-auto-refresh-interval-value="5000">
  <%# Header with filter toggle and refresh button - stays fixed %>
  <div class="flex items-center justify-between mb-3 shrink-0">
    <div class="flex items-center gap-2">
      <h3 class="text-xs font-semibold uppercase text-base-content/50">
        <%= t("conversations.recent_runs", default: "Recent Runs") %>
      </h3>
      <span class="badge badge-xs badge-ghost">
        <%= conversation.conversation_runs.count %>
      </span>
    </div>
    <div class="flex items-center gap-1">
      <%# Auto-refresh toggle (default: off for debugging) %>
      <label class="swap swap-flip btn btn-ghost btn-xs btn-circle"
             title="<%= t('conversations.toggle_auto_refresh', default: 'Toggle auto-refresh (default: off)') %>">
        <input type="checkbox"
               data-runs-panel-auto-refresh-target="toggle"
               data-action="runs-panel-auto-refresh#toggle" />
        <span class="swap-on icon-[lucide--refresh-cw-off] size-3 text-warning"></span>
        <span class="swap-off icon-[lucide--refresh-cw] size-3"></span>
      </label>
      <%# Manual refresh button %>
      <%= button_to runs_conversation_path(conversation, events_scope: events_scope),
                method: :get,
                data: { turbo_frame: dom_id(conversation, :runs_panel) },
                class: "btn btn-ghost btn-xs btn-circle",
                title: t("common.refresh", default: "Refresh") do %>
        <span class="icon-[lucide--rotate-cw] size-3"></span>
      <% end %>
    </div>
  </div>

  <%# Scrollable runs list - includes active run for consistent alignment %>
  <div class="flex-1 min-h-0 overflow-y-auto scrollbar-none">
    <% recent_runs = conversation.conversation_runs.includes(:speaker_space_membership).order(created_at: :desc).limit(20) %>
    <% recent_translation_runs = conversation.translation_runs.order(created_at: :desc).limit(20) %>

    <%# Active run cancel action (if any) %>
    <% active_run = recent_runs.find(&:active?) %>
    <% if active_run %>
      <div class="mb-2 p-2 bg-info/10 border border-info/20 rounded-box">
        <div class="flex items-center justify-between gap-2">
          <div class="flex items-center gap-2 text-xs text-info min-w-0">
            <span class="loading loading-spinner loading-xs shrink-0"></span>
            <span class="truncate"><%= active_run.speaker_space_membership&.display_name || "AI" %></span>
            <span class="<%= run_type_icon_class(active_run) %> size-3 shrink-0" title="<%= active_run.type_label %>"></span>
          </div>
          <%= button_to cancel_stuck_run_conversation_path(conversation),
                        method: :post,
                        class: "btn btn-ghost btn-xs text-error shrink-0",
                        title: t("conversations.cancel_run", default: "Cancel this run"),
                        data: { turbo_frame: "_top" } do %>
            <span class="icon-[lucide--x] size-3"></span>
            <%= t("common.cancel", default: "Cancel") %>
          <% end %>
        </div>
      </div>
    <% end %>

    <% if recent_runs.empty? %>
      <div class="text-center py-8 text-base-content/40">
        <span class="icon-[lucide--activity] size-10 mb-2 opacity-50"></span>
        <p class="text-sm"><%= t("conversations.no_runs", default: "No runs yet") %></p>
        <p class="text-xs mt-1"><%= t("conversations.no_runs_hint", default: "Runs will appear here after AI responses") %></p>
      </div>
    <% else %>
      <div class="space-y-1" data-controller="runs-panel">
        <% recent_runs.each_with_index do |run, index| %>
          <button type="button"
                  class="w-full text-left bg-base-200 rounded-box p-2 hover:bg-base-300 transition-colors cursor-pointer <%= index == 0 && run.running? ? 'ring-2 ring-info/50' : '' %>"
                  data-action="runs-panel#showRunDetail"
                  data-run-data="<%= run_detail_data(run).to_json %>">
            <%# Compact single-line header: Type icon + Speaker + Status + Time %>
            <div class="flex items-center gap-2">
              <%# Type icon %>
              <span class="<%= run_type_icon_class(run) %> size-4 shrink-0 <%= run_type_color_class(run) %>" title="<%= run.type_label %>"></span>

              <%# Speaker name (truncated) %>
              <span class="font-medium text-xs text-base-content/80 truncate flex-1 min-w-0">
                <%= run.speaker_space_membership&.display_name || "[Unknown]" %>
              </span>

              <%# Status badge (compact) %>
              <span class="badge badge-xs <%= run_status_badge_class(run) %> shrink-0">
                <% if run.running? %>
                  <span class="loading loading-spinner loading-xs"></span>
                <% else %>
                  <%= run.status[0..2].upcase %>
                <% end %>
              </span>

              <%# Time (compact) %>
              <span class="text-xs text-base-content/40 shrink-0 tabular-nums" title="<%= run.created_at.to_fs(:long) %>">
                <%= distance_of_time_in_words_to_now(run.created_at, include_seconds: true).gsub(/about |less than /, "").gsub(/ minutes?/, "m").gsub(/ seconds?/, "s").gsub(/ hours?/, "h") %>
              </span>
            </div>

            <%# Optional second row: tokens, duration, errors %>
            <% usage = run.debug&.dig("usage") %>
            <% has_extra_info = usage.present? || (run.finished_at && run.started_at) || run.failed? || run.debug&.dig("lore_budget_exceeded") %>
            <% if has_extra_info %>
              <div class="flex items-center gap-2 mt-1 text-xs text-base-content/50 pl-6">
                <%# Token usage %>
                <% if usage.present? %>
                  <span class="flex items-center gap-0.5" title="<%= t('conversations.tokens', default: 'Tokens') %>">
                    <span class="icon-[lucide--coins] size-3"></span>
                    <%= number_with_delimiter((usage["prompt_tokens"] || 0) + (usage["completion_tokens"] || 0)) %>
                  </span>
                <% end %>

                <%# Duration %>
                <% if run.finished_at && run.started_at %>
                  <span class="flex items-center gap-0.5" title="<%= t('conversations.duration', default: 'Duration') %>">
                    <span class="icon-[lucide--timer] size-3"></span>
                    <%= ((run.finished_at - run.started_at) * 1000).round %>ms
                  </span>
                <% end %>

                <%# Error indicator %>
                <% if run.failed? %>
                  <span class="text-error flex items-center gap-0.5" title="<%= run.error&.dig('user_message') || run.error&.dig('code') %>">
                    <span class="icon-[lucide--alert-circle] size-3"></span>
                    <%= run.error&.dig("code") || "error" %>
                  </span>
                <% end %>

                <%# World Info overflow indicator %>
                <% if run.debug&.dig("lore_budget_exceeded") %>
                  <span class="text-warning flex items-center gap-0.5" title="<%= t('conversations.world_info_overflow', default: 'World Info budget exceeded') %>">
                    <span class="icon-[lucide--alert-triangle] size-3"></span>
                    WI
                  </span>
                <% end %>
              </div>
            <% end %>
          </button>
        <% end %>
      </div>
    <% end %>

    <div class="divider my-3"></div>

    <%# Translation runs (Translate both) %>
    <div class="flex items-center justify-between mb-2">
      <div class="flex items-center gap-2">
        <h3 class="text-xs font-semibold uppercase text-base-content/50">
          <%= t("conversations.recent_translations", default: "Recent Translations") %>
        </h3>
        <span class="badge badge-xs badge-ghost">
          <%= conversation.translation_runs.count %>
        </span>
      </div>
    </div>

    <% if recent_translation_runs.empty? %>
      <div class="text-xs text-base-content/40 italic">
        <%= t("conversations.no_translations", default: "No translations yet") %>
      </div>
    <% else %>
      <div class="space-y-1">
        <% recent_translation_runs.each do |tr| %>
          <div class="w-full text-left bg-base-200 rounded-box p-2 border border-base-300">
            <div class="flex items-center gap-2">
              <span class="icon-[lucide--languages] size-4 shrink-0 text-base-content/60"></span>

              <span class="font-medium text-xs text-base-content/80 truncate flex-1 min-w-0" title="<%= tr.id %>">
                <%= tr.target_lang %>
                <span class="text-base-content/50">
                  (msg:<%= tr.message_id %><%= tr.message_swipe_id ? ", swipe:#{tr.message_swipe_id}" : "" %>)
                </span>
              </span>

              <span class="badge badge-xs <%= run_status_badge_class(tr) %> shrink-0">
                <% if tr.running? || tr.queued? %>
                  <span class="loading loading-spinner loading-xs"></span>
                <% else %>
                  <%= tr.status[0..2].upcase %>
                <% end %>
              </span>

              <span class="text-xs text-base-content/40 shrink-0 tabular-nums" title="<%= tr.created_at.to_fs(:long) %>">
                <%= distance_of_time_in_words_to_now(tr.created_at, include_seconds: true).gsub(/about |less than /, "").gsub(/ minutes?/, "m").gsub(/ seconds?/, "s").gsub(/ hours?/, "h") %>
              </span>
            </div>

            <% usage = tr.debug&.dig("usage") %>
            <% has_extra_info = usage.present? || (tr.finished_at && tr.started_at) || tr.failed? || tr.canceled? %>
            <% if has_extra_info %>
              <div class="flex items-center gap-2 mt-1 text-xs text-base-content/50 pl-6">
                <% if usage.present? %>
                  <span class="flex items-center gap-0.5" title="<%= t('conversations.tokens', default: 'Tokens') %>">
                    <span class="icon-[lucide--coins] size-3"></span>
                    <%= number_with_delimiter((usage["prompt_tokens"] || 0) + (usage["completion_tokens"] || 0)) %>
                  </span>
                <% end %>

                <% if tr.finished_at && tr.started_at %>
                  <span class="flex items-center gap-0.5" title="<%= t('conversations.duration', default: 'Duration') %>">
                    <span class="icon-[lucide--timer] size-3"></span>
                    <%= ((tr.finished_at - tr.started_at) * 1000).round %>ms
                  </span>
                <% end %>

                <% if tr.failed? || tr.canceled? %>
                  <span class="<%= tr.failed? ? 'text-error' : 'text-base-content/50' %> flex items-center gap-0.5" title="<%= tr.error&.dig('message') || tr.error&.dig('code') %>">
                    <span class="icon-[lucide--alert-circle] size-3"></span>
                    <%= tr.error&.dig("code") || tr.status %>
                  </span>
                <% end %>
              </div>
            <% end %>
          </div>
        <% end %>
      </div>
    <% end %>

    <div class="divider my-3"></div>
    <%= render "conversations/events_panel",
               conversation: conversation,
               events: conversation_events,
               events_scope: events_scope %>
  </div>
</div>
<% end %>
