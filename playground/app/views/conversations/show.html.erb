<% content_for :title, @conversation.title %>

<%# Left sidebar content %>
<% content_for :left_sidebar do %>
  <%= render "conversations/left_sidebar", conversation: @conversation, space: @space %>
<% end %>

<%# Right sidebar content %>
<% content_for :right_sidebar do %>
  <%= render "conversations/right_sidebar", conversation: @conversation, space: @space %>
<% end %>

<%# Subscribe to real-time updates %>
<%= turbo_stream_from @conversation, :messages %>

<%# Chat container %>
<div class="flex-1 flex flex-col min-h-0 overflow-hidden"
     data-controller="chat-scroll conversation-channel chat-hotkeys"
     data-chat-scroll-load-more-url-value="<%= conversation_messages_path(@conversation) %>"
     data-chat-scroll-has-more-value="<%= @has_more %>"
     data-conversation-channel-conversation-value="<%= @conversation.id %>"
     data-conversation-channel-cancel-url-value="<%= cancel_stuck_run_conversation_path(@conversation) %>"
     data-conversation-channel-retry-url-value="<%= retry_stuck_run_conversation_path(@conversation) %>"
     data-conversation-channel-health-url-value="<%= health_conversation_path(@conversation, format: :json) %>"
     data-conversation-channel-generate-url-value="<%= generate_conversation_path(@conversation) %>"
     data-chat-hotkeys-conversation-value="<%= @conversation.id %>"
     data-chat-hotkeys-regenerate-url-value="<%= regenerate_conversation_path(@conversation) %>"
     data-chat-hotkeys-stop-url-value="<%= stop_conversation_path(@conversation) %>"
     data-chat-hotkeys-current-membership-id-value="<%= @current_membership&.id %>">

  <%# Branch navigation breadcrumb - show when in a branched/checkpoint conversation %>
  <% if @conversation.parent_conversation.present? %>
    <% breadcrumb_path = conversation_breadcrumb_path(@conversation) %>
    <%# On mobile: show only first + last with ellipsis in between if path > 2 %>
    <div class="px-4 py-2 bg-base-200/50 border-b border-base-300 flex items-center gap-2 text-sm overflow-x-auto scrollbar-none">
      <%# Breadcrumb trail %>
      <nav class="flex items-center gap-1 min-w-0">
        <% breadcrumb_path.each_with_index do |conv, index| %>
          <% is_current = conv.id == @conversation.id %>
          <% is_first = index == 0 %>
          <% is_last = index == breadcrumb_path.length - 1 %>
          <% is_middle = !is_first && !is_last %>
          <% show_ellipsis = is_middle && index == 1 && breadcrumb_path.length > 2 %>

          <%# Show ellipsis on mobile when there are hidden middle items %>
          <% if show_ellipsis %>
            <span class="icon-[lucide--chevron-right] size-3 text-base-content/40 shrink-0 sm:hidden"></span>
            <span class="text-base-content/40 px-1 sm:hidden">...</span>
          <% end %>

          <%# Chevron separator - hidden on mobile for middle items %>
          <% if index > 0 %>
            <span class="icon-[lucide--chevron-right] size-3 text-base-content/40 shrink-0 <%= 'hidden sm:block' if is_middle %>"></span>
          <% end %>

          <% if is_current %>
            <%# Current conversation - not a link %>
            <span class="flex items-center gap-1 px-2 py-1 rounded bg-base-300 font-medium truncate max-w-48 sm:max-w-48 max-w-32">
              <span class="<%= conversation_kind_icon(conv) %> size-3 shrink-0"></span>
              <span class="truncate"><%= conversation_display_label(conv) %></span>
            </span>
          <% else %>
            <%# Ancestor conversation - link; hide middle items on mobile %>
            <%= link_to conversation_path(conv),
                        class: "flex items-center gap-1 px-2 py-1 rounded hover:bg-base-300 transition-colors truncate max-w-32 #{is_middle ? 'hidden sm:flex' : ''}",
                        title: conv.title do %>
              <span class="<%= conversation_kind_icon(conv) %> size-3 shrink-0 text-base-content/60"></span>
              <span class="truncate text-base-content/70"><%= conversation_display_label(conv) %></span>
            <% end %>
          <% end %>
        <% end %>
      </nav>

      <%# Fork point info - hidden on very small screens %>
      <% if @conversation.forked_from_message.present? %>
        <span class="text-base-content/40 shrink-0 hidden xs:block">Â·</span>
        <span class="text-base-content/50 text-xs shrink-0 hidden xs:block">
          <%= t("conversations.forked_at_message", default: "from #%{seq}") % { seq: @conversation.forked_from_message.seq } %>
        </span>
      <% end %>

      <%# Kind badge %>
      <span class="badge badge-xs <%= conversation_kind_badge_class(@conversation) %> shrink-0">
        <%= @conversation.kind.humanize %>
      </span>
    </div>
  <% end %>

  <%# Messages area %>
  <div class="flex-1 overflow-y-auto scrollbar-auto-hide p-4"
       data-chat-scroll-target="messages"
       id="<%= dom_id(@conversation, :messages) %>">

    <%# Empty state (JS hides this once the first message arrives) %>
    <div class="h-full flex items-center justify-center <%= "hidden" unless @messages.empty? %>"
         data-chat-scroll-target="emptyState">
      <div class="text-center max-w-md">
        <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-base-200 mb-4">
          <span class="icon-[lucide--message-circle] size-8 text-base-content/40"></span>
        </div>
        <h3 class="text-lg font-medium mb-2">
          <%= t("conversations.empty.title", default: "Start the conversation") %>
        </h3>
        <p class="text-base-content/60">
          <%= t("conversations.empty.description", default: "Send a message to begin chatting with %{name}.") % { name: @space.space_memberships.kind_character.first&.display_name || "the AI" } %>
        </p>
      </div>
    </div>

    <%# Load more sentinel (observed by IntersectionObserver) %>
    <div class="h-px w-full"
         data-chat-scroll-target="loadMore">
      <div class="hidden flex justify-center py-2"
           data-chat-scroll-target="loadMoreIndicator">
        <span class="loading loading-spinner loading-sm text-base-content/40"></span>
        <span class="ml-2 text-sm text-base-content/40">
          <%= t("messages.loading_more", default: "Loading older messages...") %>
        </span>
      </div>
    </div>

    <%# Messages list (Turbo Stream target) %>
    <%# data-current-membership-id and data-tail-message-id are used by message-actions controller to determine button visibility %>
    <div id="<%= dom_id(@conversation, :messages_list) %>"
         class="space-y-4"
         data-chat-scroll-target="list"
         data-current-membership-id="<%= @current_membership&.id %>"
         data-tail-message-id="<%= @messages.last&.id %>">
      <%= render partial: "messages/message", collection: @messages, as: :message, locals: { conversation: @conversation, space: @space } %>
    </div>

    <%# Typing indicator (shown during AI generation) %>
    <%= render "messages/typing_indicator", conversation: @conversation %>
  </div>

  <%# New messages indicator %>
  <div class="hidden absolute bottom-20 left-1/2 -translate-x-1/2 z-10"
       data-chat-scroll-target="newIndicator">
    <button class="btn btn-sm btn-primary shadow-lg gap-2"
            data-action="click->chat-scroll#jumpToBottom">
      <span class="icon-[lucide--arrow-down] size-4"></span>
      <%= t("messages.new_messages", default: "New messages") %>
    </button>
  </div>

  <%# Message composer %>
  <%= render "messages/form", conversation: @conversation, space: @space, message: @message %>
</div>

<%# Run detail modal for debugging %>
<%= render "conversations/run_detail_modal", conversation: @conversation %>

<%# Author's Note modal %>
<%= render "conversations/authors_note_modal", conversation: @conversation %>
