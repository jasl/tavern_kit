<%# Modal for editing conversation-level Author's Note %>
<%# locals: (conversation:) %>

<%# Modal element - triggered by Author's Note button %>
<dialog id="authors_note_modal" class="modal" data-controller="authors-note-modal" data-authors-note-modal-conversation-id-value="<%= conversation.id %>">
  <div class="modal-box max-w-lg">
    <%# Header %>
    <div class="flex items-center justify-between mb-4">
      <h3 class="text-lg font-bold flex items-center gap-2">
        <span class="icon-[lucide--pen-line] size-5"></span>
        <%= t("conversations.authors_note", default: "Author's Note") %>
      </h3>
      <form method="dialog">
        <button class="btn btn-ghost btn-sm btn-circle">
          <span class="icon-[lucide--x] size-4"></span>
        </button>
      </form>
    </div>

    <%# Description %>
    <p class="text-sm text-base-content/60 mb-4">
      <%= t("conversations.authors_note_description",
            default: "Custom instructions for this conversation. Overrides space-level settings when set.") %>
    </p>

    <%# Form %>
    <%= form_with model: conversation,
                  url: conversation_path(conversation),
                  method: :patch,
                  data: {
                    action: "turbo:submit-end->authors-note-modal#handleSubmit",
                    turbo_frame: "_top"
                  },
                  class: "space-y-4" do |f| %>

      <%# Author's Note Content %>
      <fieldset class="fieldset">
        <legend class="fieldset-legend"><%= t("conversations.authors_note_content", default: "Content") %></legend>
        <%= f.text_area :authors_note,
                        class: "textarea textarea-bordered w-full min-h-32 font-mono text-sm",
                        placeholder: t("conversations.authors_note_placeholder",
                                       default: "[Write in a vivid, descriptive style. Focus on character emotions...]"),
                        data: { authors_note_modal_target: "textarea", action: "input->authors-note-modal#updateCharCount" } %>
        <div class="flex justify-between mt-1">
          <span class="text-xs text-base-content/50">
            <%= t("conversations.authors_note_hint", default: "Leave empty to use space-level Author's Note") %>
          </span>
          <span class="text-xs text-base-content/50" data-authors-note-modal-target="charCount">
            <%= conversation.authors_note&.length || 0 %> <%= t("common.chars", default: "chars") %>
          </span>
        </div>
      </fieldset>

      <%# Position %>
      <fieldset class="fieldset">
        <legend class="fieldset-legend"><%= t("conversations.authors_note_position", default: "Position") %></legend>
        <div class="space-y-2">
          <label class="label cursor-pointer justify-start gap-3">
            <%= f.radio_button :authors_note_position, "before_prompt",
                               class: "radio radio-sm radio-primary",
                               data: { action: "change->authors-note-modal#toggleDepth" } %>
            <span class="label-text"><%= t("conversations.an_before_prompt", default: "Before Main Prompt / Story String") %></span>
          </label>
          <label class="label cursor-pointer justify-start gap-3">
            <%= f.radio_button :authors_note_position, "in_prompt",
                               class: "radio radio-sm radio-primary",
                               data: { action: "change->authors-note-modal#toggleDepth" } %>
            <span class="label-text"><%= t("conversations.an_in_prompt", default: "After Main Prompt / Story String") %></span>
          </label>
          <label class="label cursor-pointer justify-start gap-3">
            <%= f.radio_button :authors_note_position, "in_chat",
                               checked: conversation.authors_note_position.blank? || conversation.authors_note_position == "in_chat",
                               class: "radio radio-sm radio-primary",
                               data: { action: "change->authors-note-modal#toggleDepth" } %>
            <span class="label-text"><%= t("conversations.an_in_chat", default: "In-chat @ Depth") %></span>
          </label>
        </div>
      </fieldset>

      <%# Depth and Role (inline) %>
      <div class="grid grid-cols-2 gap-4" data-authors-note-modal-target="depthRoleRow">
        <%# Depth %>
        <fieldset class="fieldset" data-authors-note-modal-target="depthField">
          <legend class="fieldset-legend"><%= t("conversations.authors_note_depth", default: "Depth") %></legend>
          <%= f.number_field :authors_note_depth,
                             value: conversation.authors_note_depth || 4,
                             class: "input input-bordered w-full input-sm",
                             min: 0,
                             max: 100 %>
          <p class="text-xs text-base-content/50 mt-1">
            <%= t("conversations.authors_note_depth_hint", default: "0 = end of chat") %>
          </p>
        </fieldset>

        <%# Role %>
        <fieldset class="fieldset">
          <legend class="fieldset-legend"><%= t("conversations.authors_note_role", default: "Role") %></legend>
          <%= f.select :authors_note_role,
                       options_for_select([
                         ["System", "system"],
                         ["User", "user"],
                         ["Assistant", "assistant"]
                       ], conversation.authors_note_role || "system"),
                       {},
                       class: "select select-bordered w-full select-sm" %>
        </fieldset>
      </div>

      <div class="modal-action">
        <button type="button"
                class="btn btn-ghost btn-sm"
                data-action="authors-note-modal#clear">
          <span class="icon-[lucide--trash-2] size-4"></span>
          <%= t("common.clear", default: "Clear") %>
        </button>
        <form method="dialog" class="contents">
          <button class="btn btn-ghost btn-sm"><%= t("common.cancel", default: "Cancel") %></button>
        </form>
        <%= f.submit t("common.save", default: "Save"),
                     class: "btn btn-primary btn-sm",
                     data: { authors_note_modal_target: "submitButton" } %>
      </div>
    <% end %>
  </div>

  <%# Click outside to close %>
  <form method="dialog" class="modal-backdrop">
    <button>close</button>
  </form>
</dialog>
