<% content_for(:body_class, "h-dvh overflow-hidden bg-base-200") %>
<% content_for :content do %>
  <%= render "shared/flash" %>

  <%# Outer drawer for left sidebar %>
  <div class="drawer lg:drawer-open h-dvh" data-controller="sidebar" data-sidebar-key-value="left">
    <input id="left_drawer" type="checkbox" class="drawer-toggle" data-sidebar-target="toggle" />

    <%# Main content + right drawer wrapper %>
    <div class="drawer-content flex flex-col h-dvh overflow-hidden">
      <%# Inner drawer for right sidebar %>
      <div class="drawer drawer-end xl:drawer-open h-full" data-controller="sidebar" data-sidebar-key-value="right">
        <input id="right_drawer" type="checkbox" class="drawer-toggle" data-sidebar-target="toggle" />

        <%# Main content area %>
        <div class="drawer-content h-full flex flex-col overflow-hidden">
          <%# Chat header %>
          <header class="navbar min-h-0 h-14 px-4 bg-base-100 border-b border-base-300 shrink-0">
            <div class="navbar-start">
              <%# Mobile: Left drawer toggle %>
              <label for="left_drawer" class="btn btn-ghost btn-sm btn-square lg:hidden" aria-label="Open space panel">
                <span class="icon-[lucide--panel-left] size-5"></span>
              </label>

              <%# Branch switcher dropdown %>
              <% if @conversation %>
                <%= render "conversations/branch_dropdown",
                           conversation: @conversation,
                           tree_conversations: @tree_conversations %>
              <% end %>
            </div>

            <div class="navbar-end gap-2">
              <%# Hotkeys help button %>
              <button type="button"
                      class="btn btn-ghost btn-sm btn-square"
                      onclick="document.getElementById('hotkeys_help_modal').showModal()"
                      title="<%= t('hotkeys.show_shortcuts', default: 'Keyboard shortcuts (?)') %>">
                <span class="icon-[lucide--help-circle] size-5"></span>
              </button>

              <%# Theme toggle %>
              <label class="btn btn-ghost btn-sm btn-square swap swap-rotate" data-controller="theme">
                <input type="checkbox" data-theme-target="checkbox" data-action="change->theme#toggle" />
                <span class="icon-[lucide--sun] size-5 swap-off"></span>
                <span class="icon-[lucide--moon] size-5 swap-on"></span>
              </label>

              <%# Home link %>
              <%= link_to conversations_path, class: "btn btn-ghost btn-sm btn-square", title: t("layouts.navbar.home", default: "Home") do %>
                <span class="icon-[lucide--home] size-5"></span>
              <% end %>

              <%# User dropdown %>
              <% if signed_in? %>
                <div class="dropdown dropdown-end">
                  <div tabindex="0" role="button" class="btn btn-ghost btn-sm gap-2">
                    <span class="icon-[lucide--user] size-4"></span>
                    <span class="hidden sm:inline"><%= Current.user.name %></span>
                    <span class="icon-[lucide--chevron-down] size-3"></span>
                  </div>
                  <ul tabindex="0" class="dropdown-content menu bg-base-100/95 backdrop-blur-sm rounded-box z-[60] w-52 p-2 shadow-lg border border-base-300">
                    <% if Current.user.administrator? %>
                      <li>
                        <%= link_to settings_characters_path, class: "gap-2" do %>
                          <span class="icon-[lucide--settings] size-4"></span>
                          <%= t("layouts.navbar.settings", default: "Settings") %>
                        <% end %>
                      </li>
                      <li></li>
                    <% end %>
                    <li>
                      <%= button_to session_path, method: :delete, class: "text-error gap-2" do %>
                        <span class="icon-[lucide--log-out] size-4"></span>
                        <%= t("layouts.navbar.sign_out", default: "Sign Out") %>
                      <% end %>
                    </li>
                  </ul>
                </div>
              <% end %>

              <%# Mobile: Right drawer toggle %>
              <label for="right_drawer" class="btn btn-ghost btn-sm btn-square xl:hidden" aria-label="Open settings">
                <span class="icon-[lucide--settings] size-5"></span>
              </label>
            </div>
          </header>

          <%# Main chat area %>
          <main class="flex-1 flex flex-col min-h-0 overflow-hidden">
            <%= yield %>
          </main>
        </div>

        <%# Right sidebar (Settings) %>
        <div class="drawer-side z-40 h-full">
          <label for="right_drawer" aria-label="Close settings" class="drawer-overlay"></label>
          <aside class="w-96 max-w-[85vw] h-full bg-base-100 flex flex-col border-l border-base-300 overflow-hidden">
            <%= yield :right_sidebar %>
          </aside>
        </div>
      </div>
    </div>

    <%# Left sidebar (Space/Members) %>
    <div class="drawer-side z-50 h-full">
      <label for="left_drawer" aria-label="Close space panel" class="drawer-overlay"></label>
      <aside class="w-80 max-w-[85vw] h-full bg-base-100 flex flex-col border-r border-base-300 overflow-hidden">
        <%= yield :left_sidebar %>
      </aside>
    </div>
  </div>
<% end %>

<%= render template: "layouts/base" %>
