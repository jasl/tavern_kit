<%# Group chat queue display %>
<%# locals: (presenter:, render_seq: nil) %>
<%
  conversation = presenter.conversation
  space = presenter.space
  render_seq ||= presenter.render_seq
  visible_members = presenter.visible_queue_members
  remaining_count = presenter.remaining_queue_count
  active_run = presenter.active_run
  current_speaker = presenter.current_speaker
  is_idle = presenter.idle?
  is_ai_generating = presenter.ai_generating?
%>

<div id="<%= presenter.dom_id %>"
     class="flex items-center justify-between h-10 px-3 mb-2 bg-base-200/50 rounded-box"
     data-controller="group-queue"
     data-group-queue-space-id-value="<%= space.id %>"
     data-group-queue-render-seq-value="<%= render_seq %>">

  <%# Left side: Current speaker + Queue %>
  <div class="flex items-center gap-3">
    <%# Current speaker indicator %>
    <%#
      Priority order:
      1. Idle state takes precedence - if scheduler says idle, show "Your turn"
         even if a run is still being finalized (message created but run not yet succeeded)
      2. Paused state
      3. Active run with speaker (AI generating)
      4. AI generating state (fallback)
      5. Other states
    %>
    <div class="flex items-center gap-2">
      <% if is_idle %>
        <%# Idle - your turn to speak (takes precedence over active run) %>
        <span class="flex items-center gap-1.5 text-xs">
          <span class="icon-[lucide--message-square] size-3 text-success"></span>
          <span class="text-success font-medium">
            <%= t("messages.your_turn", default: "Your turn") %>
          </span>
        </span>
      <% elsif presenter.paused? %>
        <%# Paused - waiting for user to resume %>
        <span class="flex items-center gap-1.5 text-xs">
          <span class="icon-[lucide--pause-circle] size-3 text-warning"></span>
          <span class="text-warning font-medium">
            <%= active_run ? t("messages.pausing", default: "Pausing...") : t("messages.paused", default: "Paused") %>
          </span>
        </span>
      <% elsif active_run.present? && current_speaker %>
        <%# Active run (queued/running) - bind indicator to run speaker to match typing %>
        <span class="flex items-center gap-1.5 text-xs">
          <span class="loading loading-spinner loading-xs text-info"></span>
          <span class="text-info font-medium"><%= current_speaker.display_name %></span>
        </span>
      <% elsif is_ai_generating && current_speaker %>
        <%# AI is currently generating (fallback when run isn't loaded) %>
        <span class="flex items-center gap-1.5 text-xs">
          <span class="loading loading-spinner loading-xs text-info"></span>
          <span class="text-info font-medium"><%= current_speaker.display_name %></span>
        </span>
      <% else %>
        <%# Other states %>
        <span class="flex items-center gap-1.5 text-xs text-base-content/50">
          <span class="icon-[lucide--users] size-3"></span>
          <span><%= presenter.scheduling_state.humanize %></span>
        </span>
      <% end %>
    </div>

    <%# Separator %>
    <% if presenter.has_queue? || (!is_idle && current_speaker) %>
      <span class="text-base-content/20">→</span>
    <% end %>

    <%# Upcoming queue %>
    <div class="flex items-center gap-2">
      <% if presenter.has_queue? || (!is_idle && current_speaker) %>
        <span class="text-xs text-base-content/40">
          <%= t("messages.next", default: "Next") %>:
        </span>
        <% if presenter.has_queue? %>
          <div class="avatar-group -space-x-3 rtl:space-x-reverse">
            <% visible_members.each_with_index do |member, index| %>
              <div class="avatar tooltip tooltip-bottom z-<%= 10 - index %>"
                   data-tip="<%= member.display_name %>">
                <div class="w-6 rounded-full ring-1 ring-base-100 overflow-hidden bg-base-300">
                  <%= image_tag space_membership_portrait_url(member),
                                class: "w-full h-full object-cover",
                                alt: member.display_name,
                                loading: "lazy" %>
                </div>
              </div>
            <% end %>

            <% if remaining_count > 0 %>
              <div class="avatar avatar-placeholder tooltip tooltip-bottom"
                   data-tip="<%= t('messages.more_speakers', default: '%{count} more') % { count: remaining_count } %>">
                <div class="bg-neutral text-neutral-content w-6 rounded-full text-xs font-medium">
                  <span>+<%= remaining_count %></span>
                </div>
              </div>
            <% end %>
          </div>
        <% else %>
          <span class="text-xs text-base-content/40" data-group-queue-next-empty>
            —
          </span>
        <% end %>
      <% end %>
    </div>
  </div>

  <%# Right side: Group chat settings %>
  <div class="flex items-center gap-4">
    <%# Group Settings button - opens Space tab in right sidebar %>
    <button type="button"
            class="btn btn-xs btn-ghost gap-1"
            data-action="click->sidebar#openTab"
            data-sidebar-tab-param="space"
            title="<%= t('messages.group_settings', default: 'Group Chat Settings') %>">
      <span class="icon-[lucide--settings-2] size-3"></span>
      <span class="text-xs hidden sm:inline"><%= t("messages.settings", default: "Settings") %></span>
    </button>

    <div class="divider divider-horizontal mx-0 w-0"></div>

    <%# Pause/Resume - only shown when automation is active and round is in progress %>
    <% if presenter.show_pause_controls? %>
      <div data-controller="pause-toggle"
           data-pause-toggle-pause-url-value="<%= pause_round_conversation_path(conversation) %>"
           data-pause-toggle-resume-url-value="<%= resume_round_conversation_path(conversation) %>"
           data-pause-toggle-paused-value="<%= presenter.paused? %>"
           data-pause-toggle-resume-blocked-value="<%= presenter.resume_blocked? %>">
        <% if presenter.paused? %>
          <button type="button"
                  class="btn btn-xs btn-warning gap-1"
                  data-pause-toggle-target="button"
                  data-action="click->pause-toggle#resume"
                  <%= "disabled" if presenter.resume_blocked? %>
                  title="<%= t('messages.resume_round', default: 'Resume round') %>">
            <span class="icon-[lucide--play] size-3"></span>
            <span class="text-xs"><%= t("messages.resume", default: "Resume") %></span>
          </button>
        <% else %>
          <button type="button"
                  class="btn btn-xs btn-ghost gap-1"
                  data-pause-toggle-target="button"
                  data-action="click->pause-toggle#pause"
                  title="<%= t('messages.pause_round', default: 'Pause round') %>">
            <span class="icon-[lucide--pause-circle] size-3"></span>
            <span class="text-xs hidden sm:inline"><%= t("messages.pause", default: "Pause") %></span>
          </button>
        <% end %>
      </div>

      <div class="divider divider-horizontal mx-0 w-0"></div>
    <% end %>

    <%# Manage round - modal for add/reorder/remove speakers %>
    <button type="button"
            class="btn btn-xs btn-ghost gap-1"
            data-controller="dialog"
            data-dialog-id-value="round_queue_modal"
            data-action="click->dialog#open"
            title="<%= t('messages.manage_round', default: 'Manage round') %>">
      <span class="icon-[lucide--list-ordered] size-3"></span>
      <span class="text-xs hidden sm:inline"><%= t("messages.manage", default: "Manage") %></span>
    </button>

    <div class="divider divider-horizontal mx-0 w-0"></div>

    <%# Skip current speaker - immediate cancel+advance %>
    <% if current_speaker && !is_idle %>
      <%= link_to skip_current_speaker_conversation_path(conversation),
                  data: { turbo_method: :post, turbo_stream: true },
                  class: "btn btn-xs btn-ghost gap-1",
                  title: t("messages.skip_current_speaker", default: "Skip current speaker") do %>
        <span class="icon-[lucide--skip-forward] size-3"></span>
        <span class="text-xs hidden sm:inline"><%= t("messages.skip", default: "Skip") %></span>
      <% end %>

      <div class="divider divider-horizontal mx-0 w-0"></div>
    <% end %>

    <%# Auto without human - AI-to-AI (single-step UI: enable=1 round) %>
    <div class="flex items-center gap-1.5"
         data-controller="auto-without-human-toggle"
         data-auto-without-human-toggle-url-value="<%= toggle_auto_without_human_conversation_path(conversation) %>"
         data-auto-without-human-toggle-default-rounds-value="<%= Conversation::DEFAULT_AUTO_WITHOUT_HUMAN_ROUNDS %>"
         data-auto-without-human-toggle-enabled-value="<%= conversation.auto_without_human_enabled? %>"
         id="<%= dom_id(conversation, :auto_without_human_toggle) %>">
      <span class="text-xs text-base-content/60 hidden sm:inline">
        <%= t("messages.auto_without_human", default: "Auto without human") %>
      </span>
      <button type="button"
              class="btn btn-xs gap-1 <%= conversation.auto_without_human_enabled? ? 'btn-success' : 'btn-ghost' %>"
              data-auto-without-human-toggle-target="button"
              data-action="click->auto-without-human-toggle#toggle"
              title="<%= conversation.auto_without_human_enabled? ? t('messages.auto_without_human_stop', default: 'Stop auto without human') : t('messages.auto_without_human_start', default: 'Auto without human (1 round)') %>">
        <span class="<%= conversation.auto_without_human_enabled? ? 'icon-[lucide--pause]' : 'icon-[lucide--fast-forward]' %> size-3"
              data-auto-without-human-toggle-target="icon"></span>
        <span class="font-mono" data-auto-without-human-toggle-target="count">
          <%= conversation.auto_without_human_enabled? ? conversation.auto_without_human_remaining_rounds : Conversation::DEFAULT_AUTO_WITHOUT_HUMAN_ROUNDS %>
        </span>
      </button>
    </div>
  </div>
</div>
