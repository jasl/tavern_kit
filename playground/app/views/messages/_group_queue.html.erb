<%# Group chat queue display %>
<%# locals: (conversation:, space:, queue_members:, active_run: nil, render_seq: nil) %>
<%
  # Monotonic client guard against out-of-order Turbo Stream updates.
  #
  # IMPORTANT: Must be derived from DB state (not wall-clock time) because
  # queue updates can be broadcast from multiple processes (web + job),
  # and process clocks are not guaranteed to be in sync.
  render_seq = local_assigns[:render_seq] || conversation.group_queue_revision.to_i

  max_visible = 3
  visible_members = queue_members.first(max_visible)
  remaining_count = queue_members.size - max_visible

  # Determine current speaker status
  active_run = local_assigns[:active_run]
  active_run ||= conversation.conversation_runs.active.includes(:speaker_space_membership).order(
    Arel.sql("CASE status WHEN 'running' THEN 0 WHEN 'queued' THEN 1 ELSE 2 END"),
    created_at: :desc
  ).first

  scheduling_state = conversation.scheduling_state
  current_speaker = active_run&.speaker_space_membership || conversation.current_speaker
  is_idle = scheduling_state == "idle"
  is_ai_generating = scheduling_state == "ai_generating"
  is_human_waiting = scheduling_state == "human_waiting"
%>

<div id="<%= dom_id(conversation, :group_queue) %>"
     class="flex items-center justify-between h-10 px-3 mb-2 bg-base-200/50 rounded-lg"
     data-controller="group-queue"
     data-group-queue-space-id-value="<%= space.id %>"
     data-group-queue-render-seq-value="<%= render_seq %>">

  <%# Left side: Current speaker + Queue %>
  <div class="flex items-center gap-3">
    <%# Current speaker indicator %>
    <div class="flex items-center gap-2">
      <% if active_run&.human_turn? && current_speaker %>
        <%# Human turn tracker (auto-mode) %>
        <span class="flex items-center gap-1.5 text-xs">
          <span class="icon-[lucide--clock] size-3 text-warning"></span>
          <span class="text-warning font-medium">
            <%= t("messages.waiting_for", default: "Waiting: %{name}") % { name: current_speaker.display_name } %>
          </span>
        </span>
      <% elsif active_run.present? && current_speaker %>
        <%# Active run (queued/running) - bind indicator to run speaker to match typing %>
        <span class="flex items-center gap-1.5 text-xs">
          <span class="loading loading-spinner loading-xs text-info"></span>
          <span class="text-info font-medium"><%= current_speaker.display_name %></span>
        </span>
      <% elsif is_human_waiting && current_speaker %>
        <%# Waiting for human in auto mode %>
        <span class="flex items-center gap-1.5 text-xs">
          <span class="icon-[lucide--clock] size-3 text-warning"></span>
          <span class="text-warning font-medium">
            <%= t("messages.waiting_for", default: "Waiting: %{name}") % { name: current_speaker.display_name } %>
          </span>
        </span>
      <% elsif is_ai_generating && current_speaker %>
        <%# AI is currently generating (fallback when run isn't loaded) %>
        <span class="flex items-center gap-1.5 text-xs">
          <span class="loading loading-spinner loading-xs text-info"></span>
          <span class="text-info font-medium"><%= current_speaker.display_name %></span>
        </span>
      <% elsif is_idle %>
        <%# Idle - your turn to speak %>
        <span class="flex items-center gap-1.5 text-xs">
          <span class="icon-[lucide--message-square] size-3 text-success"></span>
          <span class="text-success font-medium">
            <%= t("messages.your_turn", default: "Your turn") %>
          </span>
        </span>
      <% else %>
        <%# Other states %>
        <span class="flex items-center gap-1.5 text-xs text-base-content/50">
          <span class="icon-[lucide--users] size-3"></span>
          <span><%= scheduling_state.humanize %></span>
        </span>
      <% end %>
    </div>

    <%# Separator %>
    <% if queue_members.any? %>
      <span class="text-base-content/20">â†’</span>
    <% end %>

    <%# Upcoming queue %>
    <div class="flex items-center gap-2">
      <% if queue_members.any? %>
        <span class="text-xs text-base-content/40">
          <%= t("messages.next", default: "Next") %>:
        </span>
        <div class="avatar-group -space-x-3 rtl:space-x-reverse">
          <% visible_members.each_with_index do |member, index| %>
            <div class="avatar tooltip tooltip-bottom z-<%= 10 - index %>"
                 data-tip="<%= member.display_name %>">
              <div class="w-6 rounded-full ring-1 ring-base-100 overflow-hidden bg-base-300">
                <%= image_tag space_membership_portrait_url(member),
                              class: "w-full h-full object-cover",
                              alt: member.display_name,
                              loading: "lazy" %>
              </div>
            </div>
          <% end %>

          <% if remaining_count > 0 %>
            <div class="avatar avatar-placeholder tooltip tooltip-bottom"
                 data-tip="<%= t('messages.more_speakers', default: '%{count} more') % { count: remaining_count } %>">
              <div class="bg-neutral text-neutral-content w-6 rounded-full text-xs font-medium">
                <span>+<%= remaining_count %></span>
              </div>
            </div>
          <% end %>
        </div>
      <% end %>
    </div>
  </div>

  <%# Right side: Group chat settings %>
  <div class="flex items-center gap-4">
    <%# Auto Mode toggle - allows AI-to-AI conversation %>
    <div class="flex items-center gap-1.5"
         data-controller="auto-mode-toggle"
         data-auto-mode-toggle-url-value="<%= toggle_auto_mode_conversation_path(conversation) %>"
         data-auto-mode-toggle-default-rounds-value="<%= Conversation::DEFAULT_AUTO_MODE_ROUNDS %>"
         data-auto-mode-toggle-enabled-value="<%= conversation.auto_mode_enabled? %>"
         id="<%= dom_id(conversation, :auto_mode_toggle) %>">
      <span class="text-xs text-base-content/60 hidden sm:inline">
        <%= t("messages.auto_mode", default: "Auto") %>
      </span>
      <% if conversation.auto_mode_enabled? %>
        <button type="button"
                class="btn btn-xs btn-success gap-1"
                data-auto-mode-toggle-target="button"
                data-action="click->auto-mode-toggle#stop"
                title="<%= t('messages.auto_mode_stop', default: 'Stop auto-mode') %>">
          <span class="icon-[lucide--pause] size-3" data-auto-mode-toggle-target="icon"></span>
          <span class="font-mono" data-auto-mode-toggle-target="count"><%= conversation.auto_mode_remaining_rounds %></span>
        </button>
      <% else %>
        <button type="button"
                class="btn btn-xs btn-ghost gap-1"
                data-auto-mode-toggle-target="button"
                data-action="click->auto-mode-toggle#start"
                title="<%= t('messages.auto_mode_start', default: 'Start %{rounds} rounds of AI-to-AI conversation') % { rounds: Conversation::DEFAULT_AUTO_MODE_ROUNDS } %>">
          <span class="icon-[lucide--play] size-3" data-auto-mode-toggle-target="icon"></span>
          <span class="font-mono" data-auto-mode-toggle-target="count"><%= Conversation::DEFAULT_AUTO_MODE_ROUNDS %></span>
        </button>
      <% end %>
    </div>

    <div class="divider divider-horizontal mx-0 w-0"></div>

    <%# Relax Message Trim toggle %>
    <label class="flex items-center gap-1.5 cursor-pointer tooltip tooltip-left"
           data-tip="<%= t('messages.relax_message_trim_hint', default: 'Allow AI to generate dialogue for other characters') %>">
      <span class="text-xs text-base-content/60 hidden sm:inline">
        <%= t("messages.relax_trim", default: "Relax Trim") %>
      </span>
      <%= form_with url: playground_path(space),
                    method: :patch,
                    data: { controller: "auto-submit" },
                    class: "inline" do |f| %>
        <input type="hidden" name="playground[relax_message_trim]" value="0" />
        <input type="checkbox"
               name="playground[relax_message_trim]"
               value="1"
               class="toggle toggle-xs toggle-secondary"
               <%= "checked" if space.relax_message_trim? %>
               data-action="change->auto-submit#submit" />
      <% end %>
    </label>

    <%# Allow Self Response toggle %>
    <label class="flex items-center gap-1.5 cursor-pointer tooltip tooltip-left"
           data-tip="<%= t('messages.allow_self_response_hint', default: 'Allow same character to respond consecutively') %>">
      <span class="text-xs text-base-content/60 hidden sm:inline">
        <%= t("messages.allow_self_response", default: "Self Reply") %>
      </span>
      <%= form_with url: playground_path(space),
                    method: :patch,
                    data: { controller: "auto-submit" },
                    class: "inline" do |f| %>
        <input type="hidden" name="playground[allow_self_responses]" value="0" />
        <input type="checkbox"
               name="playground[allow_self_responses]"
               value="1"
               class="toggle toggle-xs toggle-primary"
               <%= "checked" if space.allow_self_responses? %>
               data-action="change->auto-submit#submit" />
      <% end %>
    </label>
  </div>
</div>
