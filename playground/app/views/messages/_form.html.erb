<%# Message composer form %>
<%# locals: (conversation:, space:, message:) %>
<%
  space_read_only = !space.active?
  user_membership = space.space_memberships.active.find_by(user: Current.user, kind: "human")
  has_persona = user_membership&.character_id.present?
  copilot_full = user_membership&.copilot_full?
  input_disabled = space_read_only || copilot_full
  textarea_actions = ["keydown->message-form#handleKeydown", (has_persona ? "input->copilot#handleInput" : nil)].compact.join(" ")
  is_group = space.group?
%>

<%= tag.div id: "message_form",
            class: "p-4 border-t border-base-300 bg-base-100",
            data: {
              controller: [has_persona ? "copilot" : nil, "prompt-preview"].compact.join(" "),
              copilot_url_value: has_persona ? playground_copilot_candidates_path(space) : nil,
              copilot_full_value: has_persona ? copilot_full : nil,
              copilot_membership_id_value: has_persona ? user_membership&.id : nil,
              copilot_membership_update_url_value: has_persona ? playground_membership_path(space, user_membership) : nil,
              prompt_preview_url_value: playground_prompt_preview_path(space)
            }.compact do %>

  <% if space.archived? %>
    <div class="alert alert-warning mb-3 text-sm">
      <span class="icon-[lucide--archive] size-4"></span>
      <span><%= t("spaces.archived_read_only", default: "This chat is archived and read-only.") %></span>
    </div>
  <% elsif space.deleting? %>
    <div class="alert alert-warning mb-3 text-sm">
      <span class="icon-[lucide--trash-2] size-4"></span>
      <span><%= t("spaces.deleting_read_only", default: "This chat is being deleted and is temporarily unavailable.") %></span>
    </div>
  <% elsif copilot_full %>
    <div class="alert alert-info mb-3 text-sm" data-copilot-target="fullModeAlert">
      <span class="icon-[lucide--bot] size-4"></span>
      <span>
        <%= t("copilot.full_mode_active_prefix", default: "Auto mode active (") %><span data-copilot-target="stepsCount"><%= user_membership.copilot_remaining_steps %></span><%= t("copilot.full_mode_active_suffix", default: " steps left)") %>
      </span>
    </div>
  <% end %>

  <%# Copilot candidates area - above the form %>
  <% if has_persona %>
    <div data-copilot-target="candidatesContainer" class="hidden mb-3">
      <div class="flex items-center gap-2 mb-2">
        <span class="text-xs text-base-content/60 font-medium">
          <span class="icon-[lucide--sparkles] size-3 mr-1"></span>
          <%= t("copilot.suggestions", default: "Suggestions") %>
        </span>
        <button type="button" class="btn btn-ghost btn-xs btn-circle" data-action="copilot#clearCandidates" title="<%= t('copilot.clear', default: 'Clear') %>">
          <span class="icon-[lucide--x] size-3"></span>
        </button>
      </div>
      <div class="flex flex-col gap-y-1 max-h-40 overflow-y-auto" data-copilot-target="candidatesList">
        <%# Candidates inserted here dynamically %>
      </div>
    </div>
  <% end %>

  <%# Group chat queue display - shows speaker queue and group settings %>
  <% if is_group %>
    <%
      # Get predicted speaker queue from SpeakerSelector
      queue_members = SpeakerSelector.new(conversation).predicted_queue(limit: 10)
    %>
    <%= render "messages/group_queue", conversation: conversation, space: space, queue_members: queue_members %>
  <% end %>

  <%= form_with url: conversation_messages_path(conversation),
                scope: :message,
                data: {
                  turbo_stream: true,
                  controller: "message-form",
                  copilot_target: "form"
                },
                class: "flex gap-3" do |f| %>

    <%# Text input area - resizable textarea with more height %>
    <div class="flex-1 min-w-0">
      <%= f.text_area :content,
                      rows: 4,
                      placeholder: copilot_full ?
                        t("copilot.full_mode_placeholder", default: "Auto mode active...") :
                        t("messages.placeholder", default: "Type your message..."),
                      class: "textarea textarea-bordered w-full resize-y min-h-[8rem] max-h-64",
                      disabled: input_disabled,
                      data: {
                        action: textarea_actions,
                        copilot_target: "textarea",
                        message_form_target: "textarea",
                        chat_hotkeys_target: "textarea",
                        prompt_preview_target: "textarea"
                      },
                      autofocus: !input_disabled %>
    </div>

    <%# Action buttons - vertical layout, uniform width %>
    <div class="flex flex-col gap-1.5 shrink-0 justify-end w-24">
      <%# Row 1: Auto mode toggle (for persona users) %>
      <% if has_persona && !space_read_only %>
        <label class="swap btn btn-ghost btn-sm w-full"
               title="<%= copilot_full ?
                 t('copilot.auto_mode_on', default: 'Auto mode ON - Click to disable') :
                 t('copilot.auto_mode_off', default: 'Auto mode OFF - Click to enable') %>">
          <input type="checkbox"
                 <%= "checked" if copilot_full %>
                 data-copilot-target="fullToggle"
                 data-action="change->copilot#toggleFullMode" />
          <span class="swap-on flex items-center gap-1 text-success">
            <span class="icon-[lucide--bot] size-4"></span>
            <%= t("copilot.auto", default: "Auto") %>
          </span>
          <span class="swap-off flex items-center gap-1 text-base-content/50">
            <span class="icon-[lucide--bot] size-4"></span>
            <%= t("copilot.auto", default: "Auto") %>
          </span>
        </label>
      <% end %>

      <%# Row 2: Generate suggestions (for persona users) %>
      <% if has_persona && !space_read_only %>
        <div class="dropdown dropdown-top dropdown-end w-full"
             data-copilot-target="countBtn">
          <button type="button"
                  tabindex="0"
                  class="btn btn-secondary btn-sm w-full gap-1"
                  data-copilot-target="generateBtn"
                  <%= "disabled" if copilot_full %>
                  title="<%= t('copilot.generate_title', default: 'Generate AI suggestions') %>">
            <span class="icon-[lucide--sparkles] size-4" data-copilot-target="generateIcon"></span>
            <span class="loading loading-spinner loading-xs hidden" data-copilot-target="generateSpinner"></span>
            <span data-copilot-target="generateText"><%= t("copilot.vibe", default: "Vibe") %></span>
          </button>
          <ul class="dropdown-content menu bg-base-100/95 backdrop-blur-sm rounded-box w-full p-1 shadow-lg border border-base-300 z-10">
            <li><button type="button" class="justify-center text-xs" data-action="copilot#generateWithCount" data-count="1">1</button></li>
            <li><button type="button" class="justify-center text-xs" data-action="copilot#generateWithCount" data-count="2">2</button></li>
            <li><button type="button" class="justify-center text-xs" data-action="copilot#generateWithCount" data-count="3">3</button></li>
            <li><button type="button" class="justify-center text-xs" data-action="copilot#generateWithCount" data-count="4">4</button></li>
          </ul>
        </div>
      <% end %>

      <%# Row 3: Send button %>
      <button type="submit"
              class="btn btn-primary btn-sm w-full gap-1"
              data-copilot-target="sendBtn"
              <%= "disabled" if input_disabled %>>
        <span class="icon-[lucide--send] size-4"></span>
        <%= t("messages.send", default: "Send") %>
      </button>

      <%# Row 4: Preview Prompt button %>
      <button type="button"
              class="btn btn-ghost btn-sm w-full gap-1"
              data-action="prompt-preview#preview"
              data-prompt-preview-target="previewBtn"
              <%= "disabled" if space_read_only %>
              title="<%= t('messages.preview_prompt_title', default: 'Preview the prompt that will be sent to the LLM') %>">
        <span class="icon-[lucide--eye] size-4"></span>
        <%= t("messages.preview", default: "Preview") %>
      </button>
    </div>
  <% end %>

  <%# Prompt Preview Modal %>
  <dialog class="modal" data-prompt-preview-target="modal">
    <div class="modal-box max-w-4xl max-h-[85vh] flex flex-col">
      <div class="flex items-center justify-between mb-4">
        <h3 class="font-bold text-lg flex items-center gap-2">
          <span class="icon-[lucide--file-text] size-5"></span>
          <%= t("messages.prompt_preview", default: "Prompt Preview") %>
        </h3>
        <form method="dialog">
          <button class="btn btn-ghost btn-sm btn-circle">
            <span class="icon-[lucide--x] size-4"></span>
          </button>
        </form>
      </div>

      <div class="flex-1 min-h-0" data-prompt-preview-target="content">
        <%# Content will be loaded dynamically %>
        <div class="flex items-center justify-center py-12">
          <span class="loading loading-spinner loading-lg text-base-content/30"></span>
        </div>
      </div>
    </div>
    <form method="dialog" class="modal-backdrop">
      <button>close</button>
    </form>
  </dialog>
<% end %>
