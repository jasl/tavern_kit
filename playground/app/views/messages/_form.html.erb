<%# Message composer form %>
<%# locals: (conversation:, space:, message:) %>
<%
  space_read_only = !space.active?
  user_membership = space.space_memberships.active.find_by(user: Current.user, kind: "human")
  has_persona = user_membership&.character_id.present?
  copilot_full = user_membership&.copilot_full?
  turn_state = TurnScheduler.state(conversation)

  # Input policy: reject policy locks input during AI generation
  reject_policy = space.during_generation_user_input_policy_reject?
  is_ai_generating = turn_state.ai_generating?
  generation_locked = reject_policy && is_ai_generating

  # Hard lock: user cannot send messages at all
  # - space_read_only: archived/inactive space
  # - generation_locked: reject policy + AI generating
  #
  # Soft lock (Copilot/Auto Mode): user CAN type to auto-disable these modes
  # See: docs/spec/SILLYTAVERN_DIVERGENCES.md "User input always takes priority"
  input_disabled = space_read_only || generation_locked

  # Display remaining steps:
  # - When copilot is ON: show actual remaining steps
  # - When copilot is OFF: show default steps (what user will get when enabling)
  copilot_steps_display = copilot_full ?
    user_membership.copilot_remaining_steps :
    SpaceMembership::DEFAULT_COPILOT_STEPS
  textarea_actions = [
    "keydown->message-form#handleKeydown",
    "input->message-form#handleInput",
    (has_persona ? "input->copilot#handleInput" : nil)
  ].compact.join(" ")
  is_group = space.group?
%>

<%= tag.div id: "message_form",
            class: "p-1 border-t border-base-300 bg-base-100",
            data: {
              controller: ["message-form", has_persona ? "copilot" : nil, "prompt-preview"].compact.join(" "),
              # Message form controller values for dynamic input locking (hard lock only)
              # Note: Copilot/Auto mode are soft locks - user can type to auto-disable them
              message_form_conversation_id_value: conversation.id,
              message_form_reject_policy_value: reject_policy,
              message_form_scheduling_state_value: turn_state.scheduling_state,
              message_form_space_read_only_value: space_read_only,
              # Copilot controller values
              copilot_url_value: has_persona ? playground_copilot_candidates_path(space) : nil,
              copilot_full_value: has_persona ? copilot_full : nil,
              copilot_membership_id_value: has_persona ? user_membership&.id : nil,
              copilot_membership_update_url_value: has_persona ? playground_membership_path(space, user_membership) : nil,
              prompt_preview_url_value: playground_prompt_preview_path(space)
            }.compact do %>

  <%# Disconnected alert - shown when WebSocket connection is lost %>
  <div id="cable_disconnect_alert"
       class="alert alert-error mb-3 text-sm hidden"
       data-message-form-target="cableDisconnectAlert">
    <span class="icon-[lucide--wifi-off] size-5 shrink-0"></span>
    <span>
      <%= t("messages.errors.disconnected", default: "Disconnected. Reconnectingâ€¦") %>
    </span>
    <button type="button"
            class="btn btn-sm btn-error"
            data-action="message-form#reloadPage">
      <span class="icon-[lucide--refresh-cw] size-4"></span>
      <%= t("messages.reload", default: "Reload") %>
    </button>
  </div>

  <%# Error alert - shown when a run fails and blocks progress %>
  <div id="run_error_alert"
       class="alert alert-error mb-3 text-sm hidden"
       data-conversation-channel-target="runErrorAlert">
    <span class="icon-[lucide--alert-circle] size-5 shrink-0"></span>
    <span data-conversation-channel-target="runErrorMessage">
      <%= t("messages.errors.run_failed", default: "AI response failed. Click Retry to try again. Sending a new message will reset the round (Auto mode/Copilot will be turned off).") %>
    </span>
    <button type="button"
            class="btn btn-sm btn-error"
            data-action="conversation-channel#retryFailedRun">
      <span class="icon-[lucide--refresh-cw] size-4"></span>
      <%= t("messages.retry", default: "Retry") %>
    </button>
  </div>

  <%# Idle alert - shown when conversation should be active but no run exists %>
  <div id="idle_alert"
       class="alert alert-warning mb-3 text-sm hidden"
       data-conversation-channel-target="idleAlert">
    <span class="icon-[lucide--alert-triangle] size-5 shrink-0"></span>
    <span data-conversation-channel-target="idleAlertMessage">
      <%= t("messages.errors.idle_unexpected", default: "Conversation seems stuck. No AI is responding.") %>
    </span>
    <span class="hidden" data-conversation-channel-target="idleAlertSpeaker" data-speaker-id=""></span>
    <button type="button"
            class="btn btn-sm btn-warning"
            data-action="conversation-channel#generateFromIdleAlert">
      <span class="icon-[lucide--play] size-4"></span>
      <%= t("messages.generate", default: "Generate") %>
    </button>
  </div>

  <%# Token limit exceeded warning %>
  <% if space.token_limit_exceeded? %>
    <div id="token_limit_alert"
         class="alert alert-warning mb-3 text-sm">
      <span class="icon-[lucide--alert-triangle] size-5 shrink-0"></span>
      <span>
        <%= t("messages.errors.token_limit_exceeded",
              used: number_with_delimiter(space.total_tokens_used),
              limit: number_with_delimiter(space.effective_token_limit),
              default: "Token limit reached (%{used} / %{limit}). Generation is blocked.") %>
      </span>
      <%= link_to edit_playground_path(space),
                  class: "btn btn-sm btn-warning" do %>
        <span class="icon-[lucide--settings] size-4"></span>
        <%= t("messages.adjust_limit", default: "Adjust Limit") %>
      <% end %>
    </div>
  <% end %>

  <% if space.archived? %>
    <div class="alert alert-warning mb-3 text-sm">
      <span class="icon-[lucide--archive] size-4"></span>
      <span><%= t("spaces.archived_read_only", default: "This chat is archived and read-only.") %></span>
    </div>
  <% elsif space.deleting? %>
    <div class="alert alert-warning mb-3 text-sm">
      <span class="icon-[lucide--trash-2] size-4"></span>
      <span><%= t("spaces.deleting_read_only", default: "This chat is being deleted and is temporarily unavailable.") %></span>
    </div>
  <% end %>

  <%# Copilot candidates area - above the form %>
  <% if has_persona %>
    <div data-copilot-target="candidatesContainer" class="hidden mb-3">
      <div class="flex items-center gap-2 mb-2">
        <span class="text-xs text-base-content/60 font-medium">
          <span class="icon-[lucide--sparkles] size-3 mr-1"></span>
          <%= t("copilot.suggestions", default: "Suggestions") %>
        </span>
        <button type="button" class="btn btn-ghost btn-xs btn-circle" data-action="copilot#clearCandidates" title="<%= t('copilot.clear', default: 'Clear') %>">
          <span class="icon-[lucide--x] size-3"></span>
        </button>
      </div>
      <div class="flex flex-col gap-y-1 max-h-40 overflow-y-auto" data-copilot-target="candidatesList">
        <%# Candidates inserted here dynamically %>
      </div>
    </div>
  <% end %>

  <%# Group chat queue display - shows speaker queue and group settings %>
  <% if is_group %>
    <% presenter = GroupQueuePresenter.new(conversation: conversation, space: space) %>
    <%= render "messages/group_queue", presenter: presenter %>
  <% end %>

  <%= form_with url: conversation_messages_path(conversation),
                scope: :message,
                data: {
                  turbo_stream: true,
                  copilot_target: "form"
                },
                class: "flex flex-col sm:flex-row sm:items-center gap-2 sm:gap-3" do |f| %>

    <%# Text input area %>
    <div class="flex-1 min-w-0 order-1 sm:order-0">
      <%
        # Determine placeholder based on state
        placeholder_text = if generation_locked
          t("messages.generation_locked_placeholder", default: "Waiting for AI response...")
        elsif copilot_full
          t("copilot.copilot_placeholder", default: "Copilot is writing for your persona...")
        else
          t("messages.placeholder", default: "Type your message...")
        end
      %>
      <%= f.text_area :content,
                      rows: 5,
                      placeholder: placeholder_text,
                      class: "textarea textarea-bordered w-full resize-none min-h-[152px]",
                      disabled: input_disabled,
                      data: {
                        action: textarea_actions,
                        copilot_target: "textarea",
                        message_form_target: "textarea",
                        chat_hotkeys_target: "textarea",
                        prompt_preview_target: "textarea",
                        default_placeholder: t("messages.placeholder", default: "Type your message..."),
                        locked_placeholder: t("messages.generation_locked_placeholder", default: "Waiting for AI response...")
                      },
                      autofocus: !input_disabled %>
    </div>

    <%# Action buttons - horizontal on mobile, vertical on desktop %>
    <div class="flex flex-row sm:flex-col gap-1.5 shrink-0 sm:w-24 order-2 sm:order-0">
      <%# Row 1: Copilot toggle (for persona users) - Auto mode for human persona %>
      <% if has_persona && !space_read_only %>
        <button type="button"
                class="btn btn-sm flex-1 sm:flex-none sm:w-full gap-1 <%= copilot_full ? 'btn-success' : 'btn-ghost' %>"
                data-copilot-target="fullToggle"
                data-action="click->copilot#toggleFullMode"
                data-copilot-default-steps="<%= SpaceMembership::DEFAULT_COPILOT_STEPS %>"
                title="<%= copilot_full ?
                  t('copilot.enabled_hint', default: 'Auto mode ON - AI writes for your persona. Click to disable') :
                  t('copilot.disabled_hint', default: 'Auto mode OFF - Click to let AI write for your persona') %>">
          <span class="text-xs font-medium"><%= t("copilot.auto", default: "Auto") %></span>
          <span class="font-mono" data-copilot-target="stepsCounter"><%= copilot_steps_display %></span>
        </button>
      <% end %>

      <%# Row 2: Generate suggestions (for persona users) %>
      <% if has_persona && !space_read_only %>
        <div class="dropdown dropdown-top dropdown-end flex-1 sm:flex-none sm:w-full"
             data-copilot-target="countBtn">
          <button type="button"
                  tabindex="0"
                  class="btn btn-secondary btn-sm w-full gap-1"
                  data-copilot-target="generateBtn"
                  <%= "disabled" if copilot_full %>
                  title="<%= t('copilot.generate_title', default: 'Generate AI suggestions') %>">
            <span class="icon-[lucide--sparkles] size-4" data-copilot-target="generateIcon"></span>
            <span class="loading loading-spinner loading-xs hidden" data-copilot-target="generateSpinner"></span>
            <span data-copilot-target="generateText"><%= t("copilot.vibe", default: "Vibe") %></span>
          </button>
          <ul class="dropdown-content menu bg-base-100/95 backdrop-blur-sm rounded-box w-full p-1 shadow-lg border border-base-300 z-10">
            <li><button type="button" class="justify-center text-xs" data-action="copilot#generateWithCount" data-count="1">1</button></li>
            <li><button type="button" class="justify-center text-xs" data-action="copilot#generateWithCount" data-count="2">2</button></li>
            <li><button type="button" class="justify-center text-xs" data-action="copilot#generateWithCount" data-count="3">3</button></li>
            <li><button type="button" class="justify-center text-xs" data-action="copilot#generateWithCount" data-count="4">4</button></li>
          </ul>
        </div>
      <% end %>

      <%# Row 3: Send button %>
      <button type="submit"
              class="btn btn-primary btn-sm flex-1 sm:flex-none sm:w-full gap-1"
              data-message-form-target="sendBtn"
              <%= "disabled" if input_disabled %>>
        <span class="icon-[lucide--send] size-4"></span>
        <%= t("messages.send", default: "Send") %>
      </button>

      <%# Row 4: Preview Prompt button %>
      <button type="button"
              class="btn btn-ghost btn-sm flex-1 sm:flex-none sm:w-full gap-1"
              data-action="prompt-preview#preview"
              data-prompt-preview-target="previewBtn"
              <%= "disabled" if space_read_only %>
              title="<%= t('messages.preview_prompt_title', default: 'Preview the prompt that will be sent to the LLM') %>">
        <span class="icon-[lucide--eye] size-4"></span>
        <%= t("messages.preview", default: "Preview") %>
      </button>
    </div>
  <% end %>

  <%# Prompt Preview Modal %>
  <dialog class="modal" data-prompt-preview-target="modal">
    <div class="modal-box max-w-4xl max-h-[85vh] flex flex-col">
      <div class="flex items-center justify-between mb-4">
        <h3 class="font-bold text-lg flex items-center gap-2">
          <span class="icon-[lucide--file-text] size-5"></span>
          <%= t("messages.prompt_preview", default: "Prompt Preview") %>
        </h3>
        <form method="dialog">
          <button class="btn btn-ghost btn-sm btn-circle">
            <span class="icon-[lucide--x] size-4"></span>
          </button>
        </form>
      </div>

      <div class="flex-1 min-h-0" data-prompt-preview-target="content">
        <%# Content will be loaded dynamically %>
        <div class="flex items-center justify-center py-12">
          <span class="loading loading-spinner loading-lg text-base-content/30"></span>
        </div>
      </div>
    </div>
    <form method="dialog" class="modal-backdrop">
      <button>close</button>
    </form>
  </dialog>
<% end %>
