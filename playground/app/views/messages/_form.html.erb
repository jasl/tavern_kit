<%# Message composer form %>
<%# locals: (conversation:, space:, message:) %>
<%
  space_read_only = !space.active?
  user_membership = space.space_memberships.active.find_by(user: Current.user, kind: "human")
  auto_capable = user_membership&.auto_capable?
  auto_enabled = user_membership&.auto_enabled?
  turn_state = TurnScheduler.state(conversation)

  # Input policy: reject policy locks input during AI generation
  reject_policy = space.during_generation_user_input_policy_reject?
  is_ai_generating = turn_state.ai_generating?
  generation_locked = reject_policy && is_ai_generating

  # Hard lock: user cannot send messages at all
  # - space_read_only: archived/inactive space
  # - generation_locked: reject policy + AI generating
  #
  # Soft lock (Auto): user CAN type to auto-disable
  # See: docs/spec/SILLYTAVERN_DIVERGENCES.md "User input always takes priority"
  input_disabled = space_read_only || generation_locked

  # Display remaining steps:
  # - When Auto is ON: show actual remaining steps
  # - When Auto is OFF: show default steps (what user will get when enabling)
  auto_steps_display = auto_enabled ?
    user_membership.auto_remaining_steps :
    SpaceMembership::DEFAULT_AUTO_STEPS
  textarea_actions = [
    "keydown->message-form#handleKeydown",
    "input->message-form#handleInput",
    (auto_capable ? "input->auto#handleInput" : nil)
  ].compact.join(" ")
  is_group = space.group?
%>

<%= tag.div id: "message_form",
            class: "p-1 border-t border-base-300 bg-base-100",
            data: {
              controller: ["message-form", auto_capable ? "auto" : nil, "prompt-preview"].compact.join(" "),
              # Message form controller values for dynamic input locking (hard lock only)
              # Note: Auto is a soft lock - user can type to auto-disable it
              message_form_conversation_id_value: conversation.id,
              message_form_reject_policy_value: reject_policy,
              message_form_scheduling_state_value: turn_state.scheduling_state,
              message_form_space_read_only_value: space_read_only,
              # Auto controller values
              auto_url_value: auto_capable ? playground_auto_candidates_path(space) : nil,
              auto_auto_value: auto_capable ? auto_enabled : nil,
              auto_membership_id_value: auto_capable ? user_membership&.id : nil,
              auto_membership_update_url_value: auto_capable ? playground_membership_path(space, user_membership) : nil,
              prompt_preview_url_value: playground_prompt_preview_path(space)
            }.compact do %>

  <%# Disconnected alert - shown when WebSocket connection is lost %>
  <div id="cable_disconnect_alert"
       class="alert alert-error mb-3 text-sm hidden"
       data-message-form-target="cableDisconnectAlert">
    <span class="icon-[lucide--wifi-off] size-5 shrink-0"></span>
    <span>
      <%= t("messages.errors.disconnected", default: "Disconnected. Reconnectingâ€¦") %>
    </span>
    <button type="button"
            class="btn btn-sm btn-error"
            data-action="message-form#reloadPage">
      <span class="icon-[lucide--refresh-cw] size-4"></span>
      <%= t("messages.reload", default: "Reload") %>
    </button>
  </div>

  <%# Error alert - shown when a run fails and blocks progress %>
  <div id="run_error_alert"
       class="alert alert-error mb-3 text-sm hidden"
       data-conversation-channel-target="runErrorAlert">
    <span class="icon-[lucide--alert-circle] size-5 shrink-0"></span>
    <span data-conversation-channel-target="runErrorMessage">
      <%= t("messages.errors.run_failed", default: "AI response failed. Click Retry to try again. Sending a new message will reset the round (Auto without human/Auto will be turned off).") %>
    </span>
    <button type="button"
            class="btn btn-sm btn-error"
            data-action="conversation-channel#retryFailedRun">
      <span class="icon-[lucide--refresh-cw] size-4"></span>
      <%= t("messages.retry", default: "Retry") %>
    </button>
  </div>

  <%# Idle alert - shown when conversation should be active but no run exists %>
  <div id="idle_alert"
       class="alert alert-warning mb-3 text-sm hidden"
       data-conversation-channel-target="idleAlert">
    <span class="icon-[lucide--alert-triangle] size-5 shrink-0"></span>
    <span data-conversation-channel-target="idleAlertMessage">
      <%= t("messages.errors.idle_unexpected", default: "Conversation seems stuck. No AI is responding.") %>
    </span>
    <span class="hidden" data-conversation-channel-target="idleAlertSpeaker" data-speaker-id=""></span>
    <button type="button"
            class="btn btn-sm btn-warning"
            data-action="conversation-channel#generateFromIdleAlert">
      <span class="icon-[lucide--play] size-4"></span>
      <%= t("messages.generate", default: "Generate") %>
    </button>
  </div>

  <%# Stop decision alert - shown after user Stop (Retry / Skip current speaker) %>
  <div id="stop_decision_alert"
       class="alert alert-info mb-3 text-sm hidden"
       data-conversation-channel-target="stopDecisionAlert">
    <span class="icon-[lucide--square] size-5 shrink-0"></span>
    <span data-conversation-channel-target="stopDecisionMessage">
      <%= t("messages.stop_decision", default: "Stopped. Choose how to continue:") %>
    </span>
    <button type="button"
            class="btn btn-sm btn-info"
            data-action="conversation-channel#retryFromStopDecision">
      <span class="icon-[lucide--refresh-cw] size-4"></span>
      <%= t("messages.retry", default: "Retry") %>
    </button>
    <button type="button"
            class="btn btn-sm btn-ghost"
            data-action="conversation-channel#skipFromStopDecision">
      <span class="icon-[lucide--skip-forward] size-4"></span>
      <%= t("messages.skip", default: "Skip") %>
    </button>
  </div>

  <%# Token limit exceeded warning %>
  <% if space.token_limit_exceeded? %>
    <div id="token_limit_alert"
         class="alert alert-warning mb-3 text-sm">
      <span class="icon-[lucide--alert-triangle] size-5 shrink-0"></span>
      <span>
        <%= t("messages.errors.token_limit_exceeded",
              used: number_with_delimiter(space.total_tokens_used),
              limit: number_with_delimiter(space.effective_token_limit),
              default: "Token limit reached (%{used} / %{limit}). Generation is blocked.") %>
      </span>
      <%= link_to edit_playground_path(space),
                  class: "btn btn-sm btn-warning" do %>
        <span class="icon-[lucide--settings] size-4"></span>
        <%= t("messages.adjust_limit", default: "Adjust Limit") %>
      <% end %>
    </div>
  <% end %>

  <% if space.archived? %>
    <div class="alert alert-warning mb-3 text-sm">
      <span class="icon-[lucide--archive] size-4"></span>
      <span><%= t("spaces.archived_read_only", default: "This chat is archived and read-only.") %></span>
    </div>
  <% elsif space.deleting? %>
    <div class="alert alert-warning mb-3 text-sm">
      <span class="icon-[lucide--trash-2] size-4"></span>
      <span><%= t("spaces.deleting_read_only", default: "This chat is being deleted and is temporarily unavailable.") %></span>
    </div>
  <% end %>

  <%# Auto suggestions area - above the form %>
  <% if auto_capable %>
    <div data-auto-target="candidatesContainer" class="hidden mb-3">
      <div class="flex items-center gap-2 mb-2">
        <span class="text-xs text-base-content/60 font-medium">
          <span class="icon-[lucide--sparkles] size-3 mr-1"></span>
          <%= t("auto.suggestions", default: "Suggestions") %>
        </span>
        <button type="button" class="btn btn-ghost btn-xs btn-circle" data-action="auto#clearCandidates" title="<%= t('auto.clear', default: 'Clear') %>">
          <span class="icon-[lucide--x] size-3"></span>
        </button>
      </div>

      <%# Loading indicator - hidden by default, shown during generation %>
      <div data-auto-target="loadingIndicator" class="hidden flex items-center gap-2 p-3 bg-base-200 rounded-lg">
        <span class="loading loading-dots loading-sm text-secondary"></span>
        <span class="text-sm text-base-content/70"><%= t("auto.generating", default: "Generating suggestions...") %></span>
      </div>

      <%# Error indicator %>
      <div data-auto-target="errorIndicator" class="hidden">
        <div class="alert alert-error text-sm">
          <span class="icon-[lucide--alert-circle] size-4 shrink-0"></span>
          <span data-auto-target="errorMessage"><%= t("auto.generation_failed", default: "Generation failed") %></span>
          <button type="button" class="btn btn-ghost btn-xs" data-action="auto#retryGenerate">
            <span class="icon-[lucide--refresh-cw] size-3"></span>
            <%= t("auto.retry", default: "Retry") %>
          </button>
        </div>
      </div>

      <div class="flex flex-col gap-y-1 max-h-40 overflow-y-auto" data-auto-target="candidatesList">
        <%# Candidates inserted here dynamically %>
      </div>
    </div>
  <% end %>

  <%# Group chat queue display - shows speaker queue and group settings %>
  <% if is_group %>
    <% presenter = GroupQueuePresenter.new(conversation: conversation, space: space) %>
    <%= render "messages/group_queue", presenter: presenter %>
  <% end %>

  <%= form_with url: conversation_messages_path(conversation),
                scope: :message,
                data: {
                  turbo_stream: true,
                  auto_target: "form"
                },
                class: "flex flex-col sm:flex-row sm:items-center gap-2 sm:gap-1" do |f| %>

    <%# Text input area %>
    <div class="flex-1 min-w-0 order-1 sm:order-0">
      <%
        # Determine placeholder based on state
        placeholder_text = if generation_locked
          t("messages.generation_locked_placeholder", default: "Waiting for AI response...")
        elsif auto_enabled
          t("auto.placeholder", default: "Auto is writing for your persona...")
        else
          t("messages.placeholder", default: "Type your message...")
        end
      %>
      <%= f.text_area :content,
                      rows: 5,
                      placeholder: placeholder_text,
                      class: "textarea textarea-bordered w-full resize-none min-h-[152px]",
                      disabled: input_disabled,
                      data: {
                        action: textarea_actions,
                        auto_target: "textarea",
                        message_form_target: "textarea",
                        chat_hotkeys_target: "textarea",
                        prompt_preview_target: "textarea",
                        default_placeholder: t("messages.placeholder", default: "Type your message..."),
                        locked_placeholder: t("messages.generation_locked_placeholder", default: "Waiting for AI response...")
                      },
                      autofocus: !input_disabled %>
    </div>

    <%# Action buttons - horizontal on mobile, vertical on desktop %>
    <div class="flex flex-row sm:flex-col gap-1.5 shrink-0 sm:w-24 order-2 sm:order-0">
      <%# Row 1: Auto toggle (for persona users) - Auto for human persona %>
      <% if auto_capable && !space_read_only %>
        <button type="button"
                class="btn btn-sm flex-1 sm:flex-none sm:w-full gap-1 <%= auto_enabled ? 'btn-success' : 'btn-ghost' %>"
                data-auto-target="autoToggle"
                data-action="click->auto#toggleAutoMode"
                data-auto-default-steps="<%= SpaceMembership::DEFAULT_AUTO_STEPS %>"
                title="<%= auto_enabled ?
                  t('auto.enabled_hint', default: 'Auto ON - AI writes for your persona. Click to disable') :
                  t('auto.disabled_hint', default: 'Auto OFF - Click to let AI write for your persona') %>">
          <span class="text-xs font-medium"><%= t("auto.auto", default: "Auto") %></span>
          <span class="font-mono" data-auto-target="stepsCounter"><%= auto_steps_display %></span>
        </button>
      <% end %>

      <%# Row 2: Generate suggestions (for persona users) %>
      <% if auto_capable && !space_read_only %>
        <div class="dropdown dropdown-top dropdown-end flex-1 sm:flex-none sm:w-full"
             data-auto-target="countBtn">
          <button type="button"
                  tabindex="0"
                  class="btn btn-secondary btn-sm w-full gap-1"
                  data-auto-target="generateBtn"
                  <%= "disabled" if auto_enabled %>
                  title="<%= t('auto.generate_title', default: 'Generate AI suggestions') %>">
            <span class="icon-[lucide--sparkles] size-4" data-auto-target="generateIcon"></span>
            <span class="loading loading-spinner loading-xs hidden" data-auto-target="generateSpinner"></span>
            <span data-auto-target="generateText"><%= t("auto.vibe", default: "Vibe") %></span>
          </button>
          <ul class="dropdown-content menu bg-base-100/95 backdrop-blur-sm rounded-box w-full p-1 shadow-lg border border-base-300 z-10">
            <li><button type="button" class="justify-center text-xs" data-action="auto#generateWithCount" data-count="1">1</button></li>
            <li><button type="button" class="justify-center text-xs" data-action="auto#generateWithCount" data-count="2">2</button></li>
            <li><button type="button" class="justify-center text-xs" data-action="auto#generateWithCount" data-count="3">3</button></li>
            <li><button type="button" class="justify-center text-xs" data-action="auto#generateWithCount" data-count="4">4</button></li>
          </ul>
        </div>
      <% end %>

      <%# Row 3: Send button %>
      <button type="submit"
              class="btn btn-primary btn-sm flex-1 sm:flex-none sm:w-full gap-1"
              data-message-form-target="sendBtn"
              <%= "disabled" if input_disabled %>>
        <span class="icon-[lucide--send] size-4"></span>
        <%= t("messages.send", default: "Send") %>
      </button>

      <%# Row 4: Stop button (stable; avoids scrolling jank) %>
      <button type="button"
              class="btn btn-ghost btn-sm flex-1 sm:flex-none sm:w-full gap-1 <%= turn_state.ai_generating? ? "" : "hidden" %>"
              data-message-form-target="stopBtn"
              data-action="click->chat-hotkeys#stop"
              title="<%= t('messages.stop_generate', default: 'Stop generating') %>">
        <span class="icon-[lucide--square] size-4"></span>
        <%= t("messages.stop", default: "Stop") %>
      </button>

      <%# Row 5: Preview Prompt button %>
      <button type="button"
              class="btn btn-ghost btn-sm flex-1 sm:flex-none sm:w-full gap-1"
              data-action="prompt-preview#preview"
              data-prompt-preview-target="previewBtn"
              <%= "disabled" if space_read_only %>
              title="<%= t('messages.preview_prompt_title', default: 'Preview the prompt that will be sent to the LLM') %>">
        <span class="icon-[lucide--eye] size-4"></span>
        <%= t("messages.preview", default: "Preview") %>
      </button>
    </div>
  <% end %>

  <%# Prompt Preview Modal %>
  <dialog class="modal" data-prompt-preview-target="modal">
    <div class="modal-box max-w-4xl max-h-[85vh] flex flex-col">
      <div class="flex items-center justify-between mb-4">
        <h3 class="font-bold text-lg flex items-center gap-2">
          <span class="icon-[lucide--file-text] size-5"></span>
          <%= t("messages.prompt_preview", default: "Prompt Preview") %>
        </h3>
        <form method="dialog">
          <button class="btn btn-ghost btn-sm btn-circle">
            <span class="icon-[lucide--x] size-4"></span>
          </button>
        </form>
      </div>

      <div class="flex-1 min-h-0" data-prompt-preview-target="content">
        <%# Content will be loaded dynamically %>
        <div class="flex items-center justify-center py-12">
          <span class="loading loading-spinner loading-lg text-base-content/30"></span>
        </div>
      </div>
    </div>
    <form method="dialog" class="modal-backdrop">
      <button>close</button>
    </form>
  </dialog>
<% end %>
