<% content_for :title, t("characters.edit.title", default: "Edit Character") %>

<%
  schema = SettingsSchemaPack.bundle
  fields = LLMSettings::FieldEnumerator.new(schema: schema).character_fields(character: @character)
%>

<div class="space-y-6">
  <!-- Breadcrumbs -->
  <div class="breadcrumbs text-sm">
    <ul>
      <li>
        <%= link_to settings_characters_path do %>
          <span class="icon-[lucide--users] size-4 mr-1"></span>
          <%= t("characters.index.title", default: "Characters") %>
        <% end %>
      </li>
      <li>
        <%= link_to @character.name.truncate(20), settings_character_path(@character) %>
      </li>
      <li><%= t("common.edit", default: "Edit") %></li>
    </ul>
  </div>

  <!-- Character Info Header -->
  <div class="flex items-start justify-between gap-4">
    <div class="space-y-1">
      <h1 class="text-2xl font-bold leading-tight flex items-center gap-3">
        <%= @character.name %>
        <% if @character.spec_version.present? %>
          <span class="badge badge-sm <%= @character.v3? ? 'badge-primary' : 'badge-ghost' %>">
            <%= @character.v3? ? "CCv3" : "CCv2" %>
          </span>
        <% end %>
      </h1>
      <p class="text-sm text-base-content/60">
        <%= t("characters.edit.description", default: "Edit character card settings and Author's Note configuration.") %>
      </p>
    </div>

    <div class="shrink-0">
      <div class="avatar">
        <div class="w-16 rounded-xl bg-base-200">
          <%= image_tag fresh_character_portrait_path(@character), class: "object-cover", alt: @character.name %>
        </div>
      </div>
    </div>
  </div>

  <!-- Character Card Settings -->
  <div class="card bg-base-100 shadow-sm border border-base-300"
       data-controller="schema-renderer settings-form tabs"
       data-action="tabs:changed->schema-renderer#tabChanged"
       data-settings-form-url-value="<%= settings_character_path(@character) %>"
       data-settings-form-resource-key-value="character"
       data-settings-form-schema-version-value="character_v1"
       data-settings-form-debounce-value="300"
       data-tabs-default-value="quick">
    <div class="card-body p-0">
      <div class="p-4 border-b border-base-300">
        <h2 class="card-title text-lg flex items-center gap-2">
          <span class="icon-[lucide--user-cog] size-5"></span>
          <%= t("characters.edit.card_settings", default: "Character Card Settings") %>
        </h2>
        <p class="text-sm text-base-content/60 mt-1">
          <%= t("characters.edit.card_settings_hint", default: "Edit the character's name, description, personality, and other card fields. Changes are auto-saved.") %>
        </p>
      </div>

      <%# Tabs %>
      <div role="tablist" class="tabs tabs-box bg-base-200 rounded-none border-b border-base-300">
        <button role="tab" class="tab tab-active" data-tabs-target="tab" data-tab="quick" data-action="click->tabs#select">
          <span class="icon-[lucide--zap] size-4 mr-1"></span>
          <%= t("settings.quick", default: "Quick") %>
        </button>
        <button role="tab" class="tab" data-tabs-target="tab" data-tab="advanced" data-action="click->tabs#select">
          <span class="icon-[lucide--sliders-horizontal] size-4 mr-1"></span>
          <%= t("settings.advanced", default: "Advanced") %>
        </button>
      </div>

      <div class="p-4 space-y-4">
        <div data-tabs-target="panel" data-tab="quick" class="space-y-4">
          <p class="text-sm text-base-content/60 border-l-2 border-primary pl-3">
            <%= t("characters.edit.quick_hint", default: "Common settings for quick adjustments. These fields are most frequently edited.") %>
          </p>
          <div data-schema-renderer-target="quick" class="space-y-4"></div>
        </div>

        <div data-tabs-target="panel" data-tab="advanced" class="hidden space-y-4">
          <p class="text-sm text-base-content/60 border-l-2 border-secondary pl-3">
            <%= t("characters.edit.advanced_hint", default: "All available character card fields including technical settings and extended options.") %>
          </p>
          <div data-schema-renderer-target="advanced" class="space-y-4"></div>
        </div>

        <%# Field pool %>
        <div data-schema-renderer-target="pool" class="hidden">
          <% fields.each do |field| %>
            <%
              control = field[:control].to_s
              partial = case control
              when "range", "slider" then "settings/fields/range"
              when "number" then "settings/fields/number"
              when "toggle" then "settings/fields/toggle"
              when "select" then "settings/fields/select"
              when "text" then "settings/fields/text"
              when "textarea" then "settings/fields/textarea"
              when "tags" then "settings/fields/tags"
              else
                if field[:type] == "boolean"
                  "settings/fields/toggle"
                elsif field[:enum].present?
                  "settings/fields/select"
                elsif field[:type].in?(%w[number integer])
                  "settings/fields/number"
                else
                  "settings/fields/text"
                end
              end
            %>
            <%= render partial, field: field %>
          <% end %>
        </div>
      </div>

      <div class="p-3 border-t border-base-300 bg-base-100 flex items-center justify-between text-xs rounded-b-2xl">
        <div class="flex items-center gap-2 text-base-content/50">
          <span class="icon-[lucide--save] size-3"></span>
          <span><%= t("settings.auto_save", default: "Auto-save enabled") %></span>
        </div>
        <div class="flex items-center gap-2">
          <span class="badge badge-sm badge-ghost" data-settings-form-target="status"></span>
          <span class="text-base-content/40" data-settings-form-target="savedAt"></span>
        </div>
      </div>
    </div>
  </div>

  <%# Author's Note Settings Card %>
  <%
    an_settings = @character.effective_authors_note_settings
  %>
  <div class="card bg-base-100 shadow-sm border border-base-300"
       data-controller="authors-note-form"
       data-authors-note-form-url-value="<%= settings_character_path(@character) %>"
       data-authors-note-form-debounce-value="500">
    <div class="card-body">
      <h2 class="card-title text-lg flex items-center gap-2">
        <span class="icon-[lucide--pen-line] size-5"></span>
        <%= t("characters.authors_note.title", default: "Author's Note") %>
      </h2>
      <p class="text-sm text-base-content/60 mb-4">
        <%= t("characters.authors_note.description", default: "Default Author's Note settings for this character. Can be overridden per-space or per-conversation.") %>
      </p>

      <div class="space-y-6">
        <%# Enable toggle %>
        <div class="form-control">
          <label class="label cursor-pointer justify-start gap-3">
            <input type="checkbox"
                   class="toggle toggle-primary"
                   <%= "checked" if an_settings["use_character_authors_note"] == true %>
                   data-authors-note-form-target="enableToggle"
                   data-action="change->authors-note-form#save" />
            <div>
              <span class="label-text font-medium"><%= t("characters.authors_note.enable", default: "Enable Character Author's Note") %></span>
              <p class="text-xs text-base-content/50">
                <%= t("characters.authors_note.enable_hint", default: "When enabled, this AN will be included in prompts") %>
              </p>
            </div>
          </label>
        </div>

        <%# Author's Note content %>
        <div class="form-control">
          <label class="label py-1">
            <span class="label-text font-medium"><%= t("characters.authors_note.content", default: "Content") %></span>
          </label>
          <textarea class="textarea textarea-bordered w-full h-32 font-mono text-sm"
                    placeholder="<%= t("characters.authors_note.placeholder", default: "[Write in a vivid, descriptive style...]") %>"
                    data-authors-note-form-target="content"
                    data-action="input->authors-note-form#debounceSave"><%= an_settings["authors_note"] %></textarea>
          <div class="flex justify-between mt-1">
            <span class="label-text-alt text-base-content/50">
              <%= t("characters.authors_note.content_hint", default: "Supports macros like {{char}} and {{user}}. Injected into the prompt to guide AI behavior.") %>
            </span>
            <span class="label-text-alt text-base-content/50" data-authors-note-form-target="charCount">
              <%= (an_settings["authors_note"] || "").length %> <%= t("common.chars", default: "chars") %>
            </span>
          </div>
        </div>

        <%# Settings row %>
        <div class="grid grid-cols-1 sm:grid-cols-3 gap-6">
          <%# Position %>
          <div class="form-control">
            <label class="label py-1">
              <span class="label-text font-medium"><%= t("characters.authors_note.position", default: "Position") %></span>
            </label>
            <select class="select select-bordered w-full"
                    data-authors-note-form-target="position"
                    data-action="change->authors-note-form#save">
              <option value="in_chat" <%= "selected" if an_settings["authors_note_position"] == "in_chat" || an_settings["authors_note_position"].blank? %>>
                <%= t("characters.authors_note.in_chat", default: "In Chat (at depth)") %>
              </option>
              <option value="in_prompt" <%= "selected" if an_settings["authors_note_position"] == "in_prompt" %>>
                <%= t("characters.authors_note.in_prompt", default: "After Scenario") %>
              </option>
              <option value="before_prompt" <%= "selected" if an_settings["authors_note_position"] == "before_prompt" %>>
                <%= t("characters.authors_note.before_prompt", default: "Before Scenario") %>
              </option>
            </select>
            <label class="label py-0.5">
              <span class="label-text-alt text-base-content/50"><%= t("characters.authors_note.position_hint", default: "Where in the prompt to insert the AN.") %></span>
            </label>
          </div>

          <%# Depth %>
          <div class="form-control">
            <label class="label py-1">
              <span class="label-text font-medium"><%= t("characters.authors_note.depth", default: "Depth") %></span>
            </label>
            <input type="number"
                   class="input input-bordered w-full"
                   min="0"
                   max="100"
                   value="<%= an_settings["authors_note_depth"] || 4 %>"
                   data-authors-note-form-target="depth"
                   data-action="change->authors-note-form#save" />
            <label class="label py-0.5">
              <span class="label-text-alt text-base-content/50"><%= t("characters.authors_note.depth_hint", default: "0 = end of chat, 4 = before last 4 messages.") %></span>
            </label>
          </div>

          <%# Role %>
          <div class="form-control">
            <label class="label py-1">
              <span class="label-text font-medium"><%= t("characters.authors_note.role", default: "Role") %></span>
            </label>
            <select class="select select-bordered w-full"
                    data-authors-note-form-target="role"
                    data-action="change->authors-note-form#save">
              <option value="system" <%= "selected" if an_settings["authors_note_role"] == "system" || an_settings["authors_note_role"].blank? %>>System</option>
              <option value="user" <%= "selected" if an_settings["authors_note_role"] == "user" %>>User</option>
              <option value="assistant" <%= "selected" if an_settings["authors_note_role"] == "assistant" %>>Assistant</option>
            </select>
            <label class="label py-0.5">
              <span class="label-text-alt text-base-content/50"><%= t("characters.authors_note.role_hint", default: "Message role when injected into chat.") %></span>
            </label>
          </div>
        </div>

        <%# Combine mode %>
        <div class="form-control">
          <label class="label py-1">
            <span class="label-text font-medium"><%= t("characters.authors_note.combine_mode", default: "Space AN Combine Mode") %></span>
          </label>
          <select class="select select-bordered w-full"
                  data-authors-note-form-target="combineMode"
                  data-action="change->authors-note-form#save">
            <option value="replace" <%= "selected" if an_settings["character_authors_note_position"] == "replace" || an_settings["character_authors_note_position"].blank? %>>
              <%= t("characters.authors_note.replace", default: "Replace space-level AN") %>
            </option>
            <option value="before" <%= "selected" if an_settings["character_authors_note_position"] == "before" %>>
              <%= t("characters.authors_note.before", default: "Prepend to space-level AN") %>
            </option>
            <option value="after" <%= "selected" if an_settings["character_authors_note_position"] == "after" %>>
              <%= t("characters.authors_note.after", default: "Append to space-level AN") %>
            </option>
          </select>
          <label class="label py-0.5">
            <span class="label-text-alt text-base-content/50">
              <%= t("characters.authors_note.combine_hint", default: "How to combine with space-level Author's Note when both are present.") %>
            </span>
          </label>
        </div>
      </div>

      <%# Status footer %>
      <div class="mt-4 pt-3 border-t border-base-300 flex items-center justify-between text-xs">
        <div class="flex items-center gap-2 text-base-content/50">
          <span class="icon-[lucide--save] size-3"></span>
          <span><%= t("settings.auto_save", default: "Auto-save enabled") %></span>
        </div>
        <div class="flex items-center gap-2">
          <span class="badge badge-sm badge-ghost" data-authors-note-form-target="status"></span>
          <span class="text-base-content/40" data-authors-note-form-target="savedAt"></span>
        </div>
      </div>
    </div>
  </div>
</div>
