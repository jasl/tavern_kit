<% content_for :title, t("characters.edit.title", default: "Edit Character") %>

<div class="space-y-6">
  <!-- Breadcrumbs -->
  <div class="breadcrumbs text-sm">
    <ul>
      <li>
        <%= link_to settings_characters_path do %>
          <span class="icon-[lucide--users] size-4 mr-1"></span>
          <%= t("characters.index.title", default: "Characters") %>
        <% end %>
      </li>
      <li><%= @character.name.truncate(30) %></li>
    </ul>
  </div>

  <%= form_with model: @character, url: settings_character_path(@character), method: :patch, class: "space-y-6" do |f| %>
    <!-- Basic Info Card -->
    <div class="card bg-base-100 shadow-sm border border-base-300">
      <div class="card-body">
        <div class="flex items-start gap-6">
          <!-- Portrait -->
          <div class="shrink-0">
            <figure class="w-24 h-32 relative overflow-hidden rounded-xl bg-base-200">
              <%= image_tag fresh_character_portrait_path(@character),
                            class: "w-full h-full object-cover",
                            alt: @character.name %>
              <div class="absolute top-2 right-2">
                <span class="badge badge-xs <%= @character.v3? ? 'badge-primary' : 'badge-ghost' %>">
                  <%= @character.v3? ? "CCv3" : "CCv2" %>
                </span>
              </div>
            </figure>
          </div>

          <!-- Basic Fields -->
          <div class="flex-1 space-y-4">
            <h2 class="card-title">
              <span class="icon-[lucide--user] size-5"></span>
              <%= t("characters.edit.basic_info", default: "Basic Info") %>
            </h2>

            <!-- Name -->
            <div class="form-control">
              <label class="label py-1">
                <span class="label-text font-medium"><%= t("characters.form.name", default: "Name") %> <span class="text-error">*</span></span>
              </label>
              <%= f.text_field :name, class: "input input-bordered w-full", required: true %>
              <label class="label py-0.5">
                <span class="label-text-alt text-base-content/50"><%= t("characters.form.name_hint", default: "The character's display name") %></span>
              </label>
            </div>

            <!-- Nickname -->
            <div class="form-control">
              <label class="label py-1">
                <span class="label-text font-medium"><%= t("characters.form.nickname", default: "Nickname") %></span>
              </label>
              <%= f.text_field :nickname, class: "input input-bordered w-full" %>
              <label class="label py-0.5">
                <span class="label-text-alt text-base-content/50"><%= t("characters.form.nickname_hint", default: "Optional alternative name or alias") %></span>
              </label>
            </div>
          </div>
        </div>

        <!-- Metadata display (read-only) -->
        <div class="divider my-2"></div>
        <div class="flex flex-wrap gap-4 text-sm text-base-content/50">
          <% if @character.creator.present? %>
            <div class="flex items-center gap-1">
              <span class="icon-[lucide--pen-tool] size-4"></span>
              <span><%= @character.creator %></span>
            </div>
          <% end %>
          <% if @character.character_version.present? %>
            <div class="flex items-center gap-1">
              <span class="icon-[lucide--git-branch] size-4"></span>
              <span><%= @character.character_version %></span>
            </div>
          <% end %>
          <% if @character.tags.any? %>
            <div class="flex items-center gap-1">
              <span class="icon-[lucide--tags] size-4"></span>
              <span><%= @character.tags.first(3).join(", ") %><%= "+#{@character.tags.size - 3}" if @character.tags.size > 3 %></span>
            </div>
          <% end %>
        </div>
      </div>
    </div>

    <!-- Author's Note Card -->
    <% an_settings = @character.effective_authors_note_settings %>
    <div class="card bg-base-100 shadow-sm border border-base-300">
      <div class="card-body">
        <h2 class="card-title">
          <span class="icon-[lucide--pen-line] size-5"></span>
          <%= t("characters.authors_note.title", default: "Author's Note") %>
        </h2>
        <p class="text-sm text-base-content/60 mb-4">
          <%= t("characters.authors_note.description", default: "Default Author's Note settings for this character. Can be overridden per-space or per-conversation.") %>
        </p>

        <div class="space-y-6">
          <!-- Enable toggle -->
          <div class="form-control">
            <label class="label cursor-pointer justify-start gap-3">
              <%= f.check_box "authors_note_settings[use_character_authors_note]",
                              { class: "toggle toggle-primary", checked: an_settings["use_character_authors_note"] == true },
                              "1", "0" %>
              <div>
                <span class="label-text font-medium"><%= t("characters.authors_note.enable", default: "Enable Character Author's Note") %></span>
                <p class="text-xs text-base-content/50">
                  <%= t("characters.authors_note.enable_hint", default: "When enabled, this AN will be included in prompts") %>
                </p>
              </div>
            </label>
          </div>

          <!-- Content -->
          <div class="form-control">
            <label class="label py-1">
              <span class="label-text font-medium"><%= t("characters.authors_note.content", default: "Content") %></span>
            </label>
            <%= f.text_area "authors_note_settings[authors_note]",
                            value: an_settings["authors_note"],
                            class: "textarea textarea-bordered w-full h-32 font-mono text-sm",
                            placeholder: t("characters.authors_note.placeholder", default: "[Write in a vivid, descriptive style...]") %>
            <label class="label py-0.5">
              <span class="label-text-alt text-base-content/50">
                <%= t("characters.authors_note.content_hint", default: "Supports macros like {{char}} and {{user}}. Injected into the prompt to guide AI behavior.") %>
              </span>
            </label>
          </div>

          <!-- Settings row -->
          <div class="grid grid-cols-1 sm:grid-cols-3 gap-6">
            <!-- Position -->
            <div class="form-control">
              <label class="label py-1">
                <span class="label-text font-medium"><%= t("characters.authors_note.position", default: "Position") %></span>
              </label>
              <%= f.select "authors_note_settings[authors_note_position]",
                           options_for_select([
                             [t("characters.authors_note.in_chat", default: "In Chat (at depth)"), "in_chat"],
                             [t("characters.authors_note.in_prompt", default: "After Scenario"), "in_prompt"],
                             [t("characters.authors_note.before_prompt", default: "Before Scenario"), "before_prompt"]
                           ], an_settings["authors_note_position"] || "in_chat"),
                           {}, class: "select select-bordered w-full" %>
              <label class="label py-0.5">
                <span class="label-text-alt text-base-content/50"><%= t("characters.authors_note.position_hint", default: "Where in the prompt to insert the AN.") %></span>
              </label>
            </div>

            <!-- Depth -->
            <div class="form-control">
              <label class="label py-1">
                <span class="label-text font-medium"><%= t("characters.authors_note.depth", default: "Depth") %></span>
              </label>
              <%= f.number_field "authors_note_settings[authors_note_depth]",
                                 value: an_settings["authors_note_depth"] || 4,
                                 class: "input input-bordered w-full",
                                 min: 0, max: 100 %>
              <label class="label py-0.5">
                <span class="label-text-alt text-base-content/50"><%= t("characters.authors_note.depth_hint", default: "0 = end of chat, 4 = before last 4 messages.") %></span>
              </label>
            </div>

            <!-- Role -->
            <div class="form-control">
              <label class="label py-1">
                <span class="label-text font-medium"><%= t("characters.authors_note.role", default: "Role") %></span>
              </label>
              <%= f.select "authors_note_settings[authors_note_role]",
                           options_for_select([
                             ["System", "system"],
                             ["User", "user"],
                             ["Assistant", "assistant"]
                           ], an_settings["authors_note_role"] || "system"),
                           {}, class: "select select-bordered w-full" %>
              <label class="label py-0.5">
                <span class="label-text-alt text-base-content/50"><%= t("characters.authors_note.role_hint", default: "Message role when injected into chat.") %></span>
              </label>
            </div>
          </div>

          <!-- Combine mode -->
          <div class="form-control">
            <label class="label py-1">
              <span class="label-text font-medium"><%= t("characters.authors_note.combine_mode", default: "Space AN Combine Mode") %></span>
            </label>
            <%= f.select "authors_note_settings[character_authors_note_position]",
                         options_for_select([
                           [t("characters.authors_note.replace", default: "Replace space-level AN"), "replace"],
                           [t("characters.authors_note.before", default: "Prepend to space-level AN"), "before"],
                           [t("characters.authors_note.after", default: "Append to space-level AN"), "after"]
                         ], an_settings["character_authors_note_position"] || "replace"),
                         {}, class: "select select-bordered w-full" %>
            <label class="label py-0.5">
              <span class="label-text-alt text-base-content/50">
                <%= t("characters.authors_note.combine_hint", default: "How to combine with space-level Author's Note when both are present.") %>
              </span>
            </label>
          </div>
        </div>
      </div>
    </div>

    <!-- Actions -->
    <div class="flex gap-2">
      <%= f.submit t("common.save", default: "Save"), class: "btn btn-primary gap-2" %>
      <%= link_to t("common.cancel", default: "Cancel"), settings_characters_path, class: "btn btn-ghost" %>
    </div>
  <% end %>

  <!-- Danger Zone -->
  <div class="card bg-base-100 shadow-sm border border-error/30">
    <div class="card-body">
      <h3 class="card-title text-error">
        <span class="icon-[lucide--alert-triangle] size-5"></span>
        <%= t("characters.danger_zone", default: "Danger Zone") %>
      </h3>
      <p class="text-base-content/60 text-sm"><%= t("characters.danger_description", default: "Once you delete a character, there is no going back. Please be certain.") %></p>
      <div class="card-actions mt-4">
        <%= button_to settings_character_path(@character),
            method: :delete,
            class: "btn btn-error btn-outline gap-2",
            data: { turbo_confirm: t("characters.destroy.confirm", name: @character.name) } do %>
          <span class="icon-[lucide--trash-2] size-4"></span>
          <%= t("characters.actions.delete") %>
        <% end %>
      </div>
    </div>
  </div>
</div>
