<% content_for :title, t("characters.edit.title", default: "Edit Character") %>

<div class="space-y-6">
  <!-- Breadcrumbs -->
  <div class="breadcrumbs text-sm">
    <ul>
      <li>
        <%= link_to settings_characters_path do %>
          <span class="icon-[lucide--users] size-4 mr-1"></span>
          <%= t("characters.index.title", default: "Characters") %>
        <% end %>
      </li>
      <li><%= @character.name.truncate(30) %></li>
    </ul>
  </div>

  <%= form_with model: @character, url: settings_character_path(@character), method: :patch, class: "space-y-6" do |f| %>
    <!-- Basic Info Card -->
    <div class="card bg-base-100 shadow-sm border border-base-300">
      <div class="card-body">
        <div class="flex items-start gap-6">
          <!-- Portrait -->
          <div class="shrink-0">
            <figure class="w-24 h-32 relative overflow-hidden rounded-box bg-base-200">
              <%= image_tag fresh_character_portrait_path(@character),
                            class: "w-full h-full object-cover",
                            alt: @character.name %>
              <div class="absolute top-2 right-2">
                <span class="badge badge-xs <%= @character.v3? ? 'badge-primary' : 'badge-ghost' %>">
                  <%= @character.v3? ? "CCv3" : "CCv2" %>
                </span>
              </div>
            </figure>
          </div>

          <!-- Basic Fields -->
          <div class="flex-1 space-y-4">
            <h2 class="card-title">
              <span class="icon-[lucide--user] size-5"></span>
              <%= t("characters.edit.basic_info", default: "Basic Info") %>
            </h2>

            <!-- Name -->
            <div class="form-control">
              <label class="label py-1">
                <span class="label-text font-medium"><%= t("characters.form.name", default: "Name") %> <span class="text-error">*</span></span>
              </label>
              <%= f.text_field :name, class: "input input-bordered w-full", required: true %>
              <label class="label py-0.5">
                <span class="label-text-alt text-base-content/50"><%= t("characters.form.name_hint", default: "The character's display name") %></span>
              </label>
            </div>

            <!-- Nickname -->
            <div class="form-control">
              <label class="label py-1">
                <span class="label-text font-medium"><%= t("characters.form.nickname", default: "Nickname") %></span>
              </label>
              <%= f.text_field :nickname, class: "input input-bordered w-full" %>
              <label class="label py-0.5">
                <span class="label-text-alt text-base-content/50"><%= t("characters.form.nickname_hint", default: "Alternative name used in {{char}} macro (CCv3)") %></span>
              </label>
            </div>
          </div>
        </div>

        <!-- Metadata display (read-only) -->
        <div class="divider my-2"></div>
        <div class="flex flex-wrap gap-4 text-sm text-base-content/50">
          <% if @character.creator.present? %>
            <div class="flex items-center gap-1">
              <span class="icon-[lucide--pen-tool] size-4"></span>
              <span><%= @character.creator %></span>
            </div>
          <% end %>
          <% if @character.character_version.present? %>
            <div class="flex items-center gap-1">
              <span class="icon-[lucide--git-branch] size-4"></span>
              <span><%= @character.character_version %></span>
            </div>
          <% end %>
          <% if @character.tags.any? %>
            <div class="flex items-center gap-1">
              <span class="icon-[lucide--tags] size-4"></span>
              <span><%= @character.tags.first(3).join(", ") %><%= "+#{@character.tags.size - 3}" if @character.tags.size > 3 %></span>
            </div>
          <% end %>
        </div>
      </div>
    </div>

    <!-- Character Definition Card -->
    <div class="card bg-base-100 shadow-sm border border-base-300">
      <div class="card-body">
        <h2 class="card-title">
          <span class="icon-[lucide--user-circle] size-5"></span>
          <%= t("characters.edit.character_definition", default: "Character Definition") %>
        </h2>
        <p class="text-sm text-base-content/60 mb-4">
          <%= t("characters.edit.character_definition_hint", default: "Core character attributes that define who they are. These fields support macros.") %>
        </p>

        <div class="space-y-6">
          <!-- Description -->
          <div class="form-control">
            <label class="label py-1">
              <span class="label-text font-medium"><%= t("characters.form.description", default: "Description") %></span>
            </label>
            <%= text_area_tag "character[data][description]",
                              @character.data&.description,
                              class: "textarea textarea-bordered w-full h-40 font-mono text-sm",
                              placeholder: t("characters.form.description_placeholder", default: "Enter character description...") %>
            <label class="label py-0.5">
              <span class="label-text-alt text-base-content/50">
                <%= t("characters.form.description_hint", default: "Character's background, history, appearance, and other defining traits. Supports macros like {{user}}.") %>
              </span>
            </label>
          </div>

          <!-- Personality -->
          <div class="form-control">
            <label class="label py-1">
              <span class="label-text font-medium"><%= t("characters.form.personality", default: "Personality") %></span>
            </label>
            <%= text_area_tag "character[data][personality]",
                              @character.data&.personality,
                              class: "textarea textarea-bordered w-full h-24 font-mono text-sm",
                              placeholder: t("characters.form.personality_placeholder", default: "e.g., cheerful, curious, protective...") %>
            <label class="label py-0.5">
              <span class="label-text-alt text-base-content/50">
                <%= t("characters.form.personality_hint", default: "Personality traits, quirks, and behavioral patterns that define how the character acts.") %>
              </span>
            </label>
          </div>

          <!-- Scenario -->
          <div class="form-control">
            <label class="label py-1">
              <span class="label-text font-medium"><%= t("characters.form.scenario", default: "Scenario") %></span>
            </label>
            <%= text_area_tag "character[data][scenario]",
                              @character.data&.scenario,
                              class: "textarea textarea-bordered w-full h-24 font-mono text-sm",
                              placeholder: t("characters.form.scenario_placeholder", default: "The setting or situation for the roleplay...") %>
            <label class="label py-0.5">
              <span class="label-text-alt text-base-content/50">
                <%= t("characters.form.scenario_hint", default: "The context, setting, or situation where the roleplay takes place.") %>
              </span>
            </label>
          </div>
        </div>
      </div>
    </div>

    <!-- Messages & Examples Card -->
    <div class="card bg-base-100 shadow-sm border border-base-300">
      <div class="card-body">
        <h2 class="card-title">
          <span class="icon-[lucide--message-square] size-5"></span>
          <%= t("characters.edit.messages_examples", default: "Messages & Examples") %>
        </h2>
        <p class="text-sm text-base-content/60 mb-4">
          <%= t("characters.edit.messages_examples_hint", default: "Opening messages and example dialogue that help the AI understand the character's voice.") %>
        </p>

        <div class="space-y-6">
          <!-- First Message -->
          <div class="form-control">
            <label class="label py-1">
              <span class="label-text font-medium"><%= t("characters.form.first_mes", default: "First Message") %></span>
            </label>
            <%= text_area_tag "character[data][first_mes]",
                              @character.data&.first_mes,
                              class: "textarea textarea-bordered w-full h-32 font-mono text-sm",
                              placeholder: t("characters.form.first_mes_placeholder", default: "*The character's opening message when starting a chat...*") %>
            <label class="label py-0.5">
              <span class="label-text-alt text-base-content/50">
                <%= t("characters.form.first_mes_hint", default: "The initial greeting shown when a new chat starts. Sets the tone for the conversation.") %>
              </span>
            </label>
          </div>

          <!-- Alternate Greetings -->
          <div class="form-control" data-controller="array-field">
            <label class="label py-1">
              <span class="label-text font-medium"><%= t("characters.form.alternate_greetings", default: "Alternate Greetings") %></span>
            </label>

            <div data-array-field-target="list" class="space-y-2">
              <% (@character.data&.alternate_greetings || []).each_with_index do |greeting, index| %>
                <div data-array-field-item class="flex gap-2 items-start">
                  <textarea name="character[data][alternate_greetings][]"
                            class="textarea textarea-bordered flex-1 font-mono text-sm h-24"
                            placeholder="<%= t("characters.form.greeting_placeholder", default: "Alternative opening message...") %>"><%= greeting %></textarea>
                  <button type="button" class="btn btn-ghost btn-square btn-sm text-error" data-action="array-field#remove" title="<%= t("common.remove", default: "Remove") %>">
                    <span class="icon-[lucide--x] size-4"></span>
                  </button>
                </div>
              <% end %>
            </div>

            <template data-array-field-target="template">
              <div data-array-field-item class="flex gap-2 items-start">
                <textarea name="character[data][alternate_greetings][]"
                          class="textarea textarea-bordered flex-1 font-mono text-sm h-24"
                          placeholder="<%= t("characters.form.greeting_placeholder", default: "Alternative opening message...") %>"></textarea>
                <button type="button" class="btn btn-ghost btn-square btn-sm text-error" data-action="array-field#remove" title="<%= t("common.remove", default: "Remove") %>">
                  <span class="icon-[lucide--x] size-4"></span>
                </button>
              </div>
            </template>

            <div class="mt-2">
              <button type="button" class="btn btn-ghost btn-sm gap-1" data-action="array-field#add">
                <span class="icon-[lucide--plus] size-4"></span>
                <%= t("characters.form.add_greeting", default: "Add Greeting") %>
              </button>
            </div>
            <label class="label py-0.5">
              <span class="label-text-alt text-base-content/50">
                <%= t("characters.form.alternate_greetings_hint", default: "Alternative first messages that can be randomly selected or chosen by the user.") %>
              </span>
            </label>
          </div>

          <!-- Group Only Greetings (CCv3) -->
          <% if @character.v3? %>
          <div class="form-control" data-controller="array-field">
            <label class="label py-1">
              <span class="label-text font-medium">
                <%= t("characters.form.group_only_greetings", default: "Group Chat Greetings") %>
                <span class="badge badge-xs badge-primary ml-1">CCv3</span>
              </span>
            </label>

            <div data-array-field-target="list" class="space-y-2">
              <% (@character.data&.group_only_greetings || []).each_with_index do |greeting, index| %>
                <div data-array-field-item class="flex gap-2 items-start">
                  <textarea name="character[data][group_only_greetings][]"
                            class="textarea textarea-bordered flex-1 font-mono text-sm h-24"
                            placeholder="<%= t("characters.form.group_greeting_placeholder", default: "Greeting for group chat context...") %>"><%= greeting %></textarea>
                  <button type="button" class="btn btn-ghost btn-square btn-sm text-error" data-action="array-field#remove" title="<%= t("common.remove", default: "Remove") %>">
                    <span class="icon-[lucide--x] size-4"></span>
                  </button>
                </div>
              <% end %>
            </div>

            <template data-array-field-target="template">
              <div data-array-field-item class="flex gap-2 items-start">
                <textarea name="character[data][group_only_greetings][]"
                          class="textarea textarea-bordered flex-1 font-mono text-sm h-24"
                          placeholder="<%= t("characters.form.group_greeting_placeholder", default: "Greeting for group chat context...") %>"></textarea>
                <button type="button" class="btn btn-ghost btn-square btn-sm text-error" data-action="array-field#remove" title="<%= t("common.remove", default: "Remove") %>">
                  <span class="icon-[lucide--x] size-4"></span>
                </button>
              </div>
            </template>

            <div class="mt-2">
              <button type="button" class="btn btn-ghost btn-sm gap-1" data-action="array-field#add">
                <span class="icon-[lucide--plus] size-4"></span>
                <%= t("characters.form.add_group_greeting", default: "Add Group Greeting") %>
              </button>
            </div>
            <label class="label py-0.5">
              <span class="label-text-alt text-base-content/50">
                <%= t("characters.form.group_only_greetings_hint", default: "Greetings used exclusively in group chat contexts (CCv3 feature).") %>
              </span>
            </label>
          </div>
          <% end %>

          <!-- Example Dialogue -->
          <div class="form-control">
            <label class="label py-1">
              <span class="label-text font-medium"><%= t("characters.form.mes_example", default: "Example Dialogue") %></span>
            </label>
            <%= text_area_tag "character[data][mes_example]",
                              @character.data&.mes_example,
                              class: "textarea textarea-bordered w-full h-40 font-mono text-sm",
                              placeholder: t("characters.form.mes_example_placeholder", default: "<START>\n{{user}}: Hello!\n{{char}}: *waves* Hi there!") %>
            <label class="label py-0.5">
              <span class="label-text-alt text-base-content/50">
                <%= t("characters.form.mes_example_hint", default: "Example conversations in <START> block format. Helps the AI learn the character's speaking style and mannerisms.") %>
              </span>
            </label>
          </div>
        </div>
      </div>
    </div>

    <!-- Prompt Control Card -->
    <div class="card bg-base-100 shadow-sm border border-base-300">
      <div class="card-body">
        <h2 class="card-title">
          <span class="icon-[lucide--terminal] size-5"></span>
          <%= t("characters.edit.prompt_control", default: "Prompt Control") %>
        </h2>
        <p class="text-sm text-base-content/60 mb-4">
          <%= t("characters.edit.prompt_control_hint", default: "Advanced settings that control how the character card influences prompt generation.") %>
        </p>

        <div class="space-y-6">
          <!-- System Prompt -->
          <div class="form-control">
            <label class="label py-1">
              <span class="label-text font-medium"><%= t("characters.form.system_prompt", default: "System Prompt") %></span>
            </label>
            <%= text_area_tag "character[data][system_prompt]",
                              @character.data&.system_prompt,
                              class: "textarea textarea-bordered w-full h-32 font-mono text-sm",
                              placeholder: t("characters.form.system_prompt_placeholder", default: "Custom system prompt override...") %>
            <label class="label py-0.5">
              <span class="label-text-alt text-base-content/50">
                <%= t("characters.form.system_prompt_hint", default: "Override the default system prompt. When set, this replaces the global system prompt for this character.") %>
              </span>
            </label>
          </div>

          <!-- Post History Instructions (Jailbreak/PHI) -->
          <div class="form-control">
            <label class="label py-1">
              <span class="label-text font-medium"><%= t("characters.form.post_history_instructions", default: "Post-History Instructions") %></span>
            </label>
            <%= text_area_tag "character[data][post_history_instructions]",
                              @character.data&.post_history_instructions,
                              class: "textarea textarea-bordered w-full h-32 font-mono text-sm",
                              placeholder: t("characters.form.phi_placeholder", default: "Instructions inserted after chat history...") %>
            <label class="label py-0.5">
              <span class="label-text-alt text-base-content/50">
                <%= t("characters.form.post_history_instructions_hint", default: "Instructions inserted after the chat history (also known as 'jailbreak' or PHI). Used to reinforce character behavior.") %>
              </span>
            </label>
          </div>
        </div>
      </div>
    </div>

    <!-- Metadata Card -->
    <div class="card bg-base-100 shadow-sm border border-base-300">
      <div class="card-body">
        <h2 class="card-title">
          <span class="icon-[lucide--info] size-5"></span>
          <%= t("characters.edit.metadata", default: "Metadata") %>
        </h2>
        <p class="text-sm text-base-content/60 mb-4">
          <%= t("characters.edit.metadata_hint", default: "Information about the character card itself, including creator attribution and categorization.") %>
        </p>

        <div class="space-y-6">
          <!-- Creator Notes -->
          <div class="form-control">
            <label class="label py-1">
              <span class="label-text font-medium"><%= t("characters.form.creator_notes", default: "Creator Notes") %></span>
            </label>
            <%= text_area_tag "character[data][creator_notes]",
                              @character.data&.creator_notes,
                              class: "textarea textarea-bordered w-full h-24 font-mono text-sm",
                              placeholder: t("characters.form.creator_notes_placeholder", default: "Notes for users about how to use this character...") %>
            <label class="label py-0.5">
              <span class="label-text-alt text-base-content/50">
                <%= t("characters.form.creator_notes_hint", default: "Notes from the card creator for users. Typically includes usage tips, recommended settings, or lore context.") %>
              </span>
            </label>
          </div>

          <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
            <!-- Creator -->
            <div class="form-control">
              <label class="label py-1">
                <span class="label-text font-medium"><%= t("characters.form.creator", default: "Creator") %></span>
              </label>
              <%= text_field_tag "character[data][creator]",
                                 @character.data&.creator,
                                 class: "input input-bordered w-full",
                                 placeholder: t("characters.form.creator_placeholder", default: "Card creator name") %>
              <label class="label py-0.5">
                <span class="label-text-alt text-base-content/50">
                  <%= t("characters.form.creator_hint", default: "Name of the person who created this character card.") %>
                </span>
              </label>
            </div>

            <!-- Character Version -->
            <div class="form-control">
              <label class="label py-1">
                <span class="label-text font-medium"><%= t("characters.form.character_version", default: "Version") %></span>
              </label>
              <%= text_field_tag "character[data][character_version]",
                                 @character.data&.character_version,
                                 class: "input input-bordered w-full",
                                 placeholder: t("characters.form.character_version_placeholder", default: "e.g., 1.0, 2.1-beta") %>
              <label class="label py-0.5">
                <span class="label-text-alt text-base-content/50">
                  <%= t("characters.form.character_version_hint", default: "Version string for tracking card updates and revisions.") %>
                </span>
              </label>
            </div>
          </div>

          <!-- Tags -->
          <div class="form-control" data-controller="keys-input" data-keys-input-name-value="character[data][tags][]">
            <label class="label py-1">
              <span class="label-text font-medium"><%= t("characters.form.tags", default: "Tags") %></span>
            </label>

            <div class="flex flex-wrap gap-2 p-3 border border-base-300 rounded-box min-h-12 cursor-text bg-base-100"
                 data-keys-input-target="container"
                 data-action="click->keys-input#focusInput">
              <% (@character.data&.tags || []).each do |tag| %>
                <span class="badge badge-lg gap-1" data-keys-input-target="tag">
                  <%= tag %>
                  <input type="hidden" name="character[data][tags][]" value="<%= tag %>">
                  <button type="button" class="btn btn-ghost btn-xs btn-circle" data-action="keys-input#removeTag" aria-label="Remove">
                    <span class="icon-[lucide--x] size-3"></span>
                  </button>
                </span>
              <% end %>
              <input type="text"
                     class="flex-1 min-w-[120px] bg-transparent border-none outline-none text-sm"
                     placeholder="<%= t("characters.form.tags_placeholder", default: "Type and press Enter to add tags...") %>"
                     data-keys-input-target="input"
                     data-action="keydown->keys-input#handleKeydown blur->keys-input#handleBlur">
            </div>

            <label class="label py-0.5">
              <span class="label-text-alt text-base-content/50">
                <%= t("characters.form.tags_hint", default: "Tags for categorization and filtering. Press Enter or comma to add a tag.") %>
              </span>
            </label>
          </div>
        </div>
      </div>
    </div>

    <!-- Author's Note Card -->
    <% an_settings = @character.effective_authors_note_settings %>
    <div class="card bg-base-100 shadow-sm border border-base-300">
      <div class="card-body">
        <h2 class="card-title">
          <span class="icon-[lucide--pen-line] size-5"></span>
          <%= t("characters.authors_note.title", default: "Author's Note") %>
        </h2>
        <p class="text-sm text-base-content/60 mb-4">
          <%= t("characters.authors_note.description", default: "Default Author's Note settings for this character. Can be overridden per-space or per-conversation.") %>
        </p>

        <div class="space-y-6">
          <!-- Enable toggle -->
          <div class="form-control">
            <label class="label cursor-pointer justify-start gap-3">
              <%= hidden_field_tag "character[authors_note_settings][use_character_authors_note]", "0", id: nil %>
              <%= check_box_tag "character[authors_note_settings][use_character_authors_note]",
                                "1",
                                an_settings.use_character_authors_note == true,
                                class: "toggle toggle-primary" %>
              <div>
                <span class="label-text font-medium"><%= t("characters.authors_note.enable", default: "Enable Character Author's Note") %></span>
                <p class="text-xs text-base-content/50">
                  <%= t("characters.authors_note.enable_hint", default: "When enabled, this AN will be included in prompts") %>
                </p>
              </div>
            </label>
          </div>

          <!-- Content -->
          <div class="form-control">
            <label class="label py-1">
              <span class="label-text font-medium"><%= t("characters.authors_note.content", default: "Content") %></span>
            </label>
            <%= text_area_tag "character[authors_note_settings][authors_note]",
                              an_settings.authors_note,
                              class: "textarea textarea-bordered w-full h-32 font-mono text-sm",
                              placeholder: t("characters.authors_note.placeholder", default: "[Write in a vivid, descriptive style...]") %>
            <label class="label py-0.5">
              <span class="label-text-alt text-base-content/50">
                <%= t("characters.authors_note.content_hint", default: "Supports macros like {{char}} and {{user}}. Injected into the prompt to guide AI behavior.") %>
              </span>
            </label>
          </div>

          <!-- Settings row -->
          <div class="grid grid-cols-1 sm:grid-cols-3 gap-6">
            <!-- Position -->
            <div class="form-control">
              <label class="label py-1">
                <span class="label-text font-medium"><%= t("characters.authors_note.position", default: "Position") %></span>
              </label>
            <%= select_tag "character[authors_note_settings][authors_note_position]",
                           options_for_select([
                             [t("characters.authors_note.in_chat", default: "In Chat (at depth)"), "in_chat"],
                             [t("characters.authors_note.in_prompt", default: "After Scenario"), "in_prompt"],
                             [t("characters.authors_note.before_prompt", default: "Before Scenario"), "before_prompt"]
                           ], an_settings.authors_note_position || "in_chat"),
                           class: "select select-bordered w-full" %>
              <label class="label py-0.5">
                <span class="label-text-alt text-base-content/50"><%= t("characters.authors_note.position_hint", default: "Where in the prompt to insert the AN.") %></span>
              </label>
            </div>

            <!-- Depth -->
            <div class="form-control">
              <label class="label py-1">
                <span class="label-text font-medium"><%= t("characters.authors_note.depth", default: "Depth") %></span>
              </label>
            <%= number_field_tag "character[authors_note_settings][authors_note_depth]",
                                 an_settings.authors_note_depth || 4,
                                 class: "input input-bordered w-full",
                                 min: 0, max: 100 %>
              <label class="label py-0.5">
                <span class="label-text-alt text-base-content/50"><%= t("characters.authors_note.depth_hint", default: "0 = end of chat, 4 = before last 4 messages.") %></span>
              </label>
            </div>

            <!-- Role -->
            <div class="form-control">
              <label class="label py-1">
                <span class="label-text font-medium"><%= t("characters.authors_note.role", default: "Role") %></span>
              </label>
            <%= select_tag "character[authors_note_settings][authors_note_role]",
                           options_for_select([
                             ["System", "system"],
                             ["User", "user"],
                             ["Assistant", "assistant"]
                           ], an_settings.authors_note_role || "system"),
                           class: "select select-bordered w-full" %>
              <label class="label py-0.5">
                <span class="label-text-alt text-base-content/50"><%= t("characters.authors_note.role_hint", default: "Message role when injected into chat.") %></span>
              </label>
            </div>
          </div>

          <!-- Combine mode -->
          <div class="form-control">
            <label class="label py-1">
              <span class="label-text font-medium"><%= t("characters.authors_note.combine_mode", default: "Space AN Combine Mode") %></span>
            </label>
            <%= select_tag "character[authors_note_settings][character_authors_note_position]",
                           options_for_select([
                             [t("characters.authors_note.replace", default: "Replace space-level AN"), "replace"],
                             [t("characters.authors_note.before", default: "Prepend to space-level AN"), "before"],
                             [t("characters.authors_note.after", default: "Append to space-level AN"), "after"]
                           ], an_settings.character_authors_note_position || "replace"),
                           class: "select select-bordered w-full" %>
            <label class="label py-0.5">
              <span class="label-text-alt text-base-content/50">
                <%= t("characters.authors_note.combine_hint", default: "How to combine with space-level Author's Note when both are present.") %>
              </span>
            </label>
          </div>
        </div>
      </div>
    </div>

    <!-- Linked Lorebooks Card -->
    <div class="card bg-base-100 shadow-sm border border-base-300">
      <div class="card-body">
        <h2 class="card-title">
          <span class="icon-[lucide--book-open] size-5"></span>
          <%= t("characters.edit.linked_lorebooks", default: "Linked Lorebooks") %>
        </h2>
        <p class="text-sm text-base-content/60 mb-4">
          <%= t("characters.edit.linked_lorebooks_hint", default: "Attach World Info / Lorebooks to this character. Primary lorebook is exported with the character, additional ones are local only.") %>
        </p>

        <div class="space-y-6">
          <!-- Primary Lorebook -->
          <div class="form-control">
            <label class="label py-1">
              <span class="label-text font-medium">
                <%= t("characters.form.primary_lorebook", default: "Primary Lorebook") %>
                <span class="badge badge-xs badge-ghost ml-1"><%= t("characters.form.exported", default: "exported") %></span>
              </span>
            </label>
            <% primary_lorebook = @character.character_lorebooks.primary.first %>
            <%= f.select :primary_lorebook_id,
                         options_for_select(
                           [[t("characters.form.no_lorebook", default: "— No Primary Lorebook —"), ""]] +
                           @lorebooks.map { |lb| [lb.name, lb.id] },
                           primary_lorebook&.lorebook_id
                         ),
                         {},
                         class: "select select-bordered w-full" %>
            <label class="label py-0.5">
              <span class="label-text-alt text-base-content/50">
                <%= t("characters.form.primary_lorebook_hint", default: "Main lorebook linked to this character. Merged into character_book when exporting.") %>
              </span>
            </label>
          </div>

          <!-- Additional Lorebooks -->
          <div class="form-control">
            <label class="label py-1">
              <span class="label-text font-medium">
                <%= t("characters.form.additional_lorebooks", default: "Additional Lorebooks") %>
                <span class="badge badge-xs badge-ghost ml-1"><%= t("characters.form.local_only", default: "local only") %></span>
              </span>
            </label>

            <% additional_lorebooks = @character.character_lorebooks.additional.by_priority.includes(:lorebook) %>
            <% available_lorebooks = @lorebooks.reject { |lb| lb.id == primary_lorebook&.lorebook_id } %>

            <% if additional_lorebooks.any? %>
              <div class="space-y-2 mb-3" data-controller="sortable" data-sortable-handle-value=".drag-handle">
                <% additional_lorebooks.each do |link| %>
                  <div class="flex items-center gap-2 p-2 bg-base-200/50 rounded-box group" data-sortable-item>
                    <span class="icon-[lucide--grip-vertical] size-4 text-base-content/30 drag-handle cursor-move"></span>
                    <span class="flex-1 font-medium text-sm"><%= link.lorebook.name %></span>
                    <span class="text-xs text-base-content/50"><%= pluralize(link.lorebook.entries.count, "entry") %></span>
                    <label class="swap swap-flip">
                      <input type="checkbox"
                             name="character[additional_lorebook_ids][]"
                             value="<%= link.lorebook_id %>"
                             checked
                             class="hidden">
                      <span class="swap-on icon-[lucide--check-circle] size-4 text-success"></span>
                      <span class="swap-off icon-[lucide--circle] size-4 text-base-content/30"></span>
                    </label>
                  </div>
                <% end %>
              </div>
            <% else %>
              <div class="text-sm text-base-content/50 py-2">
                <%= t("characters.form.no_additional_lorebooks", default: "No additional lorebooks linked.") %>
              </div>
            <% end %>

            <!-- Add additional lorebook -->
            <% unlinked_lorebooks = available_lorebooks.reject { |lb| additional_lorebooks.map(&:lorebook_id).include?(lb.id) } %>
            <% if unlinked_lorebooks.any? %>
              <div class="dropdown dropdown-top">
                <label tabindex="0" class="btn btn-ghost btn-sm gap-1">
                  <span class="icon-[lucide--plus] size-4"></span>
                  <%= t("characters.form.add_lorebook", default: "Add Lorebook") %>
                </label>
                <ul tabindex="0" class="dropdown-content z-[1] menu p-2 shadow-lg bg-base-100 rounded-box w-64 max-h-60 overflow-y-auto">
                  <% unlinked_lorebooks.each do |lb| %>
                    <li>
                      <label class="flex items-center gap-2">
                        <input type="checkbox"
                               name="character[additional_lorebook_ids][]"
                               value="<%= lb.id %>"
                               class="checkbox checkbox-sm checkbox-primary">
                        <span class="flex-1"><%= lb.name %></span>
                        <span class="text-xs text-base-content/50"><%= lb.entries.count %></span>
                      </label>
                    </li>
                  <% end %>
                </ul>
              </div>
            <% end %>

            <label class="label py-0.5">
              <span class="label-text-alt text-base-content/50">
                <%= t("characters.form.additional_lorebooks_hint", default: "Extra lorebooks activated when this character is in a Space. Not included in exports.") %>
              </span>
            </label>
          </div>

          <!-- Embedded character_book (read-only display) -->
          <% embedded_book = @character.character_book %>
          <% if embedded_book.present? && embedded_book.entries&.any? %>
            <div class="border border-warning/30 rounded-box overflow-hidden">
              <div class="flex items-center gap-2 px-4 py-3 bg-warning/10">
                <span class="icon-[lucide--book-marked] size-5 text-warning"></span>
                <div class="flex-1">
                  <div class="font-medium"><%= t("characters.form.embedded_lorebook", default: "Embedded Lorebook") %></div>
                  <div class="text-xs text-base-content/60">
                    <%= t("characters.form.embedded_lorebook_readonly_hint",
                          default: "This lorebook is embedded in the character card. Edit the character card file to modify these entries.") %>
                  </div>
                </div>
                <span class="badge badge-warning"><%= embedded_book.entries.size %> entries</span>
              </div>
              <div class="p-4 space-y-2 bg-base-100">
                <% embedded_book.entries.each do |entry| %>
                  <%= render "characters/lorebook_entry", entry: entry %>
                <% end %>
              </div>
            </div>
          <% elsif embedded_book.present? %>
            <div class="alert alert-info shadow-sm">
              <span class="icon-[lucide--info] size-5"></span>
              <div>
                <div class="font-medium"><%= t("characters.form.embedded_lorebook", default: "Embedded Lorebook") %></div>
                <div class="text-sm opacity-80">
                  <%= t("characters.form.embedded_lorebook_empty_hint",
                        default: "This character has an embedded lorebook but it contains no entries.") %>
                </div>
              </div>
            </div>
          <% end %>
        </div>
      </div>
    </div>

    <!-- Actions -->
    <div class="flex gap-2">
      <%= f.submit t("common.save", default: "Save"), class: "btn btn-primary gap-2" %>
      <%= link_to t("common.cancel", default: "Cancel"), settings_characters_path, class: "btn btn-ghost" %>
    </div>
  <% end %>

  <!-- Danger Zone -->
  <div class="card bg-base-100 shadow-sm border border-error/30">
    <div class="card-body">
      <h3 class="card-title text-error">
        <span class="icon-[lucide--alert-triangle] size-5"></span>
        <%= t("characters.danger_zone", default: "Danger Zone") %>
      </h3>
      <p class="text-base-content/60 text-sm"><%= t("characters.danger_description", default: "Once you delete a character, there is no going back. Please be certain.") %></p>
      <div class="card-actions mt-4">
        <%= button_to settings_character_path(@character),
            method: :delete,
            class: "btn btn-error btn-outline gap-2",
            data: { turbo_confirm: t("characters.destroy.confirm", name: @character.name) } do %>
          <span class="icon-[lucide--trash-2] size-4"></span>
          <%= t("characters.actions.delete") %>
        <% end %>
      </div>
    </div>
  </div>
</div>
