<%# Character Card - Display in list view %>
<%# locals: (character:) %>
<%= tag.div id: dom_id(character), class: "card bg-base-100 shadow-sm border border-base-300", data: { status: character.status } do %>
  <%# Status overlay for non-ready states %>
  <% if character.pending? %>
    <div class="absolute inset-0 bg-base-100/90 backdrop-blur-sm z-10 flex flex-col items-center justify-center rounded-2xl">
      <span class="loading loading-spinner loading-lg text-primary"></span>
      <p class="text-sm text-base-content/70 mt-2"><%= t("characters.status.pending") %></p>
    </div>
  <% elsif character.failed? %>
    <div class="absolute inset-0 bg-error/10 backdrop-blur-sm z-10 flex flex-col items-center justify-center rounded-2xl">
      <span class="icon-[lucide--alert-circle] size-12 text-error"></span>
      <p class="text-sm text-error mt-2"><%= t("characters.status.failed") %></p>
      <% import_error = character.data&.to_h&.dig(:_import_error) || character.data&.to_h&.dig("_import_error") %>
      <% if import_error.present? %>
        <p class="text-xs text-error/70 mt-1 max-w-md text-center px-4"><%= import_error.truncate(100) %></p>
      <% end %>
    </div>
  <% elsif character.deleting? %>
    <div class="absolute inset-0 bg-base-100/90 backdrop-blur-sm z-10 flex flex-col items-center justify-center rounded-2xl">
      <span class="loading loading-spinner loading-lg text-warning"></span>
      <p class="text-sm text-base-content/70 mt-2"><%= t("characters.status.deleting", default: "Deleting...") %></p>
    </div>
  <% end %>

  <div class="card-body p-4">
    <div class="flex gap-4">
      <%# Portrait %>
      <div class="shrink-0">
        <% character_path = character.locked? ? settings_character_path(character) : edit_settings_character_path(character) %>
        <%= link_to character_path, class: "block" do %>
          <figure class="w-20 h-28 relative overflow-hidden rounded-lg bg-base-200">
            <%= image_tag fresh_character_portrait_path(character),
                          class: "w-full h-full object-cover hover:scale-105 transition-transform",
                          alt: character.name %>
          </figure>
        <% end %>
      </div>

      <%# Info Section %>
      <div class="flex-1 min-w-0">
        <!-- Header -->
        <div class="flex items-start justify-between gap-2">
          <div class="min-w-0">
            <h3 class="card-title text-lg flex items-center gap-2">
              <% character_path = character.locked? ? settings_character_path(character) : edit_settings_character_path(character) %>
              <%= link_to character.name, character_path, class: "hover:text-primary transition-colors truncate" %>
              <% if character.locked? %>
                <span class="badge badge-sm badge-warning gap-1" title="<%= t("common.locked", default: "Locked") %>">
                  <span class="icon-[lucide--lock] size-3"></span>
                </span>
              <% end %>
              <% if character.draft? %>
                <span class="badge badge-sm badge-ghost gap-1" title="<%= t("common.draft", default: "Draft (private)") %>">
                  <span class="icon-[lucide--eye-off] size-3"></span>
                </span>
              <% end %>
              <% if character.nsfw? %>
                <span class="badge badge-sm badge-error gap-1" title="<%= t("common.nsfw", default: "NSFW") %>">
                  <span class="icon-[lucide--shield-alert] size-3"></span>
                  NSFW
                </span>
              <% end %>

              <% if character.spec_version.present? %>
                <span class="badge badge-sm <%= character.v3? ? 'badge-primary' : 'badge-ghost' %>">
                  <%= character.v3? ? "CCv3" : "CCv2" %>
                </span>
              <% end %>
            </h3>
            <% if character.nickname.present? %>
              <p class="text-sm text-base-content/60 truncate"><%= character.nickname %></p>
            <% end %>
          </div>
          <div class="flex items-center gap-2 shrink-0">
            <% if character.ready? %>
              <% if character.locked? %>
                <%= link_to settings_character_path(character), class: "btn btn-sm btn-ghost gap-1" do %>
                  <span class="icon-[lucide--eye] size-4"></span>
                  <%= t("common.view", default: "View") %>
                <% end %>
              <% else %>
                <%= link_to edit_settings_character_path(character), class: "btn btn-sm btn-ghost gap-1" do %>
                  <span class="icon-[lucide--pencil] size-4"></span>
                  <%= t("common.edit", default: "Edit") %>
                <% end %>
              <% end %>
            <% end %>
          </div>
        </div>

        <%# Metadata %>
        <% if character.ready? %>
          <div class="flex flex-wrap items-center gap-x-4 gap-y-1 mt-2 text-sm text-base-content/50">
            <%# Uploaded by (user who created/imported this record) %>
            <div class="flex items-center gap-1">
              <span class="icon-[lucide--user] size-3"></span>
              <% if character.user.present? %>
                <span><%= character.user.name.truncate(20) %></span>
              <% else %>
                <span class="badge badge-xs badge-ghost"><%= t("common.system", default: "System") %></span>
              <% end %>
            </div>
            <%# Creator (from character card metadata) %>
            <% if character.creator.present? %>
              <div class="flex items-center gap-1">
                <span class="icon-[lucide--pen-tool] size-3"></span>
                <span><%= character.creator.truncate(20) %></span>
              </div>
            <% end %>
            <% if character.character_version.present? %>
              <div class="flex items-center gap-1">
                <span class="icon-[lucide--git-branch] size-3"></span>
                <span><%= character.character_version %></span>
              </div>
            <% end %>
            <% if character.character_book.present? %>
              <% entries_count = character.character_book.respond_to?(:entries) ? (character.character_book.entries&.size || 0) : 0 %>
              <div class="flex items-center gap-1" title="<%= t("characters.show.lorebook") %>">
                <span class="icon-[lucide--book-open] size-3"></span>
                <span><%= entries_count %> <%= t("characters.lorebook_entries", default: "entries") %></span>
              </div>
            <% end %>
            <div class="flex items-center gap-1" title="<%= t("characters.messages_count", default: "Messages") %>">
              <span class="icon-[lucide--message-square] size-3"></span>
              <span><%= number_with_delimiter(character.messages_count) %></span>
            </div>
          </div>

          <%# Description Preview %>
          <% if character.description.present? %>
            <p class="text-sm text-base-content/60 mt-2 line-clamp-2">
              <%= character.description.truncate(150) %>
            </p>
          <% end %>

          <%# Tags (all) %>
          <% if character.tags.any? %>
            <div class="flex flex-wrap gap-1 mt-2">
              <% character.tags.each do |tag| %>
                <span class="badge badge-xs badge-outline"><%= tag %></span>
              <% end %>
            </div>
          <% end %>
        <% end %>
      </div>
    </div>

    <%# Quick Actions %>
    <% if character.ready? %>
      <div class="mt-3 pt-3 border-t border-base-200 flex items-center justify-between">
        <div class="flex flex-wrap gap-2">
          <%# Export dropdown %>
          <div class="dropdown dropdown-top">
            <div tabindex="0" role="button" class="btn btn-sm btn-outline gap-2">
              <span class="icon-[lucide--download] size-4"></span>
              <%= t("characters.show.export") %>
            </div>
            <ul tabindex="0" class="dropdown-content menu bg-base-100/95 backdrop-blur-sm rounded-box z-50 w-40 p-2 shadow-lg border border-base-300 mb-1">
              <li>
                <%= link_to "#", class: "gap-2 text-sm", data: { turbo: false } do %>
                  <span class="icon-[lucide--file-json] size-4"></span>
                  JSON
                <% end %>
              </li>
              <li>
                <%= link_to "#", class: "gap-2 text-sm", data: { turbo: false } do %>
                  <span class="icon-[lucide--image] size-4"></span>
                  PNG
                <% end %>
              </li>
              <li>
                <%= link_to "#", class: "gap-2 text-sm", data: { turbo: false } do %>
                  <span class="icon-[lucide--archive] size-4"></span>
                  CharX
                <% end %>
              </li>
            </ul>
          </div>

          <%# Duplicate %>
          <%= button_to duplicate_settings_character_path(character),
                method: :post,
                form: { data: { turbo_confirm: t("characters.duplicate_confirm", default: "Create a copy of this character?") } },
                class: "btn btn-sm btn-ghost gap-1" do %>
            <span class="icon-[lucide--copy] size-4"></span>
            <%= t("common.duplicate", default: "Duplicate") %>
          <% end %>

          <%# Lock/Unlock %>
          <% if character.locked? %>
            <%= button_to unlock_settings_character_path(character), method: :post, class: "btn btn-sm btn-ghost gap-1" do %>
              <span class="icon-[lucide--unlock] size-4"></span>
              <%= t("common.unlock", default: "Unlock") %>
            <% end %>
          <% else %>
            <%= button_to lock_settings_character_path(character), method: :post, class: "btn btn-sm btn-ghost gap-1" do %>
              <span class="icon-[lucide--lock] size-4"></span>
              <%= t("common.lock", default: "Lock") %>
            <% end %>
          <% end %>

          <%# Publish/Unpublish %>
          <% if character.draft? %>
            <%= button_to publish_settings_character_path(character), method: :post, class: "btn btn-sm btn-ghost gap-1" do %>
              <span class="icon-[lucide--eye] size-4"></span>
              <%= t("common.publish", default: "Publish") %>
            <% end %>
          <% else %>
            <%= button_to unpublish_settings_character_path(character), method: :post, class: "btn btn-sm btn-ghost gap-1" do %>
              <span class="icon-[lucide--eye-off] size-4"></span>
              <%= t("common.unpublish", default: "Unpublish") %>
            <% end %>
          <% end %>
        </div>

        <%# Delete button (disabled if locked) %>
        <% if character.locked? %>
          <button type="button" class="btn btn-sm btn-ghost text-base-content/30 gap-2" disabled title="<%= t("characters.locked", default: "Character is locked.") %>">
            <span class="icon-[lucide--trash-2] size-4"></span>
            <%= t("characters.actions.delete") %>
          </button>
        <% else %>
          <%= button_to settings_character_path(character),
                method: :delete,
                form: { data: { turbo_confirm: t("characters.destroy.confirm", name: character.name) } },
                class: "btn btn-sm btn-ghost text-error gap-2" do %>
            <span class="icon-[lucide--trash-2] size-4"></span>
            <%= t("characters.actions.delete") %>
          <% end %>
        <% end %>
      </div>
    <% elsif character.failed? %>
      <div class="mt-3 pt-3 border-t border-base-200">
        <%= button_to settings_character_path(character),
              method: :delete,
              form: { data: { turbo_confirm: t("characters.destroy.confirm_failed", default: "Delete this failed import?") } },
              class: "btn btn-sm btn-error btn-outline gap-2" do %>
          <span class="icon-[lucide--trash-2] size-4"></span>
          <%= t("characters.actions.delete") %>
        <% end %>
      </div>
    <% end %>
  </div>
<% end %>
