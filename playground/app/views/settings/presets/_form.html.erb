<%# Preset Form - Schema-driven dynamic rendering %>
<%# locals: (preset:) %>

<%
  # Get fields from schema
  fields = ConversationSettings::FieldEnumerator.preset_fields(preset: preset)
  gen_fields = fields.select { |f| f[:section] == :generation_settings }
  preset_fields = fields.select { |f| f[:section] == :preset_settings }

  available_llm_providers = LLMProvider.enabled.order(:id)
  llm_provider_options = available_llm_providers.map { |provider| [provider.name, provider.id] }
  llm_provider_options.unshift([
    t("presets.form.disabled_provider_placeholder", default: "— Disabled provider (will use default) —"),
    preset.llm_provider_id,
  ]) if preset.llm_provider&.disabled?

  # Group preset fields by tab
  prompts_fields = preset_fields.select { |f| f[:ui_tab] == "prompts" }
  authors_note_fields = preset_fields.select { |f| f[:ui_tab] == "authors_note" }
  more_fields = preset_fields.select { |f| f[:ui_tab] == "more" }

  # Group prompts fields by group
  prompts_by_group = prompts_fields.group_by { |f| f[:ui_group] || "General" }
  more_by_group = more_fields.group_by { |f| f[:ui_group] || "General" }
%>

<%= form_with model: preset, url: preset.persisted? ? settings_preset_path(preset) : settings_presets_path, class: "space-y-6" do |f| %>
  <% if preset.errors.any? %>
    <div class="alert alert-error">
      <span class="icon-[lucide--alert-circle] size-5"></span>
      <div>
        <h3 class="font-bold"><%= t("common.errors_title", default: "Please fix the following errors:") %></h3>
        <ul class="list-disc list-inside text-sm">
          <% preset.errors.full_messages.each do |msg| %>
            <li><%= msg %></li>
          <% end %>
        </ul>
      </div>
    </div>
  <% end %>

  <!-- Basic Info -->
  <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
    <!-- Name -->
    <div class="form-control">
      <label class="label py-1">
        <span class="label-text font-medium"><%= t("presets.form.name", default: "Name") %> <span class="text-error">*</span></span>
      </label>
      <%= f.text_field :name, class: "input input-bordered w-full", required: true, placeholder: t("presets.form.name_placeholder", default: "My Custom Preset") %>
    </div>

    <!-- LLM Provider -->
    <div class="form-control">
      <label class="label py-1">
        <span class="label-text font-medium"><%= t("presets.form.llm_provider", default: "LLM Provider") %></span>
      </label>
      <%= f.select :llm_provider_id,
          options_for_select(llm_provider_options, preset.llm_provider_id),
          { include_blank: t("presets.form.no_provider", default: "— No Provider —") },
          class: "select select-bordered w-full" %>
      <label class="label py-0.5">
        <span class="label-text-alt text-base-content/50"><%= t("presets.form.llm_provider_hint", default: "Optional: associate a provider with this preset") %></span>
      </label>
      <% if preset.llm_provider&.disabled? %>
        <label class="label py-0.5">
          <span class="label-text-alt text-warning">
            <%= t("presets.form.disabled_provider_fallback", default: "This preset is associated with a disabled provider and will fall back to the default provider.") %>
          </span>
        </label>
      <% end %>
    </div>
  </div>

  <!-- Description -->
  <div class="form-control">
    <label class="label py-1">
      <span class="label-text font-medium"><%= t("presets.form.description", default: "Description") %></span>
    </label>
    <%= f.text_area :description, class: "textarea textarea-bordered w-full h-20", placeholder: t("presets.form.description_placeholder", default: "Optional description of this preset...") %>
  </div>

  <!-- Generation Settings (Schema-driven) -->
  <div class="divider"><%= t("presets.form.generation_settings", default: "Generation Settings") %></div>

  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
    <% gen_fields.sort_by { |f| f[:ui_order] || 999 }.each do |field| %>
      <%= render partial: "settings/fields/#{partial_for_field(field)}", locals: { field: field } %>
    <% end %>
  </div>

  <!-- Prompt Settings (Schema-driven) -->
  <div class="divider"><%= t("presets.form.prompt_settings", default: "Prompt Settings") %></div>

  <% prompts_by_group.each do |group_name, group_fields| %>
    <div class="space-y-4 mt-4">
      <h4 class="font-medium text-base-content/80"><%= group_name %></h4>
      <div class="grid grid-cols-1 gap-4">
        <% group_fields.sort_by { |f| f[:ui_order] || 999 }.each do |field| %>
          <%= render partial: "settings/fields/#{partial_for_field(field)}", locals: { field: field } %>
        <% end %>
      </div>
    </div>
  <% end %>

  <!-- Author's Note (Collapsed by default) -->
  <% if authors_note_fields.any? %>
    <div class="collapse collapse-arrow bg-base-200 mt-6">
      <input type="checkbox" />
      <div class="collapse-title font-medium">
        <span class="icon-[lucide--sticky-note] size-4 mr-2"></span>
        <%= t("presets.form.authors_note_section", default: "Author's Note") %>
      </div>
      <div class="collapse-content">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 pt-2">
          <% authors_note_fields.sort_by { |f| f[:ui_order] || 999 }.each do |field| %>
            <%= render partial: "settings/fields/#{partial_for_field(field)}", locals: { field: field } %>
          <% end %>
        </div>
      </div>
    </div>
  <% end %>

  <!-- Advanced Settings (Collapsed by default) -->
  <% if more_fields.any? %>
    <div class="collapse collapse-arrow bg-base-200 mt-4">
      <input type="checkbox" />
      <div class="collapse-title font-medium">
        <span class="icon-[lucide--settings-2] size-4 mr-2"></span>
        <%= t("presets.form.advanced_settings", default: "Advanced Settings") %>
      </div>
      <div class="collapse-content">
        <% more_by_group.each do |group_name, group_fields| %>
          <div class="space-y-4 mt-4">
            <% if more_by_group.size > 1 %>
              <h4 class="font-medium text-base-content/80"><%= group_name %></h4>
            <% end %>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <% group_fields.sort_by { |f| f[:ui_order] || 999 }.each do |field| %>
                <%= render partial: "settings/fields/#{partial_for_field(field)}", locals: { field: field } %>
              <% end %>
            </div>
          </div>
        <% end %>
      </div>
    </div>
  <% end %>

  <!-- Actions -->
  <div class="flex gap-2 pt-4">
    <button type="submit" class="btn btn-primary gap-2">
      <span class="icon-[lucide--save] size-4"></span>
      <%= preset.persisted? ? t("common.save", default: "Save") : t("presets.create", default: "Create Preset") %>
    </button>
    <%= link_to settings_presets_path, class: "btn btn-ghost" do %>
      <%= t("common.cancel", default: "Cancel") %>
    <% end %>
  </div>
<% end %>
