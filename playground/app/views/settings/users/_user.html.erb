<%# User card for index listing %>
<%# locals: user: %>
<div id="user-<%= user.id %>"
     class="card bg-base-100 shadow-sm border border-base-300">
  <div class="card-body p-4">
    <!-- Header -->
    <div class="flex items-start justify-between gap-2">
      <div class="min-w-0">
        <h3 class="card-title text-lg flex items-center gap-2">
          <span class="truncate"><%= user.name %></span>
          <% if user == Current.user %>
            <span class="badge badge-primary badge-sm gap-1">
              <span class="icon-[lucide--user] size-3"></span>
              <%= t("users.status.you", default: "You") %>
            </span>
          <% end %>
          <span class="badge badge-<%= user.administrator? ? 'error' : (user.moderator? ? 'warning' : 'ghost') %> badge-sm">
            <%= user.role.humanize %>
          </span>
          <% if user.inactive? %>
            <span class="badge badge-warning badge-sm"><%= t("users.status.inactive", default: "Inactive") %></span>
          <% end %>
        </h3>
        <% if user.email.present? %>
          <p class="text-sm text-base-content/60 truncate"><%= user.email %></p>
        <% end %>
      </div>
    </div>

    <!-- User Details -->
    <div class="mt-3 grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
      <div>
        <span class="text-base-content/60 block"><%= t("users.stats.characters", default: "Characters") %></span>
        <span class="font-semibold text-lg"><%= user.characters_count %></span>
      </div>
      <div>
        <span class="text-base-content/60 block"><%= t("users.stats.lorebooks", default: "Lorebooks") %></span>
        <span class="font-semibold text-lg"><%= user.lorebooks_count %></span>
      </div>
      <div>
        <span class="text-base-content/60 block"><%= t("users.stats.conversations", default: "Conversations") %></span>
        <span class="font-semibold text-lg"><%= user.conversations_count %></span>
      </div>
      <div>
        <span class="text-base-content/60 block"><%= t("users.stats.messages", default: "Messages") %></span>
        <span class="font-semibold text-lg"><%= user.messages_count %></span>
      </div>
    </div>

    <!-- Joined Info -->
    <div class="mt-2 text-sm text-base-content/50">
      <span><%= t("users.joined", default: "Joined") %> <%= time_ago_in_words(user.created_at) %> <%= t("common.ago", default: "ago") %></span>
      <% if user.invited_by_code.present? %>
        <span class="ml-2">
          <%= t("users.via_invite", default: "via invite code") %>
          <code class="text-xs bg-base-200 px-1 rounded-selector"><%= user.invited_by_code.code %></code>
        </span>
      <% end %>
    </div>

    <!-- Quick Actions -->
    <div class="mt-3 pt-3 border-t border-base-200 flex items-center justify-between">
      <div class="flex flex-wrap gap-2">
        <%# Role selector dropdown - only if not self %>
        <% unless user == Current.user %>
          <div class="dropdown dropdown-bottom">
            <div tabindex="0" role="button" class="btn btn-sm btn-ghost gap-1">
              <span class="icon-[lucide--shield] size-4"></span>
              <%= t("users.actions.change_role", default: "Change Role") %>
              <span class="icon-[lucide--chevron-down] size-3"></span>
            </div>
            <ul tabindex="0" class="dropdown-content menu bg-base-100 rounded-box z-10 w-40 p-2 shadow-lg border border-base-300">
              <% User::ROLES.each do |role| %>
                <li>
                  <%= button_to update_role_settings_user_path(user),
                        method: :patch,
                        params: { role: role },
                        class: "#{user.role == role ? 'active' : ''}",
                        form: { data: { turbo_confirm: t("users.update_role.confirm", default: "Change role to %{role}?", role: role.humanize) } } do %>
                    <span class="icon-[lucide--check] size-4 <%= user.role == role ? '' : 'invisible' %>"></span>
                    <%= role.humanize %>
                  <% end %>
                </li>
              <% end %>
            </ul>
          </div>

          <%# Activate/Deactivate Toggle %>
          <% if user.inactive? %>
            <%= button_to toggle_status_settings_user_path(user),
                method: :post,
                class: "btn btn-sm btn-success btn-outline gap-1" do %>
              <span class="icon-[lucide--user-check] size-4"></span>
              <%= t("users.actions.activate", default: "Activate") %>
            <% end %>
          <% else %>
            <%= button_to toggle_status_settings_user_path(user),
                method: :post,
                class: "btn btn-sm btn-warning btn-outline gap-1",
                form: { data: { turbo_confirm: t("users.toggle_status.deactivate_confirm", default: "Deactivate this user? They will be logged out and unable to sign in.") } } do %>
              <span class="icon-[lucide--user-x] size-4"></span>
              <%= t("users.actions.deactivate", default: "Deactivate") %>
            <% end %>
          <% end %>
        <% else %>
          <span class="text-sm text-base-content/50 italic">
            <%= t("users.cannot_edit_self", default: "Cannot edit yourself") %>
          </span>
        <% end %>
      </div>
    </div>
  </div>
</div>
