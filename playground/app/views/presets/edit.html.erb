<% content_for :title, t("presets.edit_title", default: "Edit Preset") %>
<% content_for :main_class, "flex-1 p-4 md:p-6 lg:p-8" %>

<div class="max-w-2xl mx-auto space-y-6">
  <%# Breadcrumbs %>
  <div class="breadcrumbs text-sm">
    <ul>
      <li>
        <%= link_to presets_path do %>
          <span class="icon-[lucide--sliders-horizontal] size-4 mr-1"></span>
          <%= t("presets.title", default: "Presets") %>
        <% end %>
      </li>
      <li><%= @preset.name.truncate(30) %></li>
    </ul>
  </div>

  <%= form_with model: @preset, url: preset_path(@preset), method: :patch, class: "space-y-6" do |f| %>
    <%# Basic Info Card %>
    <div class="card bg-base-100 shadow-sm border border-base-300">
      <div class="card-body">
        <h2 class="card-title">
          <span class="icon-[lucide--sliders-horizontal] size-5"></span>
          <%= t("presets.form.basic_info", default: "Basic Info") %>
        </h2>

        <div class="space-y-4 mt-4">
          <%# Name %>
          <div class="form-control">
            <label class="label">
              <span class="label-text font-medium"><%= t("presets.form.name", default: "Name") %> <span class="text-error">*</span></span>
            </label>
            <%= f.text_field :name, class: "input input-bordered w-full", required: true %>
          </div>

          <%# Description %>
          <div class="form-control">
            <label class="label">
              <span class="label-text font-medium"><%= t("presets.form.description", default: "Description") %></span>
            </label>
            <%= f.text_area :description, class: "textarea textarea-bordered w-full h-20" %>
          </div>

          <%# LLM Provider %>
          <div class="form-control">
            <label class="label">
              <span class="label-text font-medium"><%= t("presets.form.llm_provider", default: "LLM Provider") %></span>
            </label>
            <%= f.select :llm_provider_id,
                         options_for_select(
                           [[t("presets.form.no_provider", default: "— Use default provider —"), ""]] +
                           @llm_providers.map { |p| [p.name, p.id] },
                           @preset.llm_provider_id
                         ),
                         {},
                         class: "select select-bordered w-full" %>
          </div>
        </div>
      </div>
    </div>

    <%# Generation Settings Card %>
    <div class="card bg-base-100 shadow-sm border border-base-300">
      <div class="card-body">
        <h2 class="card-title">
          <span class="icon-[lucide--cpu] size-5"></span>
          <%= t("presets.generation_settings", default: "Generation Settings") %>
        </h2>

        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mt-4">
          <% generation = @preset.generation_settings %>

          <%# Max Context Tokens %>
          <div class="form-control">
            <label class="label">
              <span class="label-text"><%= t("presets.form.max_context_tokens", default: "Max Context Tokens") %></span>
            </label>
            <%= f.number_field "generation_settings[max_context_tokens]",
                               value: generation&.max_context_tokens,
                               class: "input input-bordered w-full",
                               min: 0 %>
          </div>

          <%# Max Response Tokens %>
          <div class="form-control">
            <label class="label">
              <span class="label-text"><%= t("presets.form.max_response_tokens", default: "Max Response Tokens") %></span>
            </label>
            <%= f.number_field "generation_settings[max_response_tokens]",
                               value: generation&.max_response_tokens,
                               class: "input input-bordered w-full",
                               min: 0 %>
          </div>

          <%# Temperature %>
          <div class="form-control">
            <label class="label">
              <span class="label-text"><%= t("presets.form.temperature", default: "Temperature") %></span>
            </label>
            <%= f.number_field "generation_settings[temperature]",
                               value: generation&.temperature,
                               class: "input input-bordered w-full",
                               min: 0, max: 2, step: 0.01 %>
          </div>

          <%# Top P %>
          <div class="form-control">
            <label class="label">
              <span class="label-text"><%= t("presets.form.top_p", default: "Top P") %></span>
            </label>
            <%= f.number_field "generation_settings[top_p]",
                               value: generation&.top_p,
                               class: "input input-bordered w-full",
                               min: 0, max: 1, step: 0.01 %>
          </div>

          <%# Top K %>
          <div class="form-control">
            <label class="label">
              <span class="label-text"><%= t("presets.form.top_k", default: "Top K") %></span>
            </label>
            <%= f.number_field "generation_settings[top_k]",
                               value: generation&.top_k,
                               class: "input input-bordered w-full",
                               min: 0 %>
          </div>

          <%# Repetition Penalty %>
          <div class="form-control">
            <label class="label">
              <span class="label-text"><%= t("presets.form.repetition_penalty", default: "Repetition Penalty") %></span>
            </label>
            <%= f.number_field "generation_settings[repetition_penalty]",
                               value: generation&.repetition_penalty,
                               class: "input input-bordered w-full",
                               min: 0, max: 2, step: 0.01 %>
          </div>
        </div>
      </div>
    </div>

    <%# Actions %>
    <div class="flex gap-2">
      <%= f.submit t("common.save", default: "Save"), class: "btn btn-primary gap-2" %>
      <%= link_to t("common.cancel", default: "Cancel"), presets_path, class: "btn btn-ghost" %>
    </div>
  <% end %>

  <%# Danger Zone %>
  <div class="card bg-base-100 shadow-sm border border-error/30">
    <div class="card-body">
      <h3 class="card-title text-error">
        <span class="icon-[lucide--alert-triangle] size-5"></span>
        <%= t("presets.danger_zone", default: "Danger Zone") %>
      </h3>
      <p class="text-base-content/60 text-sm"><%= t("presets.danger_description", default: "Once you delete a preset, there is no going back.") %></p>
      <div class="card-actions mt-4">
        <%= button_to preset_path(@preset),
            method: :delete,
            class: "btn btn-error btn-outline gap-2",
            data: { turbo_confirm: t("presets.destroy_confirm", name: @preset.name, default: "Delete %{name}?") } do %>
          <span class="icon-[lucide--trash-2] size-4"></span>
          <%= t("common.delete", default: "Delete") %>
        <% end %>
      </div>
    </div>
  </div>
</div>
