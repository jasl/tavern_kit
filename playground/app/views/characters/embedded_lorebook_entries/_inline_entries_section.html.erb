<%# Inline Embedded Lorebook Entries Section - VibeTavern style %>
<%# locals: (character:, mode: :public) %>
<% editable = !character.locked? && (mode == :settings || character.user_id == Current.user&.id) %>
<% embedded_book = character.character_book %>
<% embedded_entries_data = Array(embedded_book&.entries) %>
<% presenters = embedded_entries_data.map { |e| EmbeddedLorebookEntryPresenter.new(e, character: character, mode: mode) } %>
<% new_entry_path = mode == :settings ? new_settings_character_embedded_lorebook_entry_path(character) : new_character_embedded_lorebook_entry_path(character) %>

<div id="<%= dom_id(character, :embedded_lorebook_entries) %>" class="card bg-base-100 shadow-sm border border-base-300">
  <div class="card-body">
    <%# Header %>
    <div class="flex items-center justify-between mb-4">
      <h2 class="card-title flex items-center gap-2">
        <span class="icon-[lucide--list] size-5"></span>
        <%= t("embedded_lorebook_entries.title", default: "Embedded Lorebook Entries") %>
        <span class="badge badge-sm badge-neutral"><%= presenters.size %></span>
      </h2>
      <div class="flex items-center gap-2">
        <% if editable && presenters.any? %>
          <span class="text-sm text-base-content/50">
            <%= t("embedded_lorebook_entries.drag_to_reorder", default: "Drag to reorder") %>
          </span>
        <% end %>
        <% if editable %>
          <%= link_to new_entry_path, class: "btn btn-primary btn-sm gap-1" do %>
            <span class="icon-[lucide--plus] size-4"></span>
            <%= t("embedded_lorebook_entries.new_entry", default: "New Entry") %>
          <% end %>
        <% end %>
      </div>
    </div>

    <% if character.locked? %>
      <div class="alert alert-warning mb-4">
        <span class="icon-[lucide--lock] size-5"></span>
        <span><%= t("characters.locked_notice", default: "This character is locked. Entries cannot be modified.") %></span>
      </div>
    <% end %>

    <%# Entries List %>
    <% if presenters.any? %>
      <div class="space-y-3"
           data-controller="sortable"
           data-sortable-url-value="<%= mode == :settings ? reorder_settings_character_embedded_lorebook_entries_path(character) : reorder_character_embedded_lorebook_entries_path(character) %>"
           data-sortable-disabled-value="<%= !editable %>">
        <% presenters.each do |presenter| %>
          <%= render "characters/embedded_lorebook_entries/inline_entry_row",
                     presenter: presenter,
                     character: character,
                     mode: mode,
                     editable: editable %>
        <% end %>
      </div>
    <% else %>
      <div class="text-center py-8">
        <span class="icon-[lucide--book-open] size-12 text-base-content/20 mb-4 block mx-auto"></span>
        <p class="text-base-content/50 mb-4">
          <%= t("embedded_lorebook_entries.empty.description", default: "No embedded entries yet. Embedded entries are stored directly in the character card.") %>
        </p>
        <% if editable %>
          <%= link_to new_entry_path, class: "btn btn-primary btn-sm gap-1" do %>
            <span class="icon-[lucide--plus] size-4"></span>
            <%= t("embedded_lorebook_entries.new_entry", default: "New Entry") %>
          <% end %>
        <% end %>
      </div>
    <% end %>
  </div>
</div>
