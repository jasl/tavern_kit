<%# Shared Character profile page body (used by both public + settings show pages) %>
<%# locals: (character:, mode:) %>
<% presenter = CharacterProfilePresenter.new(character: character, mode: mode) %>

<div class="space-y-6">
  <%# Breadcrumbs %>
  <div class="breadcrumbs text-sm">
    <ul>
      <li>
        <%= link_to presenter.index_path do %>
          <span class="icon-[lucide--users] size-4 mr-1"></span>
          <%= t("characters.index.title", default: "Characters") %>
        <% end %>
      </li>
      <li><%= character.name.truncate(30) %></li>
    </ul>
  </div>

  <%# Back button %>
  <%= link_to presenter.index_path, class: "btn btn-ghost btn-sm gap-2 -mt-4 mb-2" do %>
    <span class="icon-[lucide--arrow-left] size-4"></span>
    <%= t("common.back_to_list", default: "Back to List") %>
  <% end %>

  <%# Lock Banner %>
  <% if character.locked? %>
    <div class="alert alert-warning shadow-sm">
      <span class="icon-[lucide--lock] size-5"></span>
      <div>
        <div class="font-medium"><%= t("characters.show.locked_title", default: "This character is locked") %></div>
        <div class="text-sm opacity-80">
          <%= presenter.locked_hint %>
        </div>
      </div>
      <% if presenter.settings_mode? %>
        <%= button_to unlock_settings_character_path(character), method: :post, class: "btn btn-sm btn-warning" do %>
          <span class="icon-[lucide--unlock] size-4"></span>
          <%= t("common.unlock", default: "Unlock") %>
        <% end %>
      <% end %>
    </div>
  <% end %>

  <%# Header card %>
  <div class="card bg-base-100 shadow-lg border border-base-300">
    <div class="card-body">
      <div class="flex items-start justify-between gap-4">
        <div class="flex items-start gap-4 min-w-0">
          <%# Portrait %>
          <div class="shrink-0">
            <figure class="w-24 h-32 sm:w-32 sm:h-44 relative overflow-hidden rounded-box bg-base-200">
              <%= image_tag fresh_character_portrait_path(character),
                            class: "w-full h-full object-cover",
                            alt: character.name %>
            </figure>
          </div>

          <div class="min-w-0">
            <h1 class="text-2xl font-bold flex items-center gap-2 flex-wrap">
              <%= character.name %>
              <% if presenter.global? %>
                <span class="badge badge-sm badge-outline" title="<%= t("common.global", default: "Global") %>">
                  <span class="icon-[lucide--globe] size-3"></span>
                </span>
              <% end %>
              <% if character.locked? %>
                <span class="badge badge-sm badge-warning" title="<%= t("common.locked", default: "Locked") %>">
                  <span class="icon-[lucide--lock] size-3"></span>
                </span>
              <% end %>
              <% if character.draft? %>
                <span class="badge badge-sm badge-ghost" title="<%= t("common.draft", default: "Draft") %>">
                  <span class="icon-[lucide--eye-off] size-3"></span>
                </span>
              <% end %>
              <% if character.nsfw? %>
                <span class="badge badge-sm badge-error gap-1" title="<%= t("common.nsfw", default: "NSFW") %>">
                  <span class="icon-[lucide--shield-alert] size-3"></span>
                  NSFW
                </span>
              <% end %>
              <span class="badge badge-sm <%= character.v3? ? 'badge-primary' : 'badge-ghost' %>">
                <%= character.v3? ? "CCv3" : "CCv2" %>
              </span>
            </h1>
            <% if character.nickname.present? %>
              <p class="text-base-content/60 mt-1"><%= character.nickname %></p>
            <% end %>
          </div>
        </div>

        <%# Actions %>
        <div class="flex items-center gap-2">
          <% if presenter.can_edit? %>
            <%= link_to presenter.edit_path, class: "btn btn-sm btn-primary gap-1" do %>
              <span class="icon-[lucide--pencil] size-4"></span>
              <%= t("common.edit", default: "Edit") %>
            <% end %>
          <% end %>
          <%= button_to presenter.duplicate_path,
                method: :post,
                form: { data: { turbo_confirm: t("characters.duplicate_confirm", default: "Create a copy of this character?") } },
                class: "btn btn-sm btn-ghost gap-1" do %>
            <span class="icon-[lucide--copy] size-4"></span>
            <%= t("common.duplicate", default: "Duplicate") %>
          <% end %>
        </div>
      </div>

      <%# Meta info %>
      <div class="flex flex-wrap items-center gap-4 mt-4 pt-4 border-t border-base-200 text-sm text-base-content/60">
        <div class="flex items-center gap-1">
          <span class="icon-[lucide--user] size-4"></span>
          <% if character.user.present? %>
            <span><%= character.user.name %></span>
          <% else %>
            <span class="badge badge-xs badge-ghost"><%= t("common.system", default: "System") %></span>
          <% end %>
        </div>

        <% if character.creator.present? %>
          <div class="flex items-center gap-1">
            <span class="icon-[lucide--pen-tool] size-4"></span>
            <span><%= character.creator %></span>
          </div>
        <% end %>

        <% if character.character_version.present? %>
          <div class="flex items-center gap-1">
            <span class="icon-[lucide--git-branch] size-4"></span>
            <span><%= character.character_version %></span>
          </div>
        <% end %>

        <div class="flex items-center gap-1">
          <span class="icon-[lucide--message-square] size-4"></span>
          <span><%= number_with_delimiter(character.messages_count) %></span>
        </div>

        <% embedded_book = character.character_book %>
        <% embedded_entries_count = embedded_book.respond_to?(:entries) ? (embedded_book.entries&.size || 0) : 0 %>
        <% if embedded_entries_count > 0 %>
          <div class="flex items-center gap-1">
            <span class="icon-[lucide--book-open] size-4"></span>
            <span><%= embedded_entries_count %> <%= t("characters.lorebook_entries", default: "entries") %></span>
          </div>
        <% end %>

        <% if character.tags.any? %>
          <div class="flex items-center gap-1">
            <span class="icon-[lucide--tags] size-4"></span>
            <span><%= character.tags.first(5).join(", ") %><%= "+#{character.tags.size - 5}" if character.tags.size > 5 %></span>
          </div>
        <% end %>
      </div>
    </div>
  </div>

  <%# Character Definition Card %>
  <div class="card bg-base-100 shadow-sm border border-base-300">
    <div class="card-body">
      <h2 class="card-title">
        <span class="icon-[lucide--user-circle] size-5"></span>
        <%= t("characters.edit.character_definition", default: "Character Definition") %>
      </h2>
      <p class="text-sm text-base-content/60 mb-4">
        <%= t("characters.edit.character_definition_hint", default: "Core character attributes that define who they are. These fields support macros.") %>
      </p>

      <div class="space-y-6">
        <%# Description %>
        <div>
          <div class="text-sm text-base-content/60 mb-1">
            <span class="icon-[lucide--scroll-text] size-4 inline-block mr-1 align-text-bottom text-primary"></span>
            <%= t("characters.form.description", default: "Description") %>
          </div>
          <% if character.description.present? %>
            <div class="bg-base-200/50 p-4 rounded-box">
              <pre class="whitespace-pre-wrap font-mono text-sm"><%= character.description %></pre>
            </div>
          <% else %>
            <div class="text-base-content/40 italic"><%= t("common.not_set", default: "Not set") %></div>
          <% end %>
        </div>

        <%# Personality %>
        <div>
          <div class="text-sm text-base-content/60 mb-1">
            <span class="icon-[lucide--brain] size-4 inline-block mr-1 align-text-bottom text-secondary"></span>
            <%= t("characters.form.personality", default: "Personality") %>
          </div>
          <% if character.data_personality.present? %>
            <div class="bg-base-200/50 p-4 rounded-box">
              <pre class="whitespace-pre-wrap font-mono text-sm"><%= character.data_personality %></pre>
            </div>
          <% else %>
            <div class="text-base-content/40 italic"><%= t("common.not_set", default: "Not set") %></div>
          <% end %>
        </div>

        <%# Scenario %>
        <div>
          <div class="text-sm text-base-content/60 mb-1">
            <span class="icon-[lucide--map] size-4 inline-block mr-1 align-text-bottom text-accent"></span>
            <%= t("characters.form.scenario", default: "Scenario") %>
          </div>
          <% if character.scenario.present? %>
            <div class="bg-base-200/50 p-4 rounded-box">
              <pre class="whitespace-pre-wrap font-mono text-sm"><%= character.scenario %></pre>
            </div>
          <% else %>
            <div class="text-base-content/40 italic"><%= t("common.not_set", default: "Not set") %></div>
          <% end %>
        </div>
      </div>
    </div>
  </div>

  <%# Messages & Examples Card %>
  <div class="card bg-base-100 shadow-sm border border-base-300">
    <div class="card-body">
      <h2 class="card-title">
        <span class="icon-[lucide--message-square] size-5"></span>
        <%= t("characters.edit.messages_examples", default: "Messages & Examples") %>
      </h2>
      <p class="text-sm text-base-content/60 mb-4">
        <%= t("characters.edit.messages_examples_hint", default: "Opening messages and example dialogue that help the AI understand the character's voice.") %>
      </p>

      <div class="space-y-6">
        <%# First Message %>
        <div>
          <div class="text-sm text-base-content/60 mb-2">
            <span class="icon-[lucide--message-circle] size-4 inline-block mr-1 align-text-bottom text-info"></span>
            <%= t("characters.form.first_mes", default: "First Message") %>
          </div>
          <% if character.first_mes.present? %>
            <div class="mes">
              <div class="mes-avatar-wrapper">
                <div class="avatar">
                  <%= image_tag fresh_character_portrait_path(character),
                                class: "w-full h-full object-cover rounded-full" %>
                </div>
              </div>
              <div class="mes-block">
                <div class="mes-header">
                  <span class="mes-name"><%= character.name %></span>
                </div>
                <div class="mes-text prose prose-sm prose-theme max-w-none">
                  <p class="whitespace-pre-wrap"><%= character.first_mes %></p>
                </div>
              </div>
            </div>
          <% else %>
            <div class="text-base-content/40 italic"><%= t("common.not_set", default: "Not set") %></div>
          <% end %>
        </div>

        <%# Alternate Greetings %>
        <% if character.alternate_greetings.any? %>
          <div>
            <div class="text-sm text-base-content/60 mb-2">
              <%= t("characters.form.alternate_greetings", default: "Alternate Greetings") %>
              <span class="badge badge-xs badge-ghost ml-1"><%= character.alternate_greetings.size %></span>
            </div>
            <div class="collapse collapse-arrow bg-base-200/50 rounded-box">
              <input type="checkbox" />
              <div class="collapse-title text-sm font-medium">
                <%= t("characters.show.view_alternates", default: "View alternate greetings") %>
              </div>
              <div class="collapse-content space-y-4">
                <% character.alternate_greetings.each_with_index do |greeting, index| %>
                  <div class="mes opacity-80">
                    <div class="mes-avatar-wrapper">
                      <div class="avatar">
                        <%= image_tag fresh_character_portrait_path(character),
                                      class: "w-full h-full object-cover rounded-full" %>
                      </div>
                    </div>
                    <div class="mes-block">
                      <div class="mes-header">
                        <span class="mes-name text-sm"><%= character.name %></span>
                        <span class="badge badge-xs badge-ghost">#<%= index + 2 %></span>
                      </div>
                      <div class="mes-text prose prose-sm prose-theme max-w-none">
                        <p class="whitespace-pre-wrap text-sm"><%= greeting %></p>
                      </div>
                    </div>
                  </div>
                <% end %>
              </div>
            </div>
          </div>
        <% end %>

        <%# Group Only Greetings (CCv3) %>
        <% if character.v3? && character.group_only_greetings.any? %>
          <div>
            <div class="text-sm text-base-content/60 mb-2">
              <%= t("characters.form.group_only_greetings", default: "Group Chat Greetings") %>
              <span class="badge badge-xs badge-primary ml-1">CCv3</span>
              <span class="badge badge-xs badge-ghost ml-1"><%= character.group_only_greetings.size %></span>
            </div>
            <div class="space-y-4">
              <% character.group_only_greetings.each_with_index do |greeting, index| %>
                <div class="mes opacity-90">
                  <div class="mes-avatar-wrapper">
                    <div class="avatar">
                      <%= image_tag fresh_character_portrait_path(character),
                                    class: "w-full h-full object-cover rounded-full" %>
                    </div>
                  </div>
                  <div class="mes-block">
                    <div class="mes-header">
                      <span class="mes-name text-sm"><%= character.name %></span>
                      <span class="badge badge-xs badge-primary">Group #<%= index + 1 %></span>
                    </div>
                    <div class="mes-text prose prose-sm prose-theme max-w-none">
                      <p class="whitespace-pre-wrap text-sm"><%= greeting %></p>
                    </div>
                  </div>
                </div>
              <% end %>
            </div>
          </div>
        <% end %>

        <%# Example Dialogue %>
        <div>
          <div class="text-sm text-base-content/60 mb-1"><%= t("characters.form.mes_example", default: "Example Dialogue") %></div>
          <% if character.mes_example.present? %>
            <div class="bg-base-200/50 p-4 rounded-box">
              <pre class="whitespace-pre-wrap font-mono text-sm"><%= character.mes_example %></pre>
            </div>
          <% else %>
            <div class="text-base-content/40 italic"><%= t("common.not_set", default: "Not set") %></div>
          <% end %>
        </div>
      </div>
    </div>
  </div>

  <%# Prompt Control Card %>
  <div class="card bg-base-100 shadow-sm border border-base-300">
    <div class="card-body">
      <h2 class="card-title">
        <span class="icon-[lucide--terminal] size-5"></span>
        <%= t("characters.edit.prompt_control", default: "Prompt Control") %>
      </h2>
      <p class="text-sm text-base-content/60 mb-4">
        <%= t("characters.edit.prompt_control_hint", default: "Advanced settings that control how the character card influences prompt generation.") %>
      </p>

      <div class="space-y-6">
        <div>
          <div class="text-sm text-base-content/60 mb-1"><%= t("characters.form.system_prompt", default: "System Prompt") %></div>
          <% if character.system_prompt.present? %>
            <div class="mockup-code text-xs">
              <pre><code class="whitespace-pre-wrap"><%= character.system_prompt %></code></pre>
            </div>
          <% else %>
            <div class="text-base-content/40 italic"><%= t("common.not_set", default: "Not set") %></div>
          <% end %>
        </div>

        <div>
          <div class="text-sm text-base-content/60 mb-1"><%= t("characters.form.post_history_instructions", default: "Post-History Instructions") %></div>
          <% if character.post_history_instructions.present? %>
            <div class="bg-base-200/50 p-4 rounded-box">
              <pre class="whitespace-pre-wrap font-mono text-sm"><%= character.post_history_instructions %></pre>
            </div>
          <% else %>
            <div class="text-base-content/40 italic"><%= t("common.not_set", default: "Not set") %></div>
          <% end %>
        </div>
      </div>
    </div>
  </div>

  <%# Metadata Card %>
  <div class="card bg-base-100 shadow-sm border border-base-300">
    <div class="card-body">
      <h2 class="card-title">
        <span class="icon-[lucide--info] size-5"></span>
        <%= t("characters.edit.metadata", default: "Metadata") %>
      </h2>
      <p class="text-sm text-base-content/60 mb-4">
        <%= t("characters.edit.metadata_hint", default: "Information about the character card itself, including creator attribution and categorization.") %>
      </p>

      <div class="space-y-6">
        <div>
          <div class="text-sm text-base-content/60 mb-1"><%= t("characters.form.creator_notes", default: "Creator Notes") %></div>
          <% if character.creator_notes.present? %>
            <div class="bg-base-200/50 p-4 rounded-box">
              <pre class="whitespace-pre-wrap font-mono text-sm"><%= character.creator_notes %></pre>
            </div>
          <% else %>
            <div class="text-base-content/40 italic"><%= t("common.not_set", default: "Not set") %></div>
          <% end %>
        </div>

        <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
          <div>
            <div class="text-sm text-base-content/60"><%= t("characters.form.creator", default: "Creator") %></div>
            <div class="font-medium"><%= character.creator.presence || "—" %></div>
          </div>

          <div>
            <div class="text-sm text-base-content/60"><%= t("characters.form.character_version", default: "Version") %></div>
            <div class="font-medium"><%= character.character_version.presence || "—" %></div>
          </div>
        </div>

        <div>
          <div class="text-sm text-base-content/60 mb-1"><%= t("characters.form.tags", default: "Tags") %></div>
          <% if character.tags.any? %>
            <div class="flex flex-wrap gap-2">
              <% character.tags.each do |tag| %>
                <span class="badge badge-lg"><%= tag %></span>
              <% end %>
            </div>
          <% else %>
            <div class="text-base-content/40 italic"><%= t("common.none", default: "None") %></div>
          <% end %>
        </div>
      </div>
    </div>
  </div>

  <%# SillyTavern Extensions Card %>
  <% if character.data&.talkativeness? %>
  <div class="card bg-base-100 shadow-sm border border-base-300">
    <div class="card-body">
      <h2 class="card-title">
        <span class="icon-[lucide--puzzle] size-5"></span>
        <%= t("characters.extensions.title", default: "SillyTavern Extensions") %>
      </h2>
      <p class="text-sm text-base-content/60 mb-4">
        <%= t("characters.extensions.description", default: "SillyTavern-specific metadata stored in the character card.") %>
      </p>

      <div class="grid grid-cols-1 gap-6">
        <%# Talkativeness %>
        <div>
          <div class="text-sm text-base-content/60"><%= t("characters.extensions.talkativeness", default: "Talkativeness") %></div>
          <% if character.data&.talkativeness? %>
            <% talk_value = character.data.talkativeness_factor(default: 0.5) %>
            <div class="font-medium"><%= number_to_percentage(talk_value * 100, precision: 0) %> <span class="text-xs text-base-content/50">(<%= talk_value.round(2) %>)</span></div>
          <% else %>
            <div class="font-medium">—</div>
          <% end %>
        </div>
      </div>
    </div>
  </div>
  <% end %>

  <%# Author's Note Card %>
  <% an_settings = character.effective_authors_note_settings %>
  <div class="card bg-base-100 shadow-sm border border-base-300">
    <div class="card-body">
      <h2 class="card-title">
        <span class="icon-[lucide--pen-line] size-5"></span>
        <%= t("characters.authors_note.title", default: "Author's Note") %>
      </h2>
      <p class="text-sm text-base-content/60 mb-4">
        <%= t("characters.authors_note.description", default: "Default Author's Note settings for this character. Can be overridden per-space or per-conversation.") %>
      </p>

      <div class="space-y-6">
        <div class="flex items-center gap-3">
          <% if an_settings.use_character_authors_note %>
            <span class="badge badge-success gap-1">
              <span class="icon-[lucide--check] size-3"></span>
              <%= t("characters.authors_note.enabled", default: "Enabled") %>
            </span>
          <% else %>
            <span class="badge badge-ghost gap-1">
              <span class="icon-[lucide--x] size-3"></span>
              <%= t("characters.authors_note.disabled", default: "Disabled") %>
            </span>
          <% end %>
        </div>

        <% if an_settings.use_character_authors_note %>
          <div>
            <div class="text-sm text-base-content/60 mb-1"><%= t("characters.authors_note.content", default: "Content") %></div>
            <% if an_settings.authors_note.present? %>
              <div class="bg-base-200/50 p-4 rounded-box">
                <pre class="whitespace-pre-wrap font-mono text-sm"><%= an_settings.authors_note %></pre>
              </div>
            <% else %>
              <div class="text-base-content/40 italic"><%= t("common.not_set", default: "Not set") %></div>
            <% end %>
          </div>

          <div class="grid grid-cols-1 sm:grid-cols-3 gap-6">
            <div>
              <div class="text-sm text-base-content/60"><%= t("characters.authors_note.position", default: "Position") %></div>
              <div class="font-medium"><%= an_settings.authors_note_position || "in_chat" %></div>
            </div>
            <div>
              <div class="text-sm text-base-content/60"><%= t("characters.authors_note.depth", default: "Depth") %></div>
              <div class="font-medium"><%= an_settings.authors_note_depth || 4 %></div>
            </div>
            <div>
              <div class="text-sm text-base-content/60"><%= t("characters.authors_note.role", default: "Role") %></div>
              <div class="font-medium"><%= an_settings.authors_note_role || "system" %></div>
            </div>
          </div>

          <div>
            <div class="text-sm text-base-content/60"><%= t("characters.authors_note.combine_mode", default: "Space AN Combine Mode") %></div>
            <div class="font-medium"><%= an_settings.character_authors_note_position || "replace" %></div>
          </div>
        <% end %>
      </div>
    </div>
  </div>

  <%# Lorebooks Card %>
  <% lore_links = presenter.lorebook_links %>
  <% embedded_book = character.character_book %>
  <div class="card bg-base-100 shadow-sm border border-base-300">
    <div class="card-body">
      <h2 class="card-title">
        <span class="icon-[lucide--book-open] size-5"></span>
        <%= t("characters.edit.linked_lorebooks", default: "Lorebooks") %>
      </h2>
      <p class="text-sm text-base-content/60 mb-4">
        <%= t("characters.show.lorebooks_hint", default: "World Info and knowledge entries that activate based on keywords in the conversation.") %>
      </p>

      <div class="space-y-6">
        <%# Primary Lorebook %>
        <div>
          <div class="flex items-center gap-2 mb-3">
            <span class="icon-[lucide--book-open] size-4 text-primary"></span>
            <span class="font-medium"><%= t("characters.form.primary_lorebook", default: "Primary Lorebook") %></span>
          </div>
          <% if lore_links.primary_name.present? %>
            <div class="p-3 bg-base-200/50 rounded-box mb-2">
              <div class="flex items-center gap-2">
                <% if lore_links.primary_lorebook %>
                  <%= link_to presenter.lorebook_show_path(lore_links.primary_lorebook), class: "link link-hover font-medium" do %>
                    <%= lore_links.primary_name %>
                  <% end %>
                  <span class="badge badge-sm badge-success"><%= t("characters.form.active", default: "Active") %></span>
                  <span class="text-xs text-base-content/50"><%= pluralize(lore_links.primary_lorebook.entries_count.to_i, "entry") %></span>
                <% else %>
                  <span class="font-medium"><%= lore_links.primary_name %></span>
                  <span class="badge badge-xs badge-warning"><%= t("characters.form.not_found", default: "not found") %></span>
                <% end %>
              </div>

              <% if lore_links.primary_duplicates.any? %>
                <div role="alert" class="alert alert-warning alert-soft mt-3">
                  <span class="icon-[lucide--alert-triangle] size-5"></span>
                  <div class="min-w-0">
                    <div class="font-medium">
                      <%= t("characters.form.duplicate_lorebooks_title", default: "Duplicate lorebook names") %>
                    </div>
                    <div class="text-sm text-base-content/70">
                      <%= t("characters.form.duplicate_lorebooks_hint", default: "Multiple lorebooks share this name. This character will use the one marked Active. Consider renaming duplicates to avoid confusion.") %>
                    </div>
                    <div class="mt-2 flex flex-col gap-1">
                      <% lore_links.primary_duplicates.each do |dup| %>
                        <%= link_to presenter.lorebook_show_path(dup), class: "link link-hover text-sm" do %>
                          <%= dup.name %>
                          <span class="text-base-content/50">#<%= dup.id %></span>
                        <% end %>
                      <% end %>
                    </div>
                  </div>
                </div>
              <% end %>
            </div>
          <% else %>
            <div class="text-base-content/40 italic"><%= t("common.none", default: "None") %></div>
          <% end %>
        </div>

        <%# Additional Lorebooks %>
        <div>
          <div class="flex items-center gap-2 mb-3">
            <span class="icon-[lucide--book-open] size-4 text-secondary"></span>
            <span class="font-medium"><%= t("characters.form.additional_lorebooks", default: "Additional Lorebooks") %></span>
          </div>
          <% if lore_links.additional_names.any? %>
            <div class="space-y-2">
              <% lore_links.additional_names.each do |name| %>
                <% lb = lore_links.additional_lorebooks_by_name[name] %>
                <% duplicates = lore_links.additional_duplicates_by_name[name] || [] %>
                <div class="p-3 bg-base-200/50 rounded-box">
                  <div class="flex items-center gap-2">
                    <% if lb %>
                      <%= link_to presenter.lorebook_show_path(lb), class: "link link-hover font-medium" do %>
                        <%= name %>
                      <% end %>
                      <span class="badge badge-sm badge-success"><%= t("characters.form.active", default: "Active") %></span>
                      <span class="text-xs text-base-content/50"><%= pluralize(lb.entries_count.to_i, "entry") %></span>
                    <% else %>
                      <span class="font-medium"><%= name %></span>
                      <span class="badge badge-xs badge-warning"><%= t("characters.form.not_found", default: "not found") %></span>
                    <% end %>
                  </div>

                  <% if duplicates.any? %>
                    <div role="alert" class="alert alert-warning alert-soft mt-3">
                      <span class="icon-[lucide--alert-triangle] size-5"></span>
                      <div class="min-w-0">
                        <div class="font-medium">
                          <%= t("characters.form.duplicate_lorebooks_title", default: "Duplicate lorebook names") %>
                        </div>
                        <div class="text-sm text-base-content/70">
                          <%= t("characters.form.duplicate_lorebooks_hint", default: "Multiple lorebooks share this name. This character will use the one marked Active. Consider renaming duplicates to avoid confusion.") %>
                        </div>
                        <div class="mt-2 flex flex-col gap-1">
                          <% duplicates.each do |dup| %>
                            <%= link_to presenter.lorebook_show_path(dup), class: "link link-hover text-sm" do %>
                              <%= dup.name %>
                              <span class="text-base-content/50">#<%= dup.id %></span>
                            <% end %>
                          <% end %>
                        </div>
                      </div>
                    </div>
                  <% end %>
                </div>
              <% end %>
            </div>
          <% else %>
            <div class="text-base-content/40 italic"><%= t("common.none", default: "None") %></div>
          <% end %>
        </div>

        <%# Embedded Lorebook (character_book) %>
        <% embedded_entries = Array(embedded_book&.entries) %>
        <% if embedded_entries.any? %>
          <div>
            <div class="flex items-center gap-2 mb-3">
              <span class="icon-[lucide--book-marked] size-4 text-warning"></span>
              <span class="font-medium"><%= t("characters.form.embedded_lorebook", default: "Embedded Lorebook") %></span>
              <span class="badge badge-sm badge-warning"><%= embedded_entries.size %> entries</span>
            </div>
            <div class="space-y-2">
              <% embedded_entries.each do |entry| %>
                <%= render "characters/lorebook_entry", entry: entry %>
              <% end %>
            </div>
          </div>
        <% end %>
      </div>
    </div>
  </div>
</div>
