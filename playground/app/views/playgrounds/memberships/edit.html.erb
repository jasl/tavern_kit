<%# Space membership edit page %>
<% content_for :title, t("space_memberships.edit.title", default: "Edit Member") %>
<% content_for :main_class, "flex-1 p-4 md:p-6 lg:p-8" %>
<% space = @playground %>
<% membership = @membership %>
<% available_characters = @available_characters %>
<% conversation = space.conversations.root.first || space.conversations.first %>
<%
  card_talkativeness =
    if membership.kind_character? && membership.character&.data&.talkativeness?
      membership.character.data.talkativeness_factor(default: SpaceMembership::DEFAULT_TALKATIVENESS_FACTOR).to_f
    end

  talkativeness_override = membership.talkativeness_factor
%>

<div class="max-w-4xl mx-auto space-y-6">
  <%# Breadcrumbs %>
  <div class="breadcrumbs text-sm">
    <ul>
      <li>
        <%= link_to conversation ? conversation_path(conversation) : playground_path(space) do %>
          <span class="icon-[lucide--messages-square] size-4 mr-1"></span>
          <%= space.name.truncate(30) %>
        <% end %>
      </li>
      <li><%= membership.display_name.truncate(30) %></li>
    </ul>
  </div>

  <%# Back button %>
  <%= link_to conversation ? conversation_path(conversation) : playground_path(space), class: "btn btn-ghost btn-sm gap-2 -mt-4 mb-2" do %>
    <span class="icon-[lucide--arrow-left] size-4"></span>
    <%= t("space_memberships.back_to_chat", default: "Back to Chat") %>
  <% end %>

  <%= form_with model: membership, url: playground_membership_path(space, membership), method: :patch, class: "space-y-6" do |f| %>
    <%= hidden_field_tag :return_to, (conversation ? conversation_path(conversation) : playground_path(space)) %>

    <%# Errors %>
    <% if membership.errors.any? %>
      <div class="alert alert-error">
        <span class="icon-[lucide--alert-circle] size-5"></span>
        <div>
          <h3 class="font-bold"><%= t("space_memberships.form.errors", default: "Please fix the following errors:") %></h3>
          <ul class="list-disc list-inside text-sm mt-1">
            <% membership.errors.full_messages.each do |msg| %>
              <li><%= msg %></li>
            <% end %>
          </ul>
        </div>
      </div>
    <% end %>

    <%# Member Info %>
    <div class="card bg-base-100 shadow-sm border border-base-300">
      <div class="card-body">
        <div class="flex items-start gap-6">
          <div class="shrink-0">
            <%= chat_avatar(membership, size: :md) %>
          </div>

          <div class="flex-1 space-y-3">
            <h2 class="card-title">
              <span class="icon-[lucide--user] size-5"></span>
              <%= membership.display_name %>
            </h2>

            <p class="text-sm text-base-content/60">
              <% if membership.ai_character? %>
                <%= t("space_memberships.ai_character", default: "AI Character") %>
              <% elsif membership.human_with_persona? %>
                <%= t("space_memberships.user_with_persona", default: "User with Persona") %>
              <% elsif membership.pure_human? %>
                <%= t("space_memberships.user", default: "User") %>
              <% end %>
            </p>

            <div class="flex flex-wrap gap-2">
              <% if membership.ai_character? %>
                <span class="badge badge-sm badge-primary"><%= t("spaces.ai", default: "AI") %></span>
              <% elsif membership.auto_enabled? %>
                <span class="badge badge-sm badge-secondary"><%= t("spaces.auto", default: "Auto") %></span>
              <% end %>

              <% if membership.participation_muted? %>
                <span class="badge badge-sm badge-warning"><%= t("spaces.muted", default: "Muted") %></span>
              <% end %>
            </div>
          </div>
        </div>
      </div>
    </div>

    <%# Custom Persona %>
    <div class="card bg-base-100 shadow-sm border border-base-300">
      <div class="card-body">
        <h2 class="card-title">
          <span class="icon-[lucide--pen-line] size-5"></span>
          <%= t("space_memberships.form.custom_persona", default: "Custom Persona") %>
        </h2>

        <p class="text-sm text-base-content/60 mb-4">
          <% if membership.kind_human? && membership.character_id.blank? %>
            <%= t("space_memberships.form.custom_persona_hint_pure_human", default: "Optional: Describe your persona for AI interactions. This helps the AI understand your character better.") %>
          <% elsif membership.kind_human? %>
            <%= t("space_memberships.form.custom_persona_hint_user", default: "Override or supplement the character's personality with your own description. Leave empty to use the character's default personality.") %>
          <% else %>
            <%= t("space_memberships.form.custom_persona_hint_ai", default: "Override the AI character's personality with a custom description. Leave empty to use the character's default personality.") %>
          <% end %>
        </p>

        <label class="form-control mb-4">
          <div class="label">
            <span class="label-text font-medium">
              <%= t("space_memberships.form.name_override", default: "Display name in this playground") %>
            </span>
          </div>
          <%= f.text_field :name_override,
                           class: "input input-bordered w-full",
                           placeholder: membership.character&.name || membership.user&.name %>
          <div class="label">
            <span class="label-text-alt text-xs text-base-content/50">
              <%= t("space_memberships.form.name_override_hint", default: "Optional — overrides character and user names.") %>
            </span>
          </div>
        </label>

        <%= f.text_area :persona,
                        rows: 4,
                        class: "textarea textarea-bordered w-full",
                        placeholder: membership.character&.personality.presence || t("space_memberships.form.persona_placeholder", default: "Enter custom persona description...") %>

        <% if membership.character&.personality.present? %>
          <details class="mt-2">
            <summary class="text-xs text-base-content/50 cursor-pointer hover:text-base-content/70">
              <%= t("space_memberships.form.show_default_persona", default: "Show character's default personality") %>
            </summary>
            <div class="mt-2 p-3 bg-base-200 rounded-box text-sm text-base-content/70">
              <%= membership.character.personality %>
            </div>
          </details>
        <% end %>
      </div>
    </div>

    <%# Persona Character (only for human memberships) %>
    <% if membership.kind_human? %>
      <div class="card bg-base-100 shadow-sm border border-base-300">
        <div class="card-body">
          <h2 class="card-title">
            <span class="icon-[lucide--user-circle] size-5"></span>
            <%= t("space_memberships.form.persona_character", default: "Persona Character") %>
          </h2>

          <p class="text-sm text-base-content/60 mb-4">
            <%= t("space_memberships.form.persona_character_hint", default: "Choose a character to roleplay as. This enables Auto features like AI suggestions and Auto replies.") %>
          </p>

          <%# Character grid %>
          <div class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-5 gap-3">
            <%# No character option %>
            <label class="cursor-pointer">
              <input type="radio"
                     name="space_membership[character_id]"
                     value=""
                     <%= "checked" unless membership.character_id.present? %>
                     class="peer hidden" />
              <div class="card bg-base-100 hover:bg-base-300 peer-checked:ring-2 peer-checked:ring-primary peer-checked:bg-primary/10 transition-all h-full">
                <figure class="aspect-2/3 overflow-hidden rounded-t-box flex items-center justify-center bg-base-300">
                  <span class="icon-[lucide--user] size-10 text-base-content/30"></span>
                </figure>
                <div class="card-body p-2">
                  <p class="text-xs font-medium truncate text-center"><%= t("space_memberships.form.no_character", default: "No Character") %></p>
                </div>
              </div>
            </label>

            <%# Current character (if set and not in available list) %>
            <% if membership.character_id.present? %>
              <% current_char = membership.character %>
              <label class="cursor-pointer">
                <input type="radio"
                       name="space_membership[character_id]"
                       value="<%= current_char.id %>"
                       checked
                       class="peer hidden" />
                <div class="card bg-base-100 hover:bg-base-300 peer-checked:ring-2 peer-checked:ring-primary peer-checked:bg-primary/10 transition-all h-full">
                  <figure class="aspect-2/3 overflow-hidden rounded-t-box">
                    <% if current_char.portrait.attached? %>
                      <%= image_tag fresh_character_portrait_path(current_char),
                                    class: "w-full h-full object-cover",
                                    alt: current_char.name %>
                    <% else %>
                      <div class="w-full h-full flex items-center justify-center bg-base-300">
                        <span class="icon-[lucide--user] size-10 text-base-content/20"></span>
                      </div>
                    <% end %>
                  </figure>
                  <div class="card-body p-2">
                    <p class="text-xs font-medium truncate text-center"><%= current_char.name %></p>
                  </div>
                </div>
              </label>
            <% end %>

            <%# Available characters (skip current character as it's shown above) %>
            <% available_characters.each do |character| %>
              <% next if character.id == membership.character_id %>
              <label class="cursor-pointer">
                <input type="radio"
                       name="space_membership[character_id]"
                       value="<%= character.id %>"
                       class="peer hidden" />
                <div class="card bg-base-100 hover:bg-base-300 peer-checked:ring-2 peer-checked:ring-primary peer-checked:bg-primary/10 transition-all h-full">
                  <figure class="aspect-2/3 overflow-hidden rounded-t-box">
                    <% if character.portrait.attached? %>
                      <%= image_tag fresh_character_portrait_path(character),
                                    class: "w-full h-full object-cover",
                                    alt: character.name %>
                    <% else %>
                      <div class="w-full h-full flex items-center justify-center bg-base-300">
                        <span class="icon-[lucide--user] size-10 text-base-content/20"></span>
                      </div>
                    <% end %>
                  </figure>
                  <div class="card-body p-2">
                    <p class="text-xs font-medium truncate text-center"><%= character.name %></p>
                  </div>
                </div>
              </label>
            <% end %>
          </div>

          <% if available_characters.empty? && !membership.character_id.present? %>
            <div class="alert alert-warning mt-4">
              <span class="icon-[lucide--alert-triangle] size-5"></span>
              <span><%= t("space_memberships.form.no_available_characters", default: "No characters available. All characters are already in this space as AI participants.") %></span>
            </div>
          <% end %>
        </div>
      </div>
    <% end %>

    <%# Talkativeness %>
    <div class="card bg-base-100 shadow-sm border border-base-300">
      <div class="card-body">
        <h2 class="card-title">
          <span class="icon-[lucide--activity] size-5"></span>
          <%= t("space_memberships.talkativeness.title", default: "Talkativeness") %>
        </h2>
        <p class="text-sm text-base-content/60 mb-4">
          <%= t("space_memberships.talkativeness.description", default: "Controls group-chat initiative and (in Natural mode) how likely this participant is to speak.") %>
        </p>

        <div class="form-control">
          <label class="label py-1">
            <span class="label-text font-medium"><%= t("space_memberships.talkativeness.factor", default: "Talkativeness factor") %></span>
            <span class="label-text-alt text-xs text-base-content/50">0.0–1.0</span>
          </label>
          <%= f.number_field :talkativeness_factor,
                             value: talkativeness_override,
                             class: "input input-bordered w-full",
                             min: 0, max: 1, step: 0.1,
                             placeholder: (card_talkativeness || SpaceMembership::DEFAULT_TALKATIVENESS_FACTOR) %>
          <label class="label py-0.5">
            <span class="label-text-alt text-base-content/50">
              <% if membership.kind_character? && card_talkativeness %>
                <%= t("space_memberships.talkativeness.hint_ai", default: "Blank = use character card talkativeness (%{value}).", value: card_talkativeness) %>
              <% else %>
                <%= t("space_memberships.talkativeness.hint_default", default: "Blank = use default (%{value}).", value: SpaceMembership::DEFAULT_TALKATIVENESS_FACTOR) %>
              <% end %>
              <%= " " %>
              <%= t("space_memberships.talkativeness.effective", default: "Effective now: %{value}", value: membership.effective_talkativeness_factor.to_f.round(2)) %>
            </span>
          </label>
        </div>
      </div>
    </div>

    <%# Auto Settings (only for human memberships) %>
    <% if membership.kind_human? %>
      <div class="card bg-base-100 shadow-sm border border-base-300" id="auto_settings">
        <div class="card-body">
          <h2 class="card-title">
            <span class="icon-[lucide--bot] size-5"></span>
          <%= t("space_memberships.form.auto_settings", default: "Auto Settings") %>
          </h2>

          <p class="text-sm text-base-content/60 mb-4">
          <%= t("space_memberships.form.auto_hint", default: "Auto can automatically reply as your character (step-limited).") %>
          </p>

          <div class="space-y-3">
            <%# None mode %>
            <label class="flex items-start gap-3 p-3 bg-base-100 rounded-box cursor-pointer hover:bg-base-200 transition-colors">
              <%= f.radio_button :auto, "none", checked: membership.auto_none?, class: "radio radio-primary mt-0.5" %>
              <div class="flex-1">
                <span class="font-medium"><%= t("space_memberships.auto.none", default: "Manual") %></span>
                <p class="text-sm text-base-content/60 mt-0.5">
                  <%= t("space_memberships.auto.none_hint", default: "You write and send messages manually.") %>
                </p>
              </div>
            </label>

            <%# Auto mode %>
            <label class="flex flex-wrap items-start gap-3 p-3 bg-base-100 rounded-box cursor-pointer hover:bg-base-200 transition-colors">
              <%= f.radio_button :auto, "auto", checked: membership.auto_enabled?, class: "radio radio-primary mt-0.5 peer" %>
              <div class="flex-1">
                <span class="font-medium"><%= t("space_memberships.auto.enabled", default: "Auto") %></span>
                <p class="text-sm text-base-content/60 mt-0.5">
                  <%= t("space_memberships.auto.enabled_hint", default: "AI automatically replies as your character. Manual input is disabled.") %>
                </p>
              </div>

              <div class="w-full pl-9 hidden peer-checked:block">
                <label class="form-control w-fit">
                  <div class="label py-1">
                    <span class="label-text text-sm"><%= t("space_memberships.auto.steps", default: "Auto Steps") %></span>
                    <span class="label-text-alt text-xs text-base-content/50">1–10</span>
                  </div>
                  <%= f.number_field :auto_remaining_steps,
                                     min: 1,
                                     max: 10,
                                     step: 1,
                                     value: membership.auto_remaining_steps.to_i.positive? ? membership.auto_remaining_steps : SpaceMembership::DEFAULT_AUTO_STEPS,
                                     class: "input input-bordered input-sm w-28" %>
                </label>
              </div>
            </label>
          </div>

          <% if membership.character_id.blank? %>
            <div class="alert alert-info mt-4 text-sm">
              <span class="icon-[lucide--info] size-4"></span>
              <span><%= t("space_memberships.auto.no_character_hint", default: "Without a character, Auto will use your display name. Add a custom persona above for more personality.") %></span>
            </div>
          <% end %>
        </div>
      </div>
    <% end %>

    <%# Actions %>
    <div class="flex gap-2">
      <%= f.submit t("space_memberships.form.save", default: "Save Changes"),
                   class: "btn btn-primary gap-2" %>
      <%= link_to t("space_memberships.form.cancel", default: "Cancel"),
                  conversation ? conversation_path(conversation) : playground_path(space),
                  class: "btn btn-ghost" %>
    </div>
  <% end %>

  <%# Remove Section (only for AI characters) %>
  <% if membership.kind_character? %>
    <div class="card bg-base-100 shadow-sm border border-error/30">
      <div class="card-body">
        <h3 class="card-title text-error">
          <span class="icon-[lucide--alert-triangle] size-5"></span>
          <%= t("space_memberships.danger_zone", default: "Danger Zone") %>
        </h3>

        <p class="text-sm text-base-content/60 mb-4">
          <%= t("space_memberships.remove_description", default: "Removing this member will remove them from speaker selection. Their message history will be preserved.") %>
        </p>

        <%= button_to playground_membership_path(space, membership),
                      method: :delete,
                      class: "btn btn-error btn-outline gap-2",
                      data: { turbo_confirm: t("space_memberships.remove_confirm", default: "Remove this member from the space?") } do %>
          <span class="icon-[lucide--trash-2] size-4"></span>
          <%= t("space_memberships.remove_member", default: "Remove Member") %>
        <% end %>
      </div>
    </div>
  <% end %>
</div>
