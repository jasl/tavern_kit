<% content_for :title, t("space_memberships.new.title", default: "Add Member") %>
<% content_for :main_class, "flex-1 p-4 md:p-6 lg:p-8" %>

<%
  # Get IDs of characters already in this playground
  excluded_character_ids = @playground.space_memberships.active.kind_character.pluck(:character_id)
%>

<div class="max-w-4xl mx-auto">
  <div class="card bg-base-100 shadow-lg">
    <div class="card-body">
      <h1 class="card-title text-2xl mb-4 flex items-center gap-3">
        <span class="icon-[lucide--user-plus] size-7 text-primary"></span>
        <%= t("space_memberships.new.title", default: "Add Member") %>
      </h1>

      <p class="text-base-content/60 mb-6">
        <%= t("space_memberships.new.description_multi", default: "Select one or more AI characters to add to this space.") %>
      </p>

      <%= form_with url: playground_memberships_path(@playground),
                    method: :post,
                    class: "space-y-6",
                    data: { controller: "character-picker-form" } do |f| %>

        <%# Character Picker Component %>
        <%= render "shared/character_picker",
                   selected_ids: [],
                   excluded_ids: excluded_character_ids,
                   field_name: "character_ids[]" %>

        <div class="flex gap-3 justify-end pt-4">
          <% conversation = @playground.conversations.root.first %>
          <%= link_to t("common.cancel", default: "Cancel"),
                      conversation ? conversation_path(conversation) : playground_path(@playground),
                      class: "btn btn-ghost" %>
          <%= f.submit t("space_memberships.new.add_members", default: "Add Selected Members"),
                       class: "btn btn-primary gap-2" %>
        </div>
      <% end %>

      <div class="divider text-xs text-base-content/50"><%= t("common.or", default: "OR") %></div>

      <div class="text-center">
        <%= link_to characters_path, class: "btn btn-ghost btn-sm gap-2" do %>
          <span class="icon-[lucide--upload] size-4"></span>
          <%= t("space_memberships.new.upload_character", default: "Upload New Character") %>
        <% end %>
      </div>
    </div>
  </div>
</div>
