<% content_for :title, t("playgrounds.index.title", default: "Chats") %>
<% content_for :main_class, "flex-1 p-4 md:p-6 lg:p-8" %>

<div class="max-w-4xl mx-auto">
  <%# Header %>
  <div class="flex items-center justify-between mb-6">
    <h1 class="text-2xl font-bold flex items-center gap-3">
      <span class="icon-[lucide--messages-square] size-7 text-primary"></span>
      <%= t("playgrounds.index.title", default: "Chats") %>
    </h1>

    <%= link_to new_playground_path, class: "btn btn-primary gap-2" do %>
      <span class="icon-[lucide--plus] size-4"></span>
      <%= t("playgrounds.index.new_chat", default: "New Chat") %>
    <% end %>
  </div>

  <%# Playgrounds list %>
  <% if @page.records.any? %>
    <div class="space-y-3">
      <% @page.records.each do |playground| %>
        <%= link_to playground_path(playground), class: "card bg-base-100 hover:bg-base-200 transition-colors cursor-pointer" do %>
          <div class="card-body p-4 flex-row items-center gap-4">
            <%# Character avatars %>
            <div class="avatar-group -space-x-4">
              <% playground.characters.first(3).each do |character| %>
                <div class="avatar">
                  <div class="w-10 h-10 rounded-full overflow-hidden bg-base-200">
                    <%= image_tag fresh_character_portrait_path(character),
                                  class: "w-full h-full object-cover",
                                  alt: character.name %>
                  </div>
                </div>
              <% end %>
              <% if playground.characters.size > 3 %>
                <div class="avatar placeholder">
                  <div class="w-10 h-10 rounded-full bg-neutral text-neutral-content">
                    <span class="text-xs">+<%= playground.characters.size - 3 %></span>
                  </div>
                </div>
              <% end %>
            </div>

            <%# Playground info %>
            <div class="flex-1 min-w-0">
              <h3 class="font-medium truncate"><%= playground.name %></h3>
              <% if playground.last_message_content.present? %>
                <p class="text-sm text-base-content/50 truncate">
                  <%= truncate(playground.last_message_content, length: 60) %>
                </p>
              <% else %>
                <p class="text-sm text-base-content/40 italic">
                  <%= t("playgrounds.index.no_messages", default: "No messages yet") %>
                </p>
              <% end %>
            </div>

            <%# Timestamp (use last message time if available, otherwise updated_at) %>
            <div class="text-xs text-base-content/40 shrink-0">
              <%= time_ago_in_words(playground.last_message_at || playground.updated_at) %>
            </div>

            <%# Arrow %>
            <span class="icon-[lucide--chevron-right] size-5 text-base-content/30"></span>
          </div>
        <% end %>
      <% end %>
    </div>

    <%# Pagination %>
    <%= render "shared/pagination", page: @page, path_helper: :playgrounds_path %>
  <% else %>
    <%# Empty state %>
    <div class="card bg-base-100 p-12 text-center">
      <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-base-200 mx-auto mb-4">
        <span class="icon-[lucide--message-circle] size-8 text-base-content/40"></span>
      </div>
      <h3 class="text-lg font-medium mb-2">
        <%= t("playgrounds.index.empty_title", default: "No chats yet") %>
      </h3>
      <p class="text-base-content/60 mb-6">
        <%= t("playgrounds.index.empty_description", default: "Start a conversation with an AI character.") %>
      </p>
      <%= link_to new_playground_path, class: "btn btn-primary gap-2" do %>
        <span class="icon-[lucide--plus] size-4"></span>
        <%= t("playgrounds.index.start_chat", default: "Start Chat") %>
      <% end %>
    </div>
  <% end %>

  <%# Archived playgrounds (if any) %>
  <% if @archived_playgrounds.any? %>
    <div class="mt-8">
      <div class="collapse collapse-arrow bg-base-200 rounded-box">
        <input type="checkbox" />
        <div class="collapse-title font-medium text-base-content/60">
          <span class="icon-[lucide--archive] size-4 mr-2"></span>
          <%= t("playgrounds.index.archived", default: "Archived Chats") %> (<%= @archived_playgrounds.count %>)
        </div>
        <div class="collapse-content">
          <div class="space-y-2 pt-2">
            <% @archived_playgrounds.each do |playground| %>
              <%= link_to playground_path(playground), class: "block p-3 rounded-lg hover:bg-base-300 transition-colors" do %>
                <span class="font-medium"><%= playground.name %></span>
                <span class="text-xs text-base-content/40 ml-2">
                  <%= time_ago_in_words(playground.updated_at) %>
                </span>
              <% end %>
            <% end %>
          </div>
        </div>
      </div>
    </div>
  <% end %>
</div>
