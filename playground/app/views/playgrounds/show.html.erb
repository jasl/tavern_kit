<% content_for :title, @playground.name %>
<% content_for :main_class, "flex-1 p-4 md:p-6 lg:p-8" %>

<div class="max-w-4xl mx-auto space-y-6">
  <div class="flex items-start justify-between gap-4">
    <div class="min-w-0">
      <h1 class="text-2xl font-bold truncate"><%= @playground.name %></h1>
    </div>

    <%= link_to conversations_path, class: "btn btn-ghost btn-sm gap-2" do %>
      <span class="icon-[lucide--arrow-left] size-4"></span>
      <%= t("playgrounds.show.back", default: "Back") %>
    <% end %>
  </div>

  <div class="card bg-base-100">
    <div class="card-body space-y-4">
      <div class="flex items-center justify-between">
        <h2 class="card-title text-lg">
          <span class="icon-[lucide--users] size-5 text-primary"></span>
          <%= t("playgrounds.show.members", default: "Members") %>
        </h2>
      </div>

      <div class="space-y-2">
        <% @space_memberships.each do |membership| %>
          <div class="flex items-center justify-between gap-3 p-3 rounded-lg bg-base-200">
            <div class="min-w-0">
              <div class="font-medium truncate"><%= membership.display_name %></div>
              <div class="text-xs text-base-content/50">
                <%= membership.kind %>
                ·
                <%= t("space_memberships.position", default: "Position") %>: <%= membership.position %>
                <% unless membership.participation_active? %>
                  · <%= t("space_memberships.muted", default: "Muted") %>
                <% end %>
              </div>
            </div>

            <% if membership.kind_character? %>
              <div class="flex items-center gap-2 shrink-0">
                <%= button_to(
                      membership.participation_active? ? t("space_memberships.mute", default: "Mute") : t("space_memberships.unmute", default: "Unmute"),
                      playground_membership_path(@playground, membership),
                      method: :patch,
                      params: { space_membership: { participation: membership.participation_active? ? "muted" : "active" } },
                      class: "btn btn-ghost btn-sm"
                    ) %>

                <%= button_to(
                      t("space_memberships.remove", default: "Remove"),
                      playground_membership_path(@playground, membership),
                      method: :delete,
                      class: "btn btn-ghost btn-sm text-error",
                      data: { turbo_confirm: t("space_memberships.remove_confirm", default: "Remove this character from the playground?") }
                    ) %>
              </div>
            <% end %>
          </div>
        <% end %>
      </div>

      <div class="divider"></div>

      <div class="space-y-2">
        <h3 class="font-medium flex items-center gap-2">
          <span class="icon-[lucide--bot] size-4 text-primary"></span>
          <%= t("playgrounds.show.add_character", default: "Add AI Character") %>
        </h3>

        <% if @available_characters.any? %>
          <%= form_with url: playground_memberships_path(@playground),
                        scope: :space_membership,
                        method: :post,
                        class: "flex gap-2 items-center" do |f| %>
            <%= f.select :character_id,
                         options_from_collection_for_select(@available_characters, :id, :name),
                         {},
                         class: "select select-bordered flex-1" %>
            <%= f.submit t("playgrounds.show.add", default: "Add"), class: "btn btn-primary" %>
          <% end %>
        <% else %>
          <div class="alert alert-warning text-sm">
            <span class="icon-[lucide--alert-triangle] size-4"></span>
            <span><%= t("playgrounds.show.no_characters", default: "No characters available. Upload one first.") %></span>
            <%= link_to t("playgrounds.show.upload_character", default: "Upload Character"), characters_path, class: "btn btn-sm btn-ghost" %>
          </div>
        <% end %>
      </div>
    </div>
  </div>

  <div class="card bg-base-100">
    <div class="card-body space-y-4">
      <div class="flex items-center justify-between gap-3">
        <h2 class="card-title text-lg">
          <span class="icon-[lucide--messages-square] size-5 text-primary"></span>
          <%= t("playgrounds.show.conversations", default: "Conversations") %>
        </h2>

        <%= form_with url: playground_conversations_path(@playground),
                      scope: :conversation,
                      method: :post,
                      class: "flex items-center gap-2" do |f| %>
          <%= f.text_field :title,
                           class: "input input-bordered input-sm w-56",
                           placeholder: t("playgrounds.show.conversation_title", default: "Conversation title") %>
          <%= f.submit t("playgrounds.show.new_conversation", default: "New"), class: "btn btn-primary btn-sm" %>
        <% end %>
      </div>

      <% if @conversations.any? %>
        <%= render "playgrounds/conversation_tree", conversations: @conversations %>
      <% else %>
        <p class="text-sm text-base-content/60">
          <%= t("playgrounds.show.no_conversations", default: "No conversations yet. Create one to start chatting.") %>
        </p>
      <% end %>
    </div>
  </div>
</div>
