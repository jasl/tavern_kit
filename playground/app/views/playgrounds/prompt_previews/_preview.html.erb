<%# Prompt preview content for modal %>
<%# locals: (messages:, token_count:, tokenized_messages:, generation_params:) %>

<div class="space-y-4">
  <%# Header with token count %>
  <div class="flex items-center justify-between text-sm">
    <span class="text-base-content/60">
      <span class="icon-[lucide--message-square] size-4 mr-1"></span>
      <%= messages.size %> <%= messages.size == 1 ? "message" : "messages" %>
    </span>
    <span class="badge badge-info badge-outline gap-1">
      <span class="icon-[lucide--hash] size-3"></span>
      ~<%= number_with_delimiter(token_count) %> tokens
    </span>
  </div>

  <%# Tabs for Messages and Token Inspector %>
  <div role="tablist" class="tabs tabs-box">
    <input type="radio" name="preview_tabs" role="tab" class="tab" aria-label="Messages" checked="checked" />
    <div role="tabpanel" class="tab-content p-4 bg-base-100 border-base-300 rounded-box">
      <%# Messages list %>
      <div class="space-y-3 max-h-[50vh] overflow-y-auto">
        <% messages.each_with_index do |message, index| %>
          <%
            role = message[:role].to_s
            role_class = case role
            when "system" then "bg-warning/10 border-warning/30"
            when "assistant" then "bg-secondary/10 border-secondary/30"
            when "user" then "bg-primary/10 border-primary/30"
            else "bg-base-200 border-base-300"
            end
            role_badge_class = case role
            when "system" then "badge-warning"
            when "assistant" then "badge-secondary"
            when "user" then "badge-primary"
            else "badge-ghost"
            end
          %>
          <div class="border rounded-lg <%= role_class %> overflow-hidden">
            <%# Role header %>
            <div class="px-3 py-2 bg-base-100/50 border-b border-inherit flex items-center justify-between">
              <span class="badge badge-sm <%= role_badge_class %>">
                <%= role.capitalize %>
              </span>
              <% if message[:name].present? %>
                <span class="text-xs text-base-content/50"><%= message[:name] %></span>
              <% end %>
            </div>

            <%# Content %>
            <div class="p-3">
              <pre class="text-sm whitespace-pre-wrap break-words font-mono text-base-content/80"><%= message[:content] %></pre>
            </div>

            <%# Token estimate for this message %>
            <div class="px-3 py-1 border-t border-inherit text-xs text-base-content/40 text-right">
              ~<%= TavernKit::TokenEstimator.default.estimate(message[:content].to_s) %> tokens
            </div>
          </div>
        <% end %>
      </div>
    </div>

    <input type="radio" name="preview_tabs" role="tab" class="tab" aria-label="Token Inspector" />
    <div role="tabpanel" class="tab-content p-4 bg-base-100 border-base-300 rounded-box">
      <%# Token Inspector %>
      <div class="space-y-4 max-h-[50vh] overflow-y-auto">
        <% tokenized_messages.each_with_index do |msg, index| %>
          <%
            role = msg[:role].to_s
            role_class = case role
            when "system" then "bg-warning/10 border-warning/30"
            when "assistant" then "bg-secondary/10 border-secondary/30"
            when "user" then "bg-primary/10 border-primary/30"
            else "bg-base-200 border-base-300"
            end
            role_badge_class = case role
            when "system" then "badge-warning"
            when "assistant" then "badge-secondary"
            when "user" then "badge-primary"
            else "badge-ghost"
            end
          %>
          <div class="border rounded-lg <%= role_class %> overflow-hidden">
            <%# Role header %>
            <div class="px-3 py-2 bg-base-100/50 border-b border-inherit flex items-center justify-between">
              <div class="flex items-center gap-2">
                <span class="badge badge-sm <%= role_badge_class %>">
                  <%= role.capitalize %>
                </span>
                <% if msg[:name].present? %>
                  <span class="text-xs text-base-content/50"><%= msg[:name] %></span>
                <% end %>
              </div>
              <span class="text-xs text-base-content/40">
                <%= msg[:tokens].size %> tokens
              </span>
            </div>

            <%# Tokenized content %>
            <div class="p-3 font-mono text-sm leading-relaxed">
              <% msg[:tokens].each_with_index do |token, token_idx| %>
                <span class="token-chunk tooltip cursor-help"
                      data-tip="ID: <%= token[:id] %>"
                      style="--token-idx: <%= token_idx %>"><%= token[:text].gsub("\n", "↵\n") %></span>
              <% end %>
            </div>
          </div>
        <% end %>
      </div>
    </div>

    <input type="radio" name="preview_tabs" role="tab" class="tab" aria-label="Parameters" />
    <div role="tabpanel" class="tab-content p-4 bg-base-100 border-base-300 rounded-box">
      <%# Generation Parameters %>
      <div class="space-y-6 max-h-[50vh] overflow-y-auto">
        <%# Provider Section %>
        <div class="space-y-2">
          <h4 class="text-sm font-semibold flex items-center gap-2 text-base-content/80">
            <span class="icon-[lucide--server] size-4"></span>
            <%= t("prompt_preview.provider", default: "LLM Provider") %>
          </h4>
          <div class="grid grid-cols-2 gap-2 text-sm">
            <div class="bg-base-200/50 rounded-lg p-3">
              <div class="text-xs text-base-content/50 mb-1"><%= t("prompt_preview.provider_name", default: "Provider") %></div>
              <div class="font-medium"><%= generation_params[:provider_name] || "—" %></div>
            </div>
            <div class="bg-base-200/50 rounded-lg p-3">
              <div class="text-xs text-base-content/50 mb-1"><%= t("prompt_preview.model", default: "Model") %></div>
              <div class="font-mono text-xs"><%= generation_params[:model] || "—" %></div>
            </div>
            <div class="bg-base-200/50 rounded-lg p-3 col-span-2">
              <div class="text-xs text-base-content/50 mb-1"><%= t("prompt_preview.base_url", default: "Base URL") %></div>
              <div class="font-mono text-xs truncate"><%= generation_params[:base_url] || "—" %></div>
            </div>
          </div>
        </div>

        <%# Preset Section %>
        <div class="space-y-2">
          <h4 class="text-sm font-semibold flex items-center gap-2 text-base-content/80">
            <span class="icon-[lucide--bookmark] size-4"></span>
            <%= t("prompt_preview.preset", default: "Preset") %>
          </h4>
          <div class="bg-base-200/50 rounded-lg p-3">
            <div class="flex items-center justify-between">
              <span class="font-medium"><%= generation_params[:preset_name] || "Default" %></span>
              <span class="badge badge-ghost badge-sm">ID: <%= generation_params[:preset_id] || "—" %></span>
            </div>
          </div>
        </div>

        <%# Generation Settings Section %>
        <div class="space-y-2">
          <h4 class="text-sm font-semibold flex items-center gap-2 text-base-content/80">
            <span class="icon-[lucide--sliders-horizontal] size-4"></span>
            <%= t("prompt_preview.generation_settings", default: "Generation Settings") %>
          </h4>
          <div class="grid grid-cols-2 sm:grid-cols-3 gap-2 text-sm">
            <div class="bg-base-200/50 rounded-lg p-3">
              <div class="text-xs text-base-content/50 mb-1"><%= t("settings.temperature", default: "Temperature") %></div>
              <div class="font-mono font-medium text-primary">
                <%= generation_params[:temperature].present? ? number_with_precision(generation_params[:temperature], precision: 2) : "—" %>
              </div>
            </div>
            <div class="bg-base-200/50 rounded-lg p-3">
              <div class="text-xs text-base-content/50 mb-1"><%= t("settings.top_p", default: "Top P") %></div>
              <div class="font-mono font-medium text-secondary">
                <%= generation_params[:top_p].present? ? number_with_precision(generation_params[:top_p], precision: 2) : "—" %>
              </div>
            </div>
            <div class="bg-base-200/50 rounded-lg p-3">
              <div class="text-xs text-base-content/50 mb-1"><%= t("settings.top_k", default: "Top K") %></div>
              <div class="font-mono font-medium text-accent">
                <%= generation_params[:top_k].present? ? generation_params[:top_k] : "—" %>
              </div>
            </div>
            <div class="bg-base-200/50 rounded-lg p-3">
              <div class="text-xs text-base-content/50 mb-1"><%= t("settings.repetition_penalty", default: "Rep. Penalty") %></div>
              <div class="font-mono font-medium">
                <%= generation_params[:repetition_penalty].present? ? number_with_precision(generation_params[:repetition_penalty], precision: 2) : "—" %>
              </div>
            </div>
            <div class="bg-base-200/50 rounded-lg p-3">
              <div class="text-xs text-base-content/50 mb-1"><%= t("settings.max_context_tokens", default: "Max Context") %></div>
              <div class="font-mono font-medium">
                <%= generation_params[:max_context_tokens].present? ? number_with_delimiter(generation_params[:max_context_tokens]) : "—" %>
              </div>
            </div>
            <div class="bg-base-200/50 rounded-lg p-3">
              <div class="text-xs text-base-content/50 mb-1"><%= t("settings.max_response_tokens", default: "Max Response") %></div>
              <div class="font-mono font-medium">
                <%= generation_params[:max_response_tokens].present? ? number_with_delimiter(generation_params[:max_response_tokens]) : "—" %>
              </div>
            </div>
          </div>
        </div>

        <%# Output Settings %>
        <div class="space-y-2">
          <h4 class="text-sm font-semibold flex items-center gap-2 text-base-content/80">
            <span class="icon-[lucide--radio] size-4"></span>
            <%= t("prompt_preview.output_settings", default: "Output Settings") %>
          </h4>
          <div class="bg-base-200/50 rounded-lg p-3">
            <div class="flex items-center justify-between">
              <span class="text-sm"><%= t("settings.streaming", default: "Streaming") %></span>
              <span class="badge <%= generation_params[:streaming] ? 'badge-success' : 'badge-ghost' %> badge-sm">
                <%= generation_params[:streaming] ? t("common.enabled", default: "Enabled") : t("common.disabled", default: "Disabled") %>
              </span>
            </div>
          </div>
        </div>

        <%# Raw JSON (collapsed by default) %>
        <details class="collapse collapse-arrow bg-base-200/30 rounded-lg">
          <summary class="collapse-title text-sm font-medium py-2 min-h-0">
            <span class="icon-[lucide--code-2] size-4 mr-2"></span>
            <%= t("prompt_preview.raw_json", default: "Raw JSON") %>
          </summary>
          <div class="collapse-content">
            <pre class="text-xs font-mono bg-base-300/50 p-3 rounded-lg overflow-x-auto"><%= JSON.pretty_generate(generation_params) %></pre>
          </div>
        </details>
      </div>
    </div>
  </div>
</div>
