{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "schema://settings/defs/space",
  "title": "Space Settings",
  "description": "Defaults that apply to a space (independent of any single conversation).",
  "type": "object",
  "additionalProperties": false,
  "default": {},
  "x-ui": {
    "tab": "Space",
    "icon": "message-square",
    "order": 2
  },
  "properties": {
    "reply_order_strategy": {
      "type": "string",
      "default": "natural",
      "enum": [
        "manual",
        "natural",
        "list",
        "pooled"
      ],
      "description": "Group chat reply order strategy (ST: Manual/Natural/List/Pooled).",
      "x-ui": {
        "control": "select",
        "label": "Reply Order Strategy",
        "order": 1,
        "quick": true
      },
      "x-storage": {
        "model": "Space",
        "attr": "reply_order",
        "kind": "column"
      }
    },
    "allow_self_responses": {
      "type": "boolean",
      "default": false,
      "description": "Allow consecutive replies from a character due to self-mentions (ST: Allow Self Responses).",
      "x-ui": {
        "control": "toggle",
        "label": "Allow Self Responses",
        "order": 2,
        "quick": true
      },
      "x-storage": {
        "model": "Space",
        "attr": "allow_self_responses",
        "kind": "column"
      }
    },
    "generation_handling_mode": {
      "type": "string",
      "default": "swap",
      "enum": [
        "swap",
        "join_include_muted",
        "join_exclude_muted"
      ],
      "description": "How character definitions are included in context for group chat generation. Join modes merge multiple character cards into one, which can blur personalities and confuse who is speaking.",
      "x-ui": {
        "control": "select",
        "label": "Group Generation Handling",
        "order": 3,
        "quick": true,
        "enumLabels": {
          "swap": "Swap",
          "join_include_muted": "Join (include muted)",
          "join_exclude_muted": "Join (exclude muted)"
        }
      },
      "x-storage": {
        "model": "Space",
        "attr": "card_handling_mode",
        "kind": "column",
        "mapping": {
          "swap": "swap",
          "join_include_muted": "append_disabled",
          "join_exclude_muted": "append"
        }
      }
    },
    "during_generation_user_input_policy": {
      "type": "string",
      "default": "queue",
      "enum": [
        "queue",
        "restart",
        "reject"
      ],
      "description": "What to do when a user sends messages while an AI response is generating.",
      "x-ui": {
        "control": "select",
        "label": "User Input While Generating",
        "order": 5,
        "quick": true,
        "enumLabels": {
          "queue": "Queue (donâ€™t interrupt)",
          "restart": "Restart (cancel + regenerate)",
          "reject": "Reject (block send)"
        }
      },
      "x-storage": {
        "model": "Space",
        "attr": "during_generation_user_input_policy",
        "kind": "column"
      }
    },
    "user_turn_debounce_ms": {
      "type": "integer",
      "default": 0,
      "minimum": 0,
      "maximum": 60000,
      "description": "Debounce window before starting a user-triggered generation run. Sending another user message resets the timer (ms).",
      "x-ui": {
        "control": "number",
        "label": "User Turn Debounce (ms)",
        "order": 6,
        "quick": false
      },
      "x-storage": {
        "model": "Space",
        "attr": "user_turn_debounce_ms",
        "kind": "column"
      }
    },
    "auto_mode_enabled": {
      "type": "boolean",
      "default": false,
      "description": "After an AI run succeeds, schedule an auto-mode followup run (AI-to-AI) using reply order strategy.",
      "x-ui": {
        "control": "toggle",
        "label": "Auto-mode Enabled",
        "order": 7,
        "quick": true
      },
      "x-storage": {
        "model": "Space",
        "attr": "auto_mode_enabled",
        "kind": "column"
      }
    },
    "auto_mode_delay_ms": {
      "type": "integer",
      "default": 5000,
      "minimum": 0,
      "maximum": 60000,
      "description": "Delay before an auto-mode followup run starts (ms).",
      "x-ui": {
        "control": "number",
        "label": "Auto-mode Delay (ms)",
        "order": 8,
        "quick": false,
        "visibleWhen": {
          "ref": "auto_mode_enabled",
          "const": true
        }
      },
      "x-storage": {
        "model": "Space",
        "attr": "auto_mode_delay_ms",
        "kind": "column"
      }
    },
    "join_prefix": {
      "type": "string",
      "default": "",
      "description": "Only used in Join modes. Supports normal macros, plus {{char}} for the current character and <FIELDNAME> for the current field. Join modes can blur personalities; use Swap if you see voice leakage.",
      "x-ui": {
        "control": "textarea",
        "label": "Join Prefix",
        "order": 10,
        "quick": false,
        "rows": 2,
        "visibleWhen": {
          "ref": "generation_handling_mode",
          "in": [
            "join_include_muted",
            "join_exclude_muted"
          ]
        }
      },
      "x-storage": {
        "model": "Space",
        "attr": "settings",
        "kind": "json",
        "path": [
          "join_prefix"
        ]
      }
    },
    "join_suffix": {
      "type": "string",
      "default": "",
      "description": "Only used in Join modes. Supports normal macros, plus {{char}} for the current character and <FIELDNAME> for the current field. Join modes can blur personalities; use Swap if you see voice leakage.",
      "x-ui": {
        "control": "textarea",
        "label": "Join Suffix",
        "order": 11,
        "quick": false,
        "rows": 2,
        "visibleWhen": {
          "ref": "generation_handling_mode",
          "in": [
            "join_include_muted",
            "join_exclude_muted"
          ]
        }
      },
      "x-storage": {
        "model": "Space",
        "attr": "settings",
        "kind": "json",
        "path": [
          "join_suffix"
        ]
      }
    },
    "scenario_override": {
      "type": [
        "string",
        "null"
      ],
      "default": null,
      "description": "Overrides scenario text for all group members (ST: Group Chat Scenario Override).",
      "x-ui": {
        "control": "textarea",
        "label": "Scenario Override",
        "order": 30,
        "quick": false,
        "rows": 3
      },
      "x-storage": {
        "model": "Space",
        "attr": "settings",
        "kind": "json",
        "path": [
          "scenario_override"
        ]
      }
    },
    "preset": {
      "$ref": "preset.schema.json",
      "x-ui": {
        "label": "Prompt Preset",
        "order": 35,
        "quick": false
      },
      "description": "Prompt Preset"
    },
    "world_info": {
      "$ref": "resources.schema.json#/$defs/WorldInfoSettings",
      "x-ui": {
        "label": "World Info",
        "order": 40,
        "quick": false
      },
      "description": "World Info"
    },
    "memory": {
      "$ref": "resources.schema.json#/$defs/MemorySettings",
      "x-ui": {
        "label": "Memory",
        "order": 50,
        "quick": false
      },
      "description": "Memory"
    },
    "rag": {
      "$ref": "resources.schema.json#/$defs/RagSettings",
      "x-ui": {
        "label": "RAG / Knowledge Base",
        "order": 60,
        "quick": false
      },
      "description": "RAG / Knowledge Base"
    }
  }
}
