# TavernKit Development Rules

## Quick Reference

**Primary Documentation**: See `AGENT.md` for complete AI assistant guidelines.

## ⚠️ Critical Rules

### 1. No Backward Compatibility (Pre-1.0)

- **Breaking changes are allowed** — Do not add compatibility shims
- **No deprecation warnings** — Remove old code directly
- **Refactor freely** — The API is not stable yet

### 2. File Formatting

- **All files must end with exactly ONE newline** (no trailing blank lines)
- Run `ruby bin/lint-eof --fix` before finishing

### 3. No Warnings in Tests

- Code must produce zero warnings when running `bundle exec rake test`

## Playground (Rails App) Quick Rules

### Namespaced Controllers (Required Pattern)

When creating controllers under a namespace (e.g., `Playgrounds`, `Conversations`, `Settings`):

1. Create a namespace `ApplicationController` if it doesn't exist
2. Inherit from the namespace `ApplicationController`, not the global one

```ruby
# ✅ Correct
class Playgrounds::PromptPreviewsController < Playgrounds::ApplicationController
end

# ❌ Wrong - bypasses namespace authorization
class Playgrounds::PromptPreviewsController < ApplicationController
end
```

### Async I/O (Mandatory)

All LLM API calls MUST run in `ActiveJob`, not in controllers or models:

- `ConversationRunJob` — AI message generation
- `CopilotCandidateJob` — Copilot suggestions

**Exception**: "Test Connection" button can call LLM directly.

### Real-time Communication

Use separated channels for different concerns:

- `ConversationChannel` (JSON): typing_start/typing_stop, stream_chunk, stream_complete
- `CopilotChannel` (JSON): copilot_candidate, copilot_complete, copilot_error
- `Turbo::StreamsChannel` (DOM): broadcast_append, broadcast_update, broadcast_remove

**Key Pattern**: Stream content to typing indicator, create message atomically after completion.

### Run-Driven Scheduling

AI generation uses `ConversationRun` state machine: `queued` → `running` → `succeeded`/`failed`/`canceled`/`skipped`

- `Conversations::RunPlanner` — Creates/updates queued runs
- `Conversations::RunExecutor` — Claims and executes runs
- Max 1 running + max 1 queued per conversation (enforced by partial unique indexes)

## Key Documentation

| File | Purpose |
|------|---------|
| `AGENT.md` | Complete AI assistant guidelines |
| `ARCHITECTURE.md` | Internal design, module responsibilities |
| `docs/playground/PLAYGROUND_ARCHITECTURE.md` | Playground architecture overview |
| `docs/playground/CONVERSATION_AUTO_RESPONSE.md` | Auto-response scheduling details |
